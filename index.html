<!DOCTYPE html>
<!--
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                              â•‘
â•‘                    SPOTIFY STREAMING HISTORY ANALYZER                        â•‘
â•‘                     Dark Nature Theme - Mobile Friendly                      â•‘
â•‘                                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DESCRIPTION:
============
A comprehensive, single-file web application for analyzing Spotify streaming 
history with beautiful visualizations, detailed statistics, and interactive charts.

FEATURES:

COMPLETE FEATURE LIST:
======================

ğŸ“Š CORE SECTIONS (7):
   1. Overview - Main statistics dashboard with key metrics
   2. Songs - Top tracks, play counts, and song analysis  
   3. Artists - Artist rankings, loyalty metrics, and statistics
   4. Genres - Genre breakdown, trends, and time-of-day patterns
   5. Charts - Interactive visualizations (hourly, weekly, timeline)
   6. Habits - Listening patterns and behavior analysis
   7. Discovery - New music exploration and diversity metrics

ğŸ¨ THEMES (5):
   â€¢ Dark Nature (default) - Forest greens and earthy tones
   â€¢ Ocean - Blue aquatic color scheme
   â€¢ Sunset - Warm oranges and purples
   â€¢ Space - Dark cosmic theme with star effects
   â€¢ Neon - Bright cyberpunk style

ğŸ“ˆ CHARTS & VISUALIZATIONS (15+):
   â€¢ Timeline Chart - Monthly listening trends
   â€¢ Hourly Pattern - 24-hour activity heatmap
   â€¢ Weekly Pattern - Day-of-week distribution
   â€¢ Top Tracks Bar Chart - Horizontal bars for top songs
   â€¢ Top Artists Bar Chart - Artist play counts
   â€¢ Tracks Pie Chart - Song distribution visualization
   â€¢ Artists Pie Chart - Artist proportion breakdown
   â€¢ Genre Doughnut - Genre distribution (5 chart types)
   â€¢ Genre Trends - Time-series genre evolution
   â€¢ Genre Time-of-Day - Hourly genre preferences
   â€¢ Time of Day Chart - Listening by hour
   â€¢ Seasonal Chart - Quarterly breakdown
   â€¢ Weekday/Weekend - Comparison analysis
   â€¢ Discovery Timeline - New music over time
   â€¢ Repeat vs Explore - Listening behavior split

ğŸ” ANALYTICS & INSIGHTS (20+):
   â€¢ Total streams and listening hours
   â€¢ Unique songs and artists count
   â€¢ Top artist and top song
   â€¢ Average daily streams
   â€¢ Peak listening hour and day
   â€¢ Skip behavior analysis (skip rate, quick skips)
   â€¢ Listening streaks calculation
   â€¢ Binge session detection
   â€¢ Artist loyalty scoring
   â€¢ Genre diversity index
   â€¢ Morning/Afternoon/Evening/Night percentages
   â€¢ Weekday vs Weekend listening
   â€¢ Seasonal preferences
   â€¢ Discovery rate and new artists per month
   â€¢ Repeat percentage
   â€¢ One-hit wonders identification
   â€¢ Forgotten gems finder
   â€¢ Deep cuts discovery
   â€¢ Monthly breakdown analytics
   â€¢ Decade analysis

ğŸ› ï¸ INTERACTIVE TOOLS (10+):
   â€¢ Quick Search - Find songs/artists instantly
   â€¢ Date Range Filters - Custom time period analysis
   â€¢ Time Travel - View stats from specific periods
   â€¢ Random Song Discovery - Rediscover forgotten tracks
   â€¢ Random Artist - Explore your library
   â€¢ Forgotten Gems - Find rarely played favorites
   â€¢ Deep Cuts - Discover hidden tracks
   â€¢ Export Playlists - Create Spotify playlists
   â€¢ Export Statistics - Save your data
   â€¢ Share Cards - Generate shareable images
   â€¢ Heat Map Calendar - Daily listening visualization

âš™ï¸ FILTERING & SORTING (Multiple options):
   â€¢ Sort by: Play Count, Time Listened, Unique Tracks, First/Last Played
   â€¢ Filter by: Year, Genre, Date Range, Time Period
   â€¢ Genre Filter Modal - Multi-select genre filtering
   â€¢ Chart Type Selection - 5 different visualization types
   â€¢ Top N Limits - Show top 5/10/15/20/50 items

ğŸ“± MOBILE FEATURES:
   â€¢ Fully responsive design for all screen sizes
   â€¢ Touch-friendly controls and gestures
   â€¢ Folder upload support (desktop browsers)
   â€¢ ZIP file upload with automatic extraction
   â€¢ Android-specific tips and guidance
   â€¢ Landscape mode optimizations
   â€¢ Collapsible sections for mobile

ğŸ’¾ FILE HANDLING:
   â€¢ Drag & drop JSON files
   â€¢ Multiple file selection
   â€¢ Folder upload (webkitdirectory)
   â€¢ ZIP file upload with extraction (using JSZip)
   â€¢ Progress tracking with percentage
   â€¢ File list display with sizes
   â€¢ Automatic JSON parsing and validation

ğŸ¯ SPECIAL FEATURES:
   â€¢ Theme persistence (localStorage)
   â€¢ Cached analysis for performance
   â€¢ Animated counters and transitions
   â€¢ Lazy loading for charts
   â€¢ Smooth scrolling navigation
   â€¢ Keyboard shortcuts
   â€¢ Print-friendly layouts
   â€¢ Custom tooltips
   â€¢ Error handling with user-friendly messages

ğŸ“Š DATA PROCESSING:
   â€¢ Minimum play time filtering (30 seconds)
   â€¢ Genre categorization (50+ genres)
   â€¢ Decade classification
   â€¢ Time-based aggregation
   â€¢ Statistical calculations
   â€¢ Trend analysis algorithms
   â€¢ Pattern recognition

TOTAL FEATURE COUNT: 100+ distinct features and capabilities

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
=========
âœ… File Upload & Processing
   - Drag & drop multiple JSON files
   - Automatic data parsing and validation
   - Progress tracking with visual feedback

âœ… Comprehensive Statistics
   - Total streams, unique songs/artists, listening hours
   - Top songs, artists, and genres
   - Listening habits (time of day, day of week)
   - Discovery metrics and trends
   - Decade analysis and music eras

âœ… Interactive Visualizations
   - Timeline charts showing listening over time
   - Hourly and weekly activity patterns
   - Top tracks and artists bar charts
   - Genre distribution (pie, doughnut, bar charts)
   - Customizable chart types and filters

âœ… Advanced Analytics
   - Skip behavior analysis
   - Listening streaks and binge sessions
   - Artist loyalty metrics
   - Discovery timeline
   - Genre diversity scoring
   - Decade preferences

âœ… User Tools
   - Quick find (search by various criteria)
   - Time travel (view stats by time period)
   - Random discoveries
   - Export playlists and statistics
   - Share music stats

âœ… Mobile Responsive Design
   - Fully responsive layout for all screen sizes
   - Touch-friendly controls
   - Optimized for mobile, tablet, and desktop
   - Landscape mode support

TECHNICAL DETAILS:
==================
- Pure HTML/CSS/JavaScript (no build process needed)
- Chart.js for data visualization
- Dark nature color scheme (sage greens, forest tones)
- Lazy loading for performance optimization
- Local storage support for persistent preferences
- Progressive web app ready

FILE STRUCTURE:
===============
1. HTML (Lines 1-2200)
   - Head section with meta tags and styles
   - Upload interface
   - Results dashboard with tabs
   - All UI components

2. CSS (Lines 8-1200)
   - Base styles and theme colors
   - Component styles
   - Layout and grid systems
   - Mobile responsive media queries

3. JavaScript (Lines 2200-6400)
   - Global variables and state management
   - File handling and data processing
   - Analysis engine
   - UI update functions
   - Chart creation and management
   - Event handlers

COLOR SCHEME (Dark Nature Theme):
==================================
- Background: Deep Forest (#1a2421, #0f1612)
- Primary: Sage Green (#88a980, #a8c9a0)
- Secondary: Moss Green (#6a8763, #5a7153)
- Text: Pale Mint (#c4d4c8)
- Accents: Muted Green (#8a9d87)

BROWSER COMPATIBILITY:
======================
- Chrome/Edge: âœ… Full support
- Firefox: âœ… Full support
- Safari: âœ… Full support
- Mobile browsers: âœ… Optimized

VERSION HISTORY:
================
v2.0 - December 2024
  - Added mobile-friendly responsive design
  - Implemented dark nature theme
  - Enhanced chart filtering options
  - Added comprehensive documentation
  - Performance optimizations with lazy loading

v1.0 - Initial Release
  - Basic streaming analysis
  - Chart visualizations
  - Statistics dashboard

USAGE:
======
1. Download your Spotify streaming history from Spotify.com
2. Open this HTML file in a web browser
3. Drag & drop your JSON files or click to browse
4. Click "Analyze My Music Data"
5. Explore your listening statistics and insights!

CREDITS:
========
Created with Claude (Anthropic)
Chart.js library for visualizations
Inspired by the beauty of nature ğŸŒ¿

LICENSE:
========
Free to use and modify for personal use

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
        
    <!-- PWA Meta Tags for Android App -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Spotify Analyzer">
    <meta name="theme-color" content="#1a2421">
    <meta name="description" content="Analyze your Spotify streaming history with beautiful visualizations">
    
    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>ğŸµ</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>ğŸµ</text></svg>">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Streaming Analyzer - Enhanced</title>
    
    <!-- Chart.js Library for data visualization -->
        
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
        
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    
    <style>
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CSS STYLES - ALL THEMES AND COMPONENTS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•*/

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CONTRAST IMPROVEMENTS - Better Text Visibility
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•*/

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           ADDITIONAL CONTRAST FIXES - Specific Problem Areas
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        
        /* Fix top songs/artists lists - main issue area */
        ul.artist-list li .artist-name,
        ul.song-list li .song-name,
        .artist-list .name,
        .song-list .name {
            color: #e8f4e8 !important;
            font-weight: 600 !important;
        }
        
        ul.artist-list li .stats,
        ul.song-list li .stats,
        ul.artist-list li span:not(.artist-name),
        ul.song-list li span:not(.song-name) {
            color: #c8e8c8 !important;
        }
        
        /* Fix play counts and statistics in lists */
        .play-count-value,
        .time-value,
        .count-value {
            color: var(--color-accent) !important;
            font-weight: 600 !important;
        }
        
        /* Fix any remaining dark-on-dark text */
        .section p,
        .subsection p,
        .results-section p {
            color: #b8d4b8 !important;
        }
        
        /* Improve all span elements in lists */
        ul li span {
            color: #b8d4b8 !important;
        }
        
        ul li span.primary,
        ul li .primary-text {
            color: #e8f4e8 !important;
        }
        
        /* Fix filter section text */
        .filters,
        .filters * {
            color: #b8d4b8 !important;
        }
        
        .filters label {
            color: #c8e8c8 !important;
            font-weight: 500;
        }
        
        /* Fix any div text content */
        .content,
        .text-content,
        div.text {
            color: var(--text-primary) !important;
        }
        
        /* Improve chart section headers */
        .chart-container h2,
        .chart-container h3,
        .results-section h2,
        .results-section h3 {
            color: var(--color-accent) !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        /* Fix insight cards values */
        .insight-card .value,
        .stat-card .value {
            color: #d8f8d8 !important;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }
        
        /* Improve generic paragraph text */
        p, span, div {
            color: inherit;
        }
        
        /* Set a better base text color for all content */
        .section,
        .subsection,
        .results-section,
        .chart-container {
            color: #c8e8c8;
        }
        
        /* Fix numbered lists and rank displays */
        ol li,
        .rank-number,
        .position {
            color: #e8f4e8 !important;
        }
        
        /* Improve tooltip and hint text */
        .tooltip,
        .hint,
        .info-text {
            color: #d8f8d8 !important;
            background: rgba(0, 0, 0, 0.8) !important;
        }

        
        /* Improve text visibility in all lists */
        .artist-list li,
        .song-list li,
        ul li {
            color: var(--text-primary) !important;
        }
        
        .artist-list .artist-name,
        .song-list .song-name,
        .list-item .list-title {
            color: #e8f4e8 !important;
            font-weight: 600;
        }
        
        .artist-list .stats,
        .song-list .stats,
        .list-item .list-subtitle {
            color: #b8d4b8 !important;
        }
        
        /* Improve subtitle and secondary text */
        .subtitle,
        .secondary-text,
        p {
            color: #a8c9a8 !important;
        }
        
        /* Ensure rank numbers are visible */
        .rank,
        .number,
        .list-rank {
            color: var(--color-accent) !important;
            font-weight: 700;
        }
        
        /* Improve value displays */
        .value,
        .stat-value,
        .insight-card .value {
            color: #c8e8c8 !important;
        }
        
        /* Fix filter and dropdown labels */
        label,
        .filter-group label {
            color: #b8d4b8 !important;
        }
        
        /* Improve heading visibility */
        h2, h3, h4 {
            color: var(--color-accent) !important;
        }
        
        /* Fix play count and time displays */
        .play-count,
        .time-display,
        .duration {
            color: #b8d4b8 !important;
        }
        
        /* Improve insight card text */
        .insight-card h4 {
            color: #c8e8c8 !important;
        }
        
        .insight-card p {
            color: #a8c9a8 !important;
        }



        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           QUICK NAVIGATION - CSS SECTIONS
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           
           1. CSS Variables & Themes (Lines ~170-450)
           2. Base Styles & Reset (Lines ~450-550)
           3. Typography (Lines ~550-650)
           4. Layout & Container (Lines ~650-750)
           5. Navigation & Tabs (Lines ~750-850)
           6. Upload Section (Lines ~850-950)
           7. Stats Cards & Grid (Lines ~950-1100)
           8. Chart Container (Lines ~1100-1250)
           9. Buttons & Controls (Lines ~1250-1350)
           10. Lists & Tables (Lines ~1350-1500)
           11. Filters & Dropdowns (Lines ~1500-1600)
           12. Modal & Overlays (Lines ~1600-1700)
           13. Progress & Loading (Lines ~1700-1800)
           14. Mobile Responsive (Lines ~1800-1900)
           
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/



        /* ============================================================
           SPOTIFY STREAMING ANALYZER - DARK NATURE THEME
           ============================================================
           
           A comprehensive music streaming analytics tool with:
           - Beautiful dark nature-inspired color scheme
           - Fully responsive mobile-first design
           - Interactive charts and visualizations
           - Detailed listening statistics and insights
           
           Author: Created with Claude
           Version: 2.0 - Mobile Friendly
           Last Updated: December 2024
           ============================================================ */
        
        /* ============================================================
           1. BASE STYLES & RESET
           ============================================================ */
        /* ============================================================
           1. BASE STYLES & RESET
           ============================================================ */
        

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CRITICAL CONTRAST FIXES - Light Cards
           Fix light text on light backgrounds
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•*/
        

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           DARK SECTION FIXES - Lists and Discovery Areas
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        
        /* Fix Recently Discovered Artists section */
        .artist-list,
        .song-list,
        .discovery-list {
            background: rgba(30, 40, 35, 0.6) !important;
            padding: 20px;
            border-radius: 12px;
        }
        
        .artist-list li,
        .song-list li,
        .discovery-list li {
            background: rgba(40, 50, 45, 0.8) !important;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            color: #e8f4e8 !important;
        }
        
        .artist-list li:hover,
        .song-list li:hover,
        .discovery-list li:hover {
            background: rgba(50, 60, 55, 0.9) !important;
            border-color: var(--color-primary);
        }
        
        /* Make artist/song names very visible */
        .artist-list li .artist-name,
        .artist-list li strong,
        .artist-list li b,
        .song-list li .song-name,
        .song-list li strong,
        .song-list li b {
            color: #ffffff !important;
            font-weight: 700 !important;
            font-size: 1.1em;
        }
        
        /* Make all text in lists readable */
        .artist-list li *,
        .song-list li *,
        .discovery-list li * {
            color: #c8e8c8 !important;
        }
        
        /* Fix rank/number displays in lists */
        .artist-list li .rank,
        .song-list li .rank,
        .artist-list .number,
        .song-list .number {
            color: var(--color-accent) !important;
            font-weight: 700;
            font-size: 1.2em;
        }
        
        /* Fix metadata text (plays, dates, etc) */
        .artist-list li .stats,
        .artist-list li .meta,
        .artist-list li .info,
        .song-list li .stats,
        .song-list li .meta,
        .song-list li .info {
            color: #b8d4b8 !important;
            font-size: 0.95em;
        }
        
        /* Fix any spans in lists */
        .artist-list li span,
        .song-list li span {
            color: #c8e8c8 !important;
        }
        
        /* Make emoji/icons stand out */
        .artist-list li .emoji,
        .song-list li .emoji,
        .artist-list li .icon,
        .song-list li .icon {
            opacity: 1 !important;
            filter: none !important;
        }
        
        /* Fix section headers above lists */
        .results-section h2,
        .results-section h3 {
            color: var(--color-accent) !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }
        
        /* Fix "NEW" badges and labels */
        .badge,
        .label-badge,
        .tag {
            background: var(--color-primary) !important;
            color: white !important;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85em;
        }
        
        /* Fix any ordered/numbered lists */
        ol li,
        ol li * {
            color: #e8f4e8 !important;
        }
        
        ol li strong,
        ol li b {
            color: #ffffff !important;
        }
        
        /* Fix unordered lists */
        ul li {
            color: #e8f4e8 !important;
        }
        
        /* Ensure list markers are visible */
        ul li::marker,
        ol li::marker {
            color: var(--color-accent) !important;
        }

        /* Fix insight cards - these have light backgrounds */
        .insight-card {
            background: rgba(30, 40, 35, 0.8) !important;
            color: #e8f4e8 !important;
        }
        
        .insight-card h4 {
            color: var(--color-accent) !important;
            font-weight: 600;
        }
        
        .insight-card .value {
            color: #ffffff !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            font-weight: 700;
        }
        
        .insight-card p {
            color: #c8e8c8 !important;
        }
        
        /* Fix stat cards */
        .stat-card {
            background: rgba(30, 40, 35, 0.8) !important;
            color: #e8f4e8 !important;
        }
        
        .stat-card h4 {
            color: var(--color-accent) !important;
        }
        
        .stat-card .value {
            color: #ffffff !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .stat-card .label {
            color: #b8d4b8 !important;
        }
        
        .stat-card p {
            color: #c8e8c8 !important;
        }
        
        /* Fix all cards with light backgrounds */
        .card,
        .info-card,
        .metric-card {
            background: rgba(30, 40, 35, 0.8) !important;
            color: #e8f4e8 !important;
        }
        
        /* Ensure all card headers are visible */
        .card h3,
        .card h4,
        .info-card h3,
        .info-card h4,
        .metric-card h3,
        .metric-card h4 {
            color: var(--color-accent) !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        /* Fix labels in cards */
        .card .label,
        .info-card .label,
        .metric-card .label,
        .stat-label,
        .metric-label {
            color: #b8d4b8 !important;
            font-weight: 500;
        }
        
        /* Fix any subtitle or description in cards */
        .card .subtitle,
        .card .description,
        .info-card .subtitle,
        .info-card .description {
            color: #b8d4b8 !important;
        }
        
        /* Fix insights grid specifically */
        .insights-grid .insight-card {
            background: rgba(30, 40, 35, 0.9) !important;
            border: 1px solid var(--border-color);
        }
        
        .insights-grid .insight-card:hover {
            background: rgba(40, 50, 45, 0.95) !important;
            border-color: var(--color-primary);
        }
        
        /* Fix stats grid */
        .stats-grid .stat-card {
            background: rgba(30, 40, 35, 0.9) !important;
            border: 1px solid var(--border-color);
        }
        
        .stats-grid .stat-card:hover {
            background: rgba(40, 50, 45, 0.95) !important;
        }
        
        /* Make sure all values in any card are bright white */
        .value,
        .stat-value,
        .metric-value,
        .count-value,
        [class*="value"] {
            color: #ffffff !important;
            font-weight: 700 !important;
        }
        
        /* Fix percentage displays */
        .percentage,
        .percent,
        [class*="percent"] {
            color: var(--color-accent) !important;
            font-weight: 700;
        }


        :root {
            /* Theme Colors - Default: Dark Nature */
            --bg-primary: #1a2421;
            --bg-secondary: #0f1612;
            --bg-card: rgba(30, 40, 35, 0.6);
            --bg-card-hover: rgba(30, 40, 35, 0.8);
            
            --color-primary: #88a980;
            --color-secondary: #6a8763;
            --color-accent: #a8c9a0;
            --color-highlight: #5a7153;
            
            --text-primary: #e8f4e8;
            --text-secondary: #b8d4b8;
            --text-muted: #9ab89a;
            
            --border-color: rgba(106, 135, 99, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.3);
            
            --gradient-start: #88a980;
            --gradient-end: #6a8763;
        }
        
        /* Ocean Theme */
        [data-theme="ocean"] {
            --bg-primary: #0a1828;
            --bg-secondary: #051015;
            --bg-card: rgba(13, 27, 42, 0.6);
            --bg-card-hover: rgba(13, 27, 42, 0.8);
            
            --color-primary: #4a90a4;
            --color-secondary: #2e5266;
            --color-accent: #6bb6c0;
            --color-highlight: #1c3a4a;
            
            --text-primary: #b8d4e8;
            --text-secondary: #7a9fb0;
            --text-muted: #5a7f90;
            
            --border-color: rgba(74, 144, 164, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.4);
            
            --gradient-start: #4a90a4;
            --gradient-end: #2e5266;
        }
        
        /* Sunset Theme */
        [data-theme="sunset"] {
            --bg-primary: #2b1a1a;
            --bg-secondary: #1a0f0f;
            --bg-card: rgba(51, 26, 26, 0.6);
            --bg-card-hover: rgba(51, 26, 26, 0.8);
            
            --color-primary: #e07856;
            --color-secondary: #c85a3a;
            --color-accent: #f09870;
            --color-highlight: #a04830;
            
            --text-primary: #f5d7c8;
            --text-secondary: #d4a894;
            --text-muted: #b88870;
            
            --border-color: rgba(224, 120, 86, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.4);
            
            --gradient-start: #e07856;
            --gradient-end: #c85a3a;
        }
        
        /* Space Theme */
        [data-theme="space"] {
            --bg-primary: #0d0221;
            --bg-secondary: #050010;
            --bg-card: rgba(26, 13, 50, 0.6);
            --bg-card-hover: rgba(26, 13, 50, 0.8);
            
            --color-primary: #8b5cf6;
            --color-secondary: #6d28d9;
            --color-accent: #a78bfa;
            --color-highlight: #5b21b6;
            
            --text-primary: #e9d5ff;
            --text-secondary: #c4b5fd;
            --text-muted: #a78bfa;
            
            --border-color: rgba(139, 92, 246, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.5);
            
            --gradient-start: #8b5cf6;
            --gradient-end: #6d28d9;
        }
        
        /* Neon Theme */
        [data-theme="neon"] {
            --bg-primary: #0f0f23;
            --bg-secondary: #05050f;
            --bg-card: rgba(20, 20, 40, 0.6);
            --bg-card-hover: rgba(20, 20, 40, 0.8);
            
            --color-primary: #00f5ff;
            --color-secondary: #00b8d4;
            --color-accent: #39ffed;
            --color-highlight: #0097a7;
            
            --text-primary: #e0ffff;
            --text-secondary: #b0e0e6;
            --text-muted: #80cfd6;
            
            --border-color: rgba(0, 245, 255, 0.3);
            --shadow-color: rgba(0, 245, 255, 0.2);
            
            --gradient-start: #00f5ff;
            --gradient-end: #00b8d4;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            /* Use CSS variables for theming */
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(to bottom, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 40px 20px;
            color: var(--text-primary);
            position: relative;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* Subtle organic background pattern overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 30%, var(--color-primary) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, var(--color-secondary) 0%, transparent 50%);
            opacity: 0.08;
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        /* ============================================================
           2. HEADER SECTION
           ============================================================ */

        /* ============================================================
           2. HEADER SECTION
           ============================================================ */
        
        .header {
            text-align: center;
            margin-bottom: 60px;
            animation: fadeInDown 0.8s ease;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 12px;
            font-weight: 300; /* Light weight for elegant look */
            color: var(--color-accent);
            letter-spacing: -0.5px;
        }
        
        /* Leaf emoji prefix */
        .header h1::before {
            content: 'ğŸŒ¿ ';
            font-size: 0.8em;
        }

        .header p {
            font-size: 1.1em;
            color: var(--text-secondary);
            font-weight: 300;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        /* Theme Selector */
        .theme-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--bg-card);
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 20px var(--shadow-color);
        }
        
        .theme-selector label {
            font-size: 0.9em;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .theme-selector select {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .theme-selector select:hover {
            border-color: var(--color-primary);
        }
        
        .theme-selector select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(var(--color-primary), 0.1);
        }
        
        /* ============================================================
           READABILITY IMPROVEMENTS
           ============================================================ */
        
        /* Make all text more readable */
        body {
            font-size: 16px; /* Increased base font size */
            line-height: 1.6;
        }
        
        /* Stat card values - make much bigger and bolder */
        .stat-card h3 {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
        }
        
        .stat-card .value {
            font-size: 3em; /* Larger numbers */
            font-weight: 700; /* Bolder */
            color: var(--color-accent);
            margin: 15px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        /* Insight card values */
        .insight-card h4 {
            font-size: 1em;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .insight-card .value {
            font-size: 2em; /* Larger */
            font-weight: 700;
            color: var(--color-primary);
            margin: 12px 0;
        }
        
        .insight-card p {
            font-size: 0.95em;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        /* Section headings - make larger */
        h2 {
            font-size: 2em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 25px;
        }
        
        h3 {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Better text contrast */
        p, label, span {
            color: var(--text-primary);
        }
        
        /* Chart labels - bigger */
        .chart-wrapper canvas {
            font-size: 14px;
        }
        
        /* Button text - larger and bolder */
        button {
            font-size: 1.1em;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        
        /* Navigation buttons */
        .nav-btn {
            font-size: 1em;
            font-weight: 500;
        }
        
        /* Table text - increase size */
        table {
            font-size: 1.05em;
        }
        
        /* List items - more readable */
        .results-list li {
            font-size: 1.05em;
            line-height: 1.8;
            padding: 12px 0;
        }
        
        /* ============================================================
           3. UPLOAD SECTION
           ============================================================ */

        .upload-section {
            background: rgba(30, 40, 35, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(106, 135, 99, 0.2);
            animation: fadeInUp 0.8s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-input-wrapper {
            border: 2px dashed rgba(106, 135, 99, 0.4);
            border-radius: 16px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(15, 22, 18, 0.4);
            position: relative;
            z-index: 10;
            /* Ensure touch events work on mobile */
            -webkit-tap-highlight-color: rgba(136, 169, 128, 0.2);
            touch-action: manipulation;
        }

        .file-input-wrapper:hover {
            background: rgba(90, 113, 83, 0.15);
            border-color: #6a8763;
            transform: translateY(-2px);
        }
        
        .file-input-wrapper:active {
            background: rgba(90, 113, 83, 0.25);
            transform: translateY(0);
        }

        .file-input-wrapper.dragover {
            background: rgba(106, 135, 99, 0.25);
            border-color: #88a980;
            border-style: solid;
        }

        input[type="file"] {
            /* Keep accessible but invisible for screen readers and mobile */
            position: absolute;
            opacity: 0;
            width: 0.1px;
            height: 0.1px;
            z-index: -1;
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
            pointer-events: none; /* Let clicks pass through to wrapper */
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        button {
            background: linear-gradient(135deg, #6a8763 0%, #5a7153 100%);
            color: #e8f0e6;
            border: none;
            padding: 16px 40px;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            box-shadow: 0 2px 12px rgba(90, 113, 83, 0.3);
            letter-spacing: 0.3px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(106, 135, 99, 0.4);
            background: linear-gradient(135deg, #88a980 0%, #6a8763 100%);
        }
        
        button:active {
            transform: translateY(0px);
            box-shadow: 0 2px 8px rgba(90, 113, 83, 0.25);
        }
        
        button.clicked {
            animation: buttonClick 0.4s ease;
        }
        
        @keyframes buttonClick {
            0% { transform: scale(1); }
            50% { transform: scale(0.96); }
            100% { transform: scale(1); }
        }

        button:disabled {
            background: #2a3a30;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.4;
            color: #5a6a5a;
        }

        .results {
            display: none;
            animation: fadeIn 0.8s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(30, 40, 35, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(106, 135, 99, 0.2);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease backwards;
        }
        
        /* Stagger animation for each card */
        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }
        .stat-card:nth-child(5) { animation-delay: 0.5s; }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Removed spinning shimmer line - user didn't like it */
        
        /* Floating glow effect */
        .stat-card::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(136, 169, 128, 0.15) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            animation: pulse 3s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.5;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.5);
                opacity: 0.8;
            }
        }


        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 35px rgba(106, 135, 99, 0.4);
            border-color: var(--color-primary);
        }
        
        /* Animate the value numbers */
        .stat-card .value {
            animation: scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
            animation-delay: 0.3s;
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .date-slider-container {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
        }

        .date-slider-group {
            margin: 25px 0;
        }

        .date-slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }

        .date-display {
            font-size: 0.95em;
            color: #667eea;
            background: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .dual-slider-wrapper {
            position: relative;
            height: 40px;
            margin: 10px 0;
        }

        .slider-track {
            position: absolute;
            top: 18px;
            left: 0;
            right: 0;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
        }

        .slider-range {
            position: absolute;
            top: 18px;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
        }

        .date-range-slider {
            position: absolute;
            width: 100%;
            height: 4px;
            top: 18px;
            appearance: none;
            background: transparent;
            pointer-events: none;
        }

        .date-range-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #667eea;
            cursor: pointer;
            pointer-events: all;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }

        .date-range-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            border-color: #764ba2;
        }

        .date-range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #667eea;
            cursor: pointer;
            pointer-events: all;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.2s;
        }

        .date-range-slider::-moz-range-thumb:hover {
            transform: scale(1.2);
            border-color: #764ba2;
        }

        .period-divider {
            text-align: center;
            margin: 30px 0;
            font-size: 1.5em;
            color: #764ba2;
            font-weight: bold;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        .stat-card h3 {
            color: #8a9d87;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .stat-card .value {
            font-size: 2.8em;
            font-weight: 800;
            background: linear-gradient(135deg, #88a980, #a8c9a0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .results-section, .chart-container {
            background: rgba(30, 40, 35, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(106, 135, 99, 0.2);
        }

        .results-section h2, .chart-container h2 {
            color: #a8c9a0;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(106, 135, 99, 0.3);
            font-size: 1.8em;
            font-weight: 600;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .song-list, .artist-list {
            list-style: none;
        }

        .song-item, .artist-item {
            padding: 18px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .song-item:hover, .artist-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .rank {
            display: inline-block;
            width: 35px;
            height: 35px;
            line-height: 35px;
            text-align: center;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            font-size: 0.9em;
        }

        .song-name {
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
            font-size: 1.05em;
        }

        .artist-name {
            color: var(--text-primary);
            font-size: 0.95em;
            font-weight: 500;
        }

        .stats {
            color: #999;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
            animation: fadeIn 0.3s ease;
        }
        
        .loading p {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #a8c9a0;
            font-size: 1.1em;
            animation: fadeIn 0.3s ease;
        }
        
        .loading p {
            font-weight: 400;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .spinner {
            border: 4px solid rgba(106, 135, 99, 0.2);
            border-top: 4px solid #6a8763;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-container {
            width: 80%;
            max-width: 500px;
            height: 6px;
            background: rgba(30, 40, 35, 0.6);
            border-radius: 10px;
            margin: 30px auto 20px;
            overflow: hidden;
            border: 1px solid rgba(106, 135, 99, 0.2);
        }
        
        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #6a8763, #88a980);
            border-radius: 10px;
            transition: width 0.4s ease;
        }
        
        .progress-percentage {
            color: #a8c9a0;
            font-size: 1.4em;
            font-weight: 500;
            margin-top: 15px;
        }

        .file-list {
            margin-top: 20px;
            font-size: 0.95em;
            color: var(--text-primary);
        }

        .file-list-item {
            padding: 8px 0;
            color: #667eea;
            font-weight: 600;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 0.85em;
            color: var(--text-primary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select {
            padding: 12px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        select:hover, select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 3px solid rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .tab {
            padding: 14px 28px;
            background: transparent;
            border: none;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 700;
            color: var(--text-primary);
            transition: all 0.3s ease;
            margin: 0;
            position: relative;
            white-space: nowrap;
        }

        .tab::after {
            content: '';
            position: absolute;
            bottom: -13px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tab.active::after {
            transform: scaleX(1);
        }

        .tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2, #667eea);
        }

        .upload-section h3 {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-section p {
            color: var(--text-primary);
            font-size: 1em;
        }

        /* Navigation Menu Styles */
        .nav-menu {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9));
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: none;
        }

        .nav-menu.visible {
            display: block;
            animation: fadeInUp 0.8s ease;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-btn {
            background: rgba(30, 40, 35, 0.4);
            color: #a8c9a0;
            border: 1px solid rgba(106, 135, 99, 0.4);
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0;
            position: relative;
            overflow: hidden;
        }

        .nav-btn:hover {
            background: rgba(106, 135, 99, 0.3);
            color: #c4d4c8;
            border-color: #88a980;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(90, 113, 83, 0.3);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #6a8763, #5a7153);
            color: #e8f0e6;
            border-color: #88a980;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .subsection {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9));
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .subsection h3 {
            color: #a8c9a0;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(106, 135, 99, 0.3);
            font-size: 1.5em;
            font-weight: 600;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .insight-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
        }

        .insight-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .insight-card h4 {
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .insight-card .value {
            font-size: 2em;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 10px 0;
        }

        .insight-card p {
            color: var(--text-primary);
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        /* ========================================
           NEW FEATURES STYLES
           ======================================== */
        
        /* Achievement Cards */
        .achievement-card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 16px;
            border: 2px solid var(--border-color);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .achievement-card.unlocked {
            border-color: var(--color-primary);
            box-shadow: 0 0 30px rgba(136, 169, 128, 0.3);
            animation: unlockPulse 2s ease infinite;
        }
        
        @keyframes unlockPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(136, 169, 128, 0.2); }
            50% { box-shadow: 0 0 40px rgba(136, 169, 128, 0.4); }
        }
        
        .achievement-card.locked {
            opacity: 0.6;
            filter: grayscale(0.8);
        }
        
        .achievement-icon {
            font-size: 3.5em;
            margin-bottom: 15px;
            display: block;
        }
        
        .achievement-progress {
            width: 100%;
            height: 10px;
            background: var(--bg-primary);
            border-radius: 5px;
            margin-top: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .achievement-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
            transition: width 0.8s ease;
            border-radius: 5px;
        }
        
        /* Heat Map Calendar */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(53, 16px);
            gap: 4px;
            margin: 30px 0;
            padding: 10px;
            background: var(--bg-card);
            border-radius: 12px;
        }
        
        .calendar-cell {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .calendar-cell:hover {
            transform: scale(1.3);
            box-shadow: 0 0 15px var(--color-primary);
            border-color: var(--color-accent);
            z-index: 10;
        }
        
        .calendar-legend {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 12px;
        }
        
        .legend-item {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .calendar-month-labels {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 10px;
            margin-bottom: 10px;
            color: var(--text-secondary);
            font-size: 0.85em;
        }
        
        /* Shareable Cards */
        .share-card {
            width: 600px;
            max-width: 90vw;
            padding: 50px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: 24px;
            color: white;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .share-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s linear infinite;
        }
        
        @keyframes shimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .share-card h1 {
            font-size: 3em;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .share-card-stat {
            font-size: 1.8em;
            margin: 20px 0;
            position: relative;
            z-index: 1;
            text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.2);
        }
        
        .share-card-footer {
            margin-top: 40px;
            opacity: 0.9;
            font-size: 1em;
            position: relative;
            z-index: 1;
        }
        
        .download-button {
            margin-top: 20px;
            padding: 15px 40px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            background: var(--color-accent);
        }
        
        /* Comparison Stats */
        .comparison-stat-card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 16px;
            border: 2px solid var(--border-color);
            text-align: center;
        }
        
        .comparison-years {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 20px 0;
        }
        
        .comparison-year-data {
            flex: 1;
        }
        
        .comparison-divider {
            width: 2px;
            height: 60px;
            background: var(--border-color);
            margin: 0 20px;
        }
        
        .comparison-change {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .comparison-change.positive {
            background: rgba(74, 222, 128, 0.1);
            color: #4ade80;
        }
        
        .comparison-change.negative {
            background: rgba(248, 113, 113, 0.1);
            color: #f87171;
        }
        
        /* ========================================
           MOBILE RESPONSIVE STYLES
           ======================================== */
        
        @media screen and (max-width: 768px) {
            /* MOBILE READABILITY IMPROVEMENTS */
            
            /* Increase base font size on mobile */
            body {
                font-size: 17px; /* Larger for mobile */
            }
            
            /* Stat values even bigger on mobile */
            .stat-card .value {
                font-size: 2.5em; /* Very large and readable */
            }
            
            .stat-card h3 {
                font-size: 1.1em;
            }
            
            /* Insight values */
            .insight-card .value {
                font-size: 1.8em;
            }
            
            /* Headers larger */
            h2 {
                font-size: 1.8em;
            }
            
            h3 {
                font-size: 1.4em;
            }
            
            /* Buttons more readable */
            button {
                font-size: 1.1em;
                padding: 16px 24px;
            }
            
            /* Navigation */
            .nav-btn {
                font-size: 0.95em;
                padding: 12px 18px;
            }
            body {
                padding: 15px 10px;
            }
            
            .container {
                max-width: 100%;
            }
            
            /* Header */
            .header {
                margin-bottom: 30px;
                padding: 30px 20px;
                border-radius: 16px;
            }
            
            .header h1 {
                font-size: 2em;
                margin-bottom: 10px;
            }
            
            .header h1::before {
                font-size: 0.7em;
            }
            
            .header p {
                font-size: 0.95em;
                line-height: 1.5;
            }
            
            /* Upload Section */
            .upload-section {
                padding: 25px 15px;
                border-radius: 16px;
                margin-top: 80px; /* Add space for theme selector */
            }
            
            .file-input-wrapper {
                padding: 50px 25px; /* Larger touch target */
                border-radius: 12px;
                min-height: 200px; /* Ensure enough clickable area */
            }
            
            .upload-icon {
                font-size: 3em;
            }
            
            .file-input-wrapper h3 {
                font-size: 1.1em;
            }
            
            .file-input-wrapper p {
                font-size: 0.9em;
            }
            
            /* Theme selector - move to prevent overlap */
            .theme-selector {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 0.85em;
            }
            
            .theme-selector label {
                display: none; /* Hide label on mobile to save space */
            }
            
            .theme-selector select {
                padding: 8px 10px;
                font-size: 0.85em;
            }
            
            /* Buttons */
            button {
                padding: 14px 30px;
                font-size: 1em;
                width: 100%;
                border-radius: 10px;
            }
            
            /* Navigation */
            .nav {
                flex-direction: column;
                gap: 8px;
                padding: 0;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .nav-btn {
                width: 100%;
                padding: 14px 20px;
                font-size: 0.95em;
                border-radius: 10px;
                white-space: nowrap;
            }
            
            /* Stats Grid */
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stat-card {
                padding: 20px;
                border-radius: 16px;
            }
            
            .stat-card h3 {
                font-size: 0.9em;
            }
            
            .stat-card .value {
                font-size: 2em;
            }
            
            /* Insights Grid */
            .insights-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .insight-card {
                padding: 20px;
            }
            
            .insight-card h4 {
                font-size: 0.9em;
            }
            
            .insight-card .value {
                font-size: 1.8em;
            }
            
            /* Results Section */
            .results-section {
                padding: 25px 15px;
                border-radius: 16px;
            }
            
            .results-section h2 {
                font-size: 1.5em;
            }
            
            /* Filters */
            .filters {
                flex-direction: column;
                gap: 12px;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .filter-group label {
                font-size: 0.9em;
            }
            
            .filter-group select,
            .filter-group input {
                font-size: 0.95em;
                padding: 10px;
            }
            
            /* Tab Container */
            .tab-container {
                flex-wrap: wrap;
                gap: 8px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 5px;
            }
            
            .tab {
                padding: 10px 16px;
                font-size: 0.85em;
                white-space: nowrap;
                flex-shrink: 0;
            }
            
            /* Chart Container */
            .chart-container {
                padding: 20px 15px;
                border-radius: 16px;
            }
            
            .chart-container h2 {
                font-size: 1.4em;
            }
            
            .chart-wrapper {
                height: 350px;
                margin-top: 15px;
            }
            
            /* Lists */
            .song-list li,
            .artist-list li {
                padding: 15px;
                font-size: 0.9em;
            }
            
            .rank {
                font-size: 1em;
                width: 35px;
                height: 35px;
                line-height: 35px;
            }
            
            .song-name,
            .artist-name {
                font-size: 0.95em;
            }
            
            .stats {
                font-size: 0.8em;
            }
            
            /* Subsection */
            .subsection {
                padding: 20px 15px;
                border-radius: 16px;
            }
            
            .subsection h3 {
                font-size: 1.3em;
            }
            
            /* Progress Bar */
            .progress-container {
                width: 90%;
                height: 8px;
            }
            
            .progress-percentage {
                font-size: 1.5em;
            }
            
            /* Loading */
            .loading {
                padding: 30px 15px;
                font-size: 1em;
            }
            
            .spinner {
                width: 45px;
                height: 45px;
                border-width: 3px;
            }
            
            /* Date Sliders */
            .date-slider-container {
                padding: 15px;
            }
            
            .date-slider-label {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            /* Tools Section */
            .tool-button-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .tool-card {
                padding: 15px;
            }
            
            /* Genre Filter Modal */
            #genreFilterModal {
                padding: 20px 15px;
                max-height: 300px;
            }
            
            .genre-checkbox-grid {
                grid-template-columns: 1fr;
            }
            
            /* Export Section */
            .export-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .export-buttons button {
                width: 100%;
            }
        }
        
        /* Extra small screens */
        @media screen and (max-width: 480px) {
            .header h1 {
                font-size: 1.6em;
            }
            
            .header p {
                font-size: 0.9em;
            }
            
            .stat-card .value {
                font-size: 1.8em;
            }
            
            .insight-card .value {
                font-size: 1.5em;
            }
            
            .chart-wrapper {
                height: 300px;
            }
            
            .tab {
                font-size: 0.8em;
                padding: 8px 12px;
            }
        }
        
        /* Landscape mobile */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .insights-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chart-wrapper {
                height: 280px;
            }
        }
        
        /* Tablet */
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .insights-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .nav {
                flex-wrap: wrap;
            }
            
            .chart-wrapper {
                height: 400px;
            }
        }
        
    </style>
</head>
<body>
    <!-- Theme Selector -->
    <div class="theme-selector">
        <label for="themeSelect">ğŸ¨ Theme:</label>
        <select id="themeSelect">
            <option value="nature">ğŸŒ¿ Dark Nature</option>
            <option value="ocean">ğŸŒŠ Ocean</option>
            <option value="sunset">ğŸŒ… Sunset</option>
            <option value="space">ğŸš€ Space</option>
            <option value="neon">ğŸ’  Neon</option>
        </select>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸµ Spotify Streaming Analyzer</h1>
            <p>Upload your Spotify streaming history and discover your listening patterns with beautiful visualizations</p>
        </div>

        <div class="upload-section">
            <div class="file-input-wrapper" id="dropZone">
                <div class="upload-icon">ğŸ“</div>
                <h3>Upload Your Spotify Data</h3>
                <p>Drop JSON files, ZIP file, or select a folder</p>
                
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
                    <button type="button" id="mobileUploadBtn" style="display: none;">
                        ğŸ“‚ Choose Files/ZIP
                    </button>
                    <button type="button" id="folderUploadBtn" style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: white; border: none; padding: 14px 28px; border-radius: 10px; font-size: 1em; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                        ğŸ“ Choose Folder
                    </button>
                </div>
                
                <div id="androidTip" style="font-size: 0.85em; color: var(--text-secondary); margin-top: 15px; padding: 15px; background: rgba(136, 169, 128, 0.1); border-radius: 8px; display: none;">
                    <strong>ğŸ“± Android User? Easy way:</strong><br>
                    1. Keep your Spotify data as a <strong>ZIP file</strong><br>
                    2. Click <strong>"Choose Files/ZIP"</strong> above<br>
                    3. Select the ZIP file - it will extract automatically!<br><br>
                    Or use Chrome/Firefox browser for folder selection
                </div>
                
                <input type="file" id="fileInput" accept=".json,.txt,.zip,application/json,application/zip,application/x-zip-compressed,text/plain,text/json,*/*" multiple>
                <input type="file" id="folderInput" webkitdirectory directory multiple style="position: absolute; opacity: 0; width: 0.1px; height: 0.1px; z-index: -1;">
            </div>
            <div class="file-list" id="fileList"></div>
            <button id="analyzeBtn" disabled>âœ¨ Analyze My Music Data</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">ğŸ§ Analyzing your music data...</p>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-percentage" id="progressPercentage">0%</div>
            <p id="loadingProgress" style="font-size: 0.9em; opacity: 0.8; margin-top: 10px;"></p>
        </div>

        <!-- Navigation Menu -->
        <div class="nav-menu" id="navMenu">
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showSection('overview')">ğŸ“Š Overview</button>
                <button class="nav-btn" onclick="showSection('achievements')">ğŸ† Achievements</button>
                <button class="nav-btn" onclick="showSection('heatmap')">ğŸ“… Calendar</button>
                <button class="nav-btn" onclick="showSection('comparison')">ğŸ“Š Compare Years</button>
                <button class="nav-btn" onclick="showSection('share')">ğŸ“± Share</button>
                <button class="nav-btn" onclick="showSection('charts')">ğŸ“ˆ Charts</button>
                <button class="nav-btn" onclick="showSection('songs')">ğŸµ Songs</button>
                <button class="nav-btn" onclick="showSection('artists')">ğŸ¤ Artists</button>
                <button class="nav-btn" onclick="showSection('genres')">ğŸ¸ Genres</button>
                <button class="nav-btn" onclick="showSection('habits')">ğŸŒ™ Habits</button>
                <button class="nav-btn" onclick="showSection('discovery')">ğŸ†• Discovery</button>
                <button class="nav-btn" onclick="showSection('advanced')">ğŸ”¬ Advanced</button>
                <button class="nav-btn" onclick="showSection('compare')">âš–ï¸ Compare</button>
                <button class="nav-btn" onclick="showSection('tools')">ğŸ”§ Tools</button>
                <button class="nav-btn" onclick="showSection('insights')">ğŸ’¡ Insights</button>
            </div>
        </div>

        <div class="results" id="results">
            <!-- Overview Section -->

        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             OVERVIEW SECTION - Main Statistics Dashboard
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•-->
            <div class="section active" id="overview-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>ğŸ¶ Total Streams</h3>
                        <div class="value" id="totalStreams">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>ğŸµ Unique Songs</h3>
                        <div class="value" id="uniqueSongs">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>ğŸ¤ Unique Artists</h3>
                        <div class="value" id="uniqueArtists">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>â±ï¸ Total Hours</h3>
                        <div class="value" id="totalHours">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>ğŸ“Š Avg Per Day</h3>
                        <div class="value" id="avgPerDay">0</div>
                    </div>
                </div>
                
                <div class="subsection">
                    <h3>ğŸ† Top Favorites</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>ğŸµ Most Played Song</h4>
                            <div class="value" id="topSong">-</div>
                            <p id="topSongArtist" style="color: #8a9d87; margin-top: 8px;">-</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ¤ Top Artist</h4>
                            <div class="value" id="topArtist">-</div>
                            <p id="topArtistPlays" style="color: #8a9d87; margin-top: 8px;">-</p>
                        </div>
                    </div>
                </div>

                <div class="subsection">
                    <h3>ğŸ¯ Quick Stats</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>ğŸ“… Most Active Day</h4>
                            <div class="value" id="mostActiveDay">-</div>
                            <p>Your busiest listening day of the week</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ• Peak Hour</h4>
                            <div class="value" id="peakHour">-</div>
                            <p>Time when you listen the most</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸµ Average Song Length</h4>
                            <div class="value" id="avgSongLength">-</div>
                            <p>Your typical track duration</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ“ˆ Listening Streak</h4>
                            <div class="value" id="listeningStreak">-</div>
                            <p>Days with continuous listening</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Achievements Section -->
            <div class="section" id="achievements-section">
                <div class="subsection">
                    <h3>ğŸ† Achievements</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Unlock badges based on your listening habits!</p>
                    <div id="achievementsGrid" class="insights-grid" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));"></div>
                </div>
            </div>

            <!-- Heat Map Calendar Section -->
            <div class="section" id="heatmap-section">
                <div class="subsection">
                    <h3>ğŸ“… Listening Heat Map Calendar</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">GitHub-style visualization of your daily listening activity</p>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="heatmapYear">Year:</label>
                            <select id="heatmapYear" onchange="updateHeatmap()"></select>
                        </div>
                    </div>
                </div>
                <div id="heatmapContainer" style="overflow-x: auto; padding: 20px 0;"></div>
            </div>

            <!-- Year Comparison Section -->
            <div class="section" id="comparison-section">
                <div class="subsection">
                    <h3>ğŸ“Š Year-over-Year Comparison</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Compare your listening stats across different years</p>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="compareYear1">Year 1:</label>
                            <select id="compareYear1"></select>
                        </div>
                        <div class="filter-group">
                            <label for="compareYear2">Year 2:</label>
                            <select id="compareYear2"></select>
                        </div>
                        <div class="filter-group">
                            <label>&nbsp;</label>
                            <button onclick="runComparison()" style="padding: 10px 20px; width: auto;">ğŸ” Compare</button>
                        </div>
                    </div>
                </div>
                <div id="comparisonResults" style="display: none; margin-top: 30px;">
                    <div class="stats-grid" id="comparisonGrid"></div>
                    <div class="chart-container" style="margin-top: 30px;">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Shareable Cards Section -->
            <div class="section" id="share-section">
                <div class="subsection">
                    <h3>ğŸ“± Share Your Music Stats</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">Create beautiful shareable cards for social media</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <button onclick="generateCard('top-stats')" style="padding: 15px;">
                            ğŸ“Š Top Stats Card
                        </button>
                        <button onclick="generateCard('year-review')" style="padding: 15px;">
                            ğŸ‰ Year in Review
                        </button>
                        <button onclick="generateCard('top-songs')" style="padding: 15px;">
                            ğŸµ Top 5 Songs
                        </button>
                        <button onclick="generateCard('personality')" style="padding: 15px;">
                            ğŸ­ Music Personality
                        </button>
                    </div>
                </div>
                <div id="cardPreview" style="display: flex; flex-direction: column; align-items: center; gap: 20px;"></div>
            </div>

            <!-- Charts Section -->

        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             CHARTS SECTION - Interactive Data Visualizations
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•-->
            <div class="section" id="charts-section">
                <div class="chart-container">
                    <h2>ğŸ“Š Visualizations</h2>
                    <div class="tab-container">
                        <button class="tab active" onclick="switchChartTab('timeline')">ğŸ“ˆ Timeline</button>
                        <button class="tab" onclick="switchChartTab('hourly')">ğŸ• Hourly</button>
                        <button class="tab" onclick="switchChartTab('weekday')">ğŸ“… Weekly</button>
                        <button class="tab" onclick="switchChartTab('topTracks')">ğŸµ Top Tracks</button>
                        <button class="tab" onclick="switchChartTab('topArtists')">ğŸ¤ Top Artists</button>
                        <button class="tab" onclick="switchChartTab('tracksPie')">ğŸ° Tracks Pie</button>
                        <button class="tab" onclick="switchChartTab('artistsPie')">ğŸ° Artists Pie</button>
                    </div>
                    
                    <div id="timeline-chart" class="tab-content active">
                        <div class="chart-wrapper">
                            <canvas id="timelineChart"></canvas>
                        </div>
                    </div>
                    
                    <div id="hourly-chart" class="tab-content">
                        <div class="chart-wrapper">
                            <canvas id="hourlyChart"></canvas>
                        </div>
                    </div>
                    
                    <div id="weekday-chart" class="tab-content">
                        <div class="chart-wrapper">
                            <canvas id="weekdayChart"></canvas>
                        </div>
                    </div>
                    
                    <div id="topTracks-chart" class="tab-content">
                        <div class="chart-wrapper">
                            <canvas id="topTracksChart"></canvas>
                        </div>
                    </div>
                    
                    <div id="topArtists-chart" class="tab-content">
                        <div class="chart-wrapper">
                            <canvas id="topArtistsChart"></canvas>
                        </div>
                    </div>
                    
                    <div id="tracksPie-chart" class="tab-content">
                        <div class="chart-wrapper">
                            <canvas id="tracksPieChart"></canvas>
                        </div>
                    </div>
                    
                    <div id="artistsPie-chart" class="tab-content">
                        <div class="chart-wrapper">
                            <canvas id="artistsPieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Songs Section -->

        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             SONGS SECTION - Track Analysis & Rankings
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•-->
            <div class="section" id="songs-section">
                <div class="results-section">
                    <h2>ğŸµ Top Songs</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="songSortBy">Sort by:</label>
                            <select id="songSortBy">
                                <option value="playCount">â–¶ï¸ Play Count</option>
                                <option value="timeListened">â±ï¸ Time Listened</option>
                                <option value="avgPlayTime">â³ Average Play Time</option>
                                <option value="firstPlayed">ğŸ• First Played</option>
                                <option value="lastPlayed">ğŸ•‘ Last Played</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="songYearFilter">Year:</label>
                            <select id="songYearFilter">
                                <option value="all">All Time</option>
                            </select>
                        </div>
                    </div>
                    <ul class="song-list" id="topSongs"></ul>
                </div>
            </div>

            <!-- Artists Section -->

        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             ARTISTS SECTION - Artist Statistics & Charts
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•-->
            <div class="section" id="artists-section">
                <div class="results-section">
                    <h2>ğŸ¤ Top Artists</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="artistSortBy">Sort by:</label>
                            <select id="artistSortBy">
                                <option value="playCount">â–¶ï¸ Play Count</option>
                                <option value="timeListened">â±ï¸ Time Listened</option>
                                <option value="uniqueTracks">ğŸµ Unique Tracks</option>
                                <option value="avgPlayTime">â³ Average Play Time</option>
                                <option value="firstPlayed">ğŸ• First Played</option>
                                <option value="lastPlayed">ğŸ•‘ Last Played</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="artistYearFilter">Year:</label>
                            <select id="artistYearFilter">
                                <option value="all">All Time</option>
                            </select>
                        </div>
                    </div>
                    <ul class="artist-list" id="topArtists"></ul>
                </div>
            </div>

            <!-- Genres Section -->

        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             GENRES SECTION - Genre Analysis & Visualization
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•-->
            <div class="section" id="genres-section">
                <div class="subsection">
                    <h3>ğŸ¸ Genre Breakdown</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>ğŸµ Favorite Genre</h4>
                            <div class="value" id="topGenre">-</div>
                            <p id="topGenreStats">Your most played genre</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ“Š Total Genres</h4>
                            <div class="value" id="totalGenres">-</div>
                            <p>Different genres in your library</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ­ Genre Diversity</h4>
                            <div class="value" id="genreDiversity">-</div>
                            <p>How varied your genre taste is</p>
                        </div>
                        <div class="insight-card">
                            <h4>â­ Genre Champion</h4>
                            <div class="value" id="genreChampion">-</div>
                            <p>Genre with most unique artists</p>
                        </div>
                    </div>
                </div>

                <div class="results-section">
                    <h2>ğŸ¸ Top Genres</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="genreSortBy">Sort by:</label>
                            <select id="genreSortBy">
                                <option value="playCount">â–¶ï¸ Play Count</option>
                                <option value="timeListened">â±ï¸ Time Listened</option>
                                <option value="uniqueArtists">ğŸ¤ Unique Artists</option>
                                <option value="uniqueTracks">ğŸµ Unique Tracks</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="genreYearFilter">Year:</label>
                            <select id="genreYearFilter">
                                <option value="all">All Time</option>
                            </select>
                        </div>
                    </div>
                    <ul class="artist-list" id="topGenres"></ul>
                </div>

                <div class="chart-container">
                    <h2>ğŸ“Š Genre Visualizations</h2>
                    <div style="margin-bottom: 15px; padding: 12px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border-radius: 10px; border-left: 4px solid #667eea;">
                        <span style="color: #667eea; font-weight: 600;">ğŸ’¡ Tip:</span> 
                        <span style="color: var(--text-primary); font-size: 0.9em;">The "Uncategorized" genre is hidden by default to show clearer results. Click "ğŸ­ Filter Genres" to show it or customize other genres.</span>
                    </div>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="genreChartType">Chart Type:</label>
                            <select id="genreChartType" onchange="updateGenreChart()">
                                <option value="doughnut">ğŸ© Doughnut Chart</option>
                                <option value="bar">ğŸ“Š Bar Chart</option>
                                <option value="pie">ğŸ¥§ Pie Chart</option>
                                <option value="horizontalBar">ğŸ“ˆ Horizontal Bar</option>
                                <option value="polarArea">ğŸ¯ Polar Area</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="genreChartSort">Sort by:</label>
                            <select id="genreChartSort" onchange="updateGenreChart()">
                                <option value="playCount">â–¶ï¸ Play Count</option>
                                <option value="timeListened">â±ï¸ Time Listened</option>
                                <option value="uniqueArtists">ğŸ¤ Unique Artists</option>
                                <option value="uniqueTracks">ğŸµ Unique Tracks</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="genreChartLimit">Show Top:</label>
                            <select id="genreChartLimit" onchange="updateGenreChart()">
                                <option value="5">Top 5</option>
                                <option value="10" selected>Top 10</option>
                                <option value="15">Top 15</option>
                                <option value="20">Top 20</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>&nbsp;</label>
                            <button onclick="showGenreFilter()" style="padding: 10px 20px; margin: 0;">ğŸ­ Filter Genres</button>
                        </div>
                    </div>
                    
                    <!-- Genre Filter Modal -->
                    <div id="genreFilterModal" style="display: none; background: rgba(255,255,255,0.98); border-radius: 15px; padding: 25px; margin-top: 20px; border: 2px solid #667eea; max-height: 400px; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #667eea;">ğŸ­ Filter Genres</h3>
                            <div>
                                <button onclick="selectAllGenres()" style="padding: 8px 16px; margin: 0 5px; font-size: 0.9em;">âœ… Select All</button>
                                <button onclick="deselectAllGenres()" style="padding: 8px 16px; margin: 0 5px; font-size: 0.9em;">âŒ Deselect All</button>
                                <button onclick="hideGenreFilter()" style="padding: 8px 16px; margin: 0 5px; font-size: 0.9em;">âœ–ï¸ Close</button>
                            </div>
                        </div>
                        <div id="genreCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                            <!-- Checkboxes will be populated dynamically -->
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="applyGenreFilter()" style="padding: 12px 30px; margin: 0; font-size: 1em;">âœ¨ Apply Filter</button>
                        </div>
                    </div>
                    
                    <div class="chart-wrapper">
                        <canvas id="genreChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>ğŸ“ˆ Genre Trends Over Time</h2>
                    <div style="margin-bottom: 15px; color: var(--text-primary); font-size: 0.9em;">
                        ğŸ’¡ Showing trends for filtered genres (or top 5 if none filtered)
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="genreTrendChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>â° Genre by Time of Day</h2>
                    <div style="margin-bottom: 15px; color: var(--text-primary); font-size: 0.9em;">
                        ğŸ’¡ Showing time distribution for filtered genres (or top 5 if none filtered)
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="genreTimeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Habits Section -->

        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             HABITS SECTION - Listening Pattern Analysis
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•-->
            <div class="section" id="habits-section">
                <div class="subsection">
                    <h3>ğŸŒ™ Listening Patterns</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>â˜€ï¸ Morning Listener</h4>
                            <div class="value" id="morningScore">-</div>
                            <p>Percentage of listening done 6am-12pm</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸŒ† Afternoon Listener</h4>
                            <div class="value" id="afternoonScore">-</div>
                            <p>Percentage of listening done 12pm-6pm</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸŒƒ Evening Listener</h4>
                            <div class="value" id="eveningScore">-</div>
                            <p>Percentage of listening done 6pm-10pm</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸŒ™ Night Owl</h4>
                            <div class="value" id="nightOwlHabits">-</div>
                            <p>Percentage of listening done 10pm-6am</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>ğŸŒ… Time of Day Distribution</h2>
                    <div class="chart-wrapper">
                        <canvas id="timeOfDayChart"></canvas>
                    </div>
                </div>

                <div class="subsection">
                    <h3>ğŸ“… Seasonal Listening</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>ğŸŒ¸ Spring Listening</h4>
                            <div class="value" id="springStreams">-</div>
                            <p id="springTopGenre">Most played genre</p>
                        </div>
                        <div class="insight-card">
                            <h4>â˜€ï¸ Summer Listening</h4>
                            <div class="value" id="summerStreams">-</div>
                            <p id="summerTopGenre">Most played genre</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ‚ Fall Listening</h4>
                            <div class="value" id="fallStreams">-</div>
                            <p id="fallTopGenre">Most played genre</p>
                        </div>
                        <div class="insight-card">
                            <h4>â„ï¸ Winter Listening</h4>
                            <div class="value" id="winterStreams">-</div>
                            <p id="winterTopGenre">Most played genre</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>ğŸ“Š Seasonal Comparison</h2>
                    <div class="chart-wrapper">
                        <canvas id="seasonalChart"></canvas>
                    </div>
                </div>

                <div class="subsection">
                    <h3>â±ï¸ Session Analysis</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>ğŸ“Š Average Session</h4>
                            <div class="value" id="avgSession">-</div>
                            <p>Average continuous listening time</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ† Longest Session</h4>
                            <div class="value" id="longestSessionReal">-</div>
                            <p>Your longest listening marathon</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ¯ Consistency Score</h4>
                            <div class="value" id="consistencyScore">-</div>
                            <p>How regularly you listen (0-100)</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ“… Active Days</h4>
                            <div class="value" id="activeDays">-</div>
                            <p>Days with at least one stream</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>ğŸ“ˆ Weekday vs Weekend</h2>
                    <div class="chart-wrapper">
                        <canvas id="weekdayWeekendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Discovery Section -->

        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             DISCOVERY SECTION - New Music & Exploration Metrics
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•-->
            <div class="section" id="discovery-section">
                <div class="subsection">
                    <h3>ğŸ†• Music Discovery</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>ğŸ¤ New Artists Per Month</h4>
                            <div class="value" id="newArtistsRate">-</div>
                            <p>Average new artists discovered monthly</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸµ New Tracks Per Month</h4>
                            <div class="value" id="newTracksRate">-</div>
                            <p>Average new songs discovered monthly</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ”„ Repeat Ratio</h4>
                            <div class="value" id="repeatRatio">-</div>
                            <p>Percentage of streams that are re-listens</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ¯ Explorer Score</h4>
                            <div class="value" id="explorerScore">-</div>
                            <p>How adventurous you are (0-100)</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>ğŸ“ˆ Discovery Timeline</h2>
                    <div class="chart-wrapper">
                        <canvas id="discoveryTimelineChart"></canvas>
                    </div>
                </div>

                <div class="subsection">
                    <h3>ğŸ† Artist Loyalty</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>ğŸ’ Most Loyal To</h4>
                            <div class="value" id="mostLoyalArtist">-</div>
                            <p id="loyaltyStats">Consistency of listening</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ†• Newest Discovery</h4>
                            <div class="value" id="newestArtist">-</div>
                            <p id="newestDate">First played date</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ‘´ Oldest Favorite</h4>
                            <div class="value" id="oldestArtist">-</div>
                            <p id="oldestDate">First played date</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ“Š Loyalty Index</h4>
                            <div class="value" id="loyaltyIndex">-</div>
                            <p>Top 10 artists vs total listening</p>
                        </div>
                    </div>
                </div>

                <div class="results-section">
                    <h2>ğŸ†• Recently Discovered Artists (Last 90 Days)</h2>
                    <ul class="artist-list" id="recentArtists"></ul>
                </div>

                <div class="chart-container">
                    <h2>ğŸ”„ Repeat vs Explore Pattern</h2>
                    <div class="chart-wrapper">
                        <canvas id="repeatExploreChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Advanced Section -->
            <div class="section" id="advanced-section">
                <div class="subsection">
                    <h3>ğŸ“Š Decade Analysis</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>ğŸ¸ Favorite Era</h4>
                            <div class="value" id="favoriteDecade">-</div>
                            <p id="decadeStats">Most listened decade</p>
                        </div>
                        <div class="insight-card">
                            <h4>â³ Time Traveler Score</h4>
                            <div class="value" id="timeTravelerScore">-</div>
                            <p>How diverse your decade taste is</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ†• Modern Music Fan</h4>
                            <div class="value" id="modernFan">-</div>
                            <p>% from 2020s</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ‘´ Vintage Vibes</h4>
                            <div class="value" id="vintageScore">-</div>
                            <p>% from before 2000</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>ğŸ“Š Music by Decade</h2>
                    <div class="filters">
                        <div class="filter-group">
                            <label for="decadeChartType">Chart Type:</label>
                            <select id="decadeChartType" onchange="updateDecadeChart()">
                                <option value="bar">ğŸ“Š Bar Chart</option>
                                <option value="pie">ğŸ¥§ Pie Chart</option>
                                <option value="doughnut">ğŸ© Doughnut Chart</option>
                                <option value="line">ğŸ“ˆ Line Chart</option>
                                <option value="polarArea">ğŸ¯ Polar Area</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="decadeSortBy">Sort by:</label>
                            <select id="decadeSortBy" onchange="updateDecadeChart()">
                                <option value="playCount">â–¶ï¸ Play Count</option>
                                <option value="timeListened">â±ï¸ Time Listened</option>
                                <option value="chronological">ğŸ“… Chronological</option>
                                <option value="reverse">ğŸ“… Reverse Chronological</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="decadeDisplay">Display:</label>
                            <select id="decadeDisplay" onchange="updateDecadeChart()">
                                <option value="all">All Decades</option>
                                <option value="top5">Top 5</option>
                                <option value="top10">Top 10</option>
                                <option value="modern">2000s & Later</option>
                                <option value="vintage">Before 2000s</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="decadeChart"></canvas>
                    </div>
                </div>

                <div class="subsection">
                    <h3>ğŸ”¥ Song Obsessions</h3>
                    <p style="color: var(--text-primary); margin-bottom: 20px;">Songs you played on repeat (10+ times in a short period)</p>
                    <ul class="song-list" id="obsessionsList"></ul>
                </div>

                <div class="subsection">
                    <h3>ğŸ¤ Artist Collaborations</h3>
                    <p style="color: var(--text-primary); margin-bottom: 20px;">Artists who frequently appear together in your listening</p>
                    <div class="insights-grid" id="collaborationsGrid"></div>
                </div>

                <div class="subsection">
                    <h3>ğŸŒ Language & Region</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>ğŸ‡ºğŸ‡¸ English Music</h4>
                            <div class="value" id="englishPercent">-</div>
                            <p>Estimated % of English tracks</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ‡ªğŸ‡¸ Spanish Music</h4>
                            <div class="value" id="spanishPercent">-</div>
                            <p>Estimated % of Spanish tracks</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ‡°ğŸ‡· K-Pop</h4>
                            <div class="value" id="kpopPercent">-</div>
                            <p>Estimated % of K-Pop</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸŒ Global Explorer</h4>
                            <div class="value" id="globalScore">-</div>
                            <p>Language diversity score</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New: Insights & Analytics Section -->
            <div class="section" id="insights-section">
                <h2>ğŸ’¡ Deep Insights & Analytics</h2>
                
                <div class="subsection">
                    <h3>âš¡ Energy & Mood Patterns</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>ğŸ”‹ Average Energy</h4>
                            <div class="value" id="avgEnergy">-</div>
                            <p>Based on skip rate & play patterns</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ­ Mood Variety</h4>
                            <div class="value" id="moodVariety">-</div>
                            <p>How diverse your listening moods are</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸŒ™ Night Owl Score</h4>
                            <div class="value" id="nightOwlScore">-</div>
                            <p>% of listening after 10pm</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸŒ… Early Bird Score</h4>
                            <div class="value" id="earlyBirdScore">-</div>
                            <p>% of listening before 8am</p>
                        </div>
                    </div>
                </div>

                <div class="subsection">
                    <h3>â­ï¸ Skip Behavior Analysis</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>â­ï¸ Skip Rate</h4>
                            <div class="value" id="skipRate">-</div>
                            <p>% of songs skipped before 30s</p>
                        </div>
                        <div class="insight-card">
                            <h4>âœ… Completion Rate</h4>
                            <div class="value" id="completionRate">-</div>
                            <p>% of songs fully played</p>
                        </div>
                        <div class="insight-card">
                            <h4>âš¡ Quick Skip Count</h4>
                            <div class="value" id="quickSkips">-</div>
                            <p>Songs skipped in first 10 seconds</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ’ Perfect Songs</h4>
                            <div class="value" id="perfectSongs">-</div>
                            <p>Songs never skipped</p>
                        </div>
                    </div>
                    <div class="chart-container" style="margin-top: 20px;">
                        <div class="chart-wrapper">
                            <canvas id="skipChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="subsection">
                    <h3>ğŸ² Diversity & Variety</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>ğŸŒˆ Diversity Score</h4>
                            <div class="value" id="diversityScore">-</div>
                            <p>How varied your music taste is (0-100)</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ”„ Repeat Rate</h4>
                            <div class="value" id="repeatRate">-</div>
                            <p>% of listening time on top 10 songs</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ†• Discovery Rate</h4>
                            <div class="value" id="discoveryRate">-</div>
                            <p>New songs per week</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ¯ Focus Level</h4>
                            <div class="value" id="focusLevel">-</div>
                            <p>Artist concentration score</p>
                        </div>
                    </div>
                </div>

                <div class="subsection">
                    <h3>ğŸƒ Binge Listening Sessions</h3>
                    <p style="color: var(--text-primary); margin-bottom: 20px;">Your longest continuous listening marathons</p>
                    <div id="bingeSessions"></div>
                </div>

                <div class="subsection">
                    <h3>ğŸ† Artist Loyalty Rankings</h3>
                    <p style="color: var(--text-primary); margin-bottom: 20px;">Artists you're most loyal to over time</p>
                    <div class="chart-wrapper">
                        <canvas id="loyaltyChart"></canvas>
                    </div>
                </div>

                <div class="subsection">
                    <h3>ğŸ“… Monthly Breakdown</h3>
                    <p style="color: var(--text-primary); margin-bottom: 20px;">See your top artist and song for each month</p>
                    <div id="monthlyBreakdown"></div>
                </div>
            </div>

            <!-- Compare Section -->
            <div class="section" id="compare-section">
                <div class="subsection">
                    <h3>âš–ï¸ Time Period Comparison</h3>
                    
                    <div class="date-slider-container">
                        <div class="date-slider-group">
                            <div class="date-slider-label">
                                <span>ğŸ“… Period 1</span>
                                <span class="date-display" id="period1Display">Select dates</span>
                            </div>
                            <div class="dual-slider-wrapper">
                                <div class="slider-track"></div>
                                <div class="slider-range" id="period1Range"></div>
                                <input type="range" class="date-range-slider" id="period1StartSlider" min="0" max="100" value="0">
                                <input type="range" class="date-range-slider" id="period1EndSlider" min="0" max="100" value="33">
                            </div>
                        </div>

                        <div class="period-divider">VS</div>

                        <div class="date-slider-group">
                            <div class="date-slider-label">
                                <span>ğŸ“… Period 2</span>
                                <span class="date-display" id="period2Display">Select dates</span>
                            </div>
                            <div class="dual-slider-wrapper">
                                <div class="slider-track"></div>
                                <div class="slider-range" id="period2Range"></div>
                                <input type="range" class="date-range-slider" id="period2StartSlider" min="0" max="100" value="67">
                                <input type="range" class="date-range-slider" id="period2EndSlider" min="0" max="100" value="100">
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 25px;">
                            <button onclick="comparePeriods()" style="padding: 14px 40px;">ğŸ” Compare Periods</button>
                        </div>
                    </div>
                    
                    <div id="comparisonResults" style="margin-top: 30px;"></div>
                </div>

                <div class="subsection">
                    <h3>ğŸ’¼ Work vs Leisure Hours</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>ğŸ’¼ Work Hours (9am-5pm)</h4>
                            <div class="value" id="workHoursStreams">-</div>
                            <p id="workHoursTop">Top genre during work</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ–ï¸ Leisure Hours</h4>
                            <div class="value" id="leisureHoursStreams">-</div>
                            <p id="leisureHoursTop">Top genre during leisure</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ“Š Work/Life Balance</h4>
                            <div class="value" id="workLifeRatio">-</div>
                            <p>Ratio of work to leisure listening</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸµ Work Soundtrack</h4>
                            <div class="value" id="workSoundtrack">-</div>
                            <p>Most played during work hours</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>ğŸ“Š Work vs Leisure Breakdown</h2>
                    <div class="chart-wrapper">
                        <canvas id="workLeisureChart"></canvas>
                    </div>
                </div>

                <div class="subsection">
                    <h3>ğŸ“… Weekday vs Weekend Deep Dive</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>ğŸ“… Weekday Top Genre</h4>
                            <div class="value" id="weekdayTopGenre">-</div>
                            <p id="weekdayGenreStats">-</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ‰ Weekend Top Genre</h4>
                            <div class="value" id="weekendTopGenre">-</div>
                            <p id="weekendGenreStats">-</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ“Š Weekday Diversity</h4>
                            <div class="value" id="weekdayDiversity">-</div>
                            <p>Unique genres on weekdays</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ“Š Weekend Diversity</h4>
                            <div class="value" id="weekendDiversity">-</div>
                            <p>Unique genres on weekends</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tools Section -->

        
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             TOOLS SECTION - Interactive Tools & Utilities
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•-->
            <div class="section" id="tools-section">
                <div class="subsection">
                    <h3>ğŸ” Quick Find</h3>
                    <p style="color: var(--text-primary); margin-bottom: 20px;">Browse your music by categories</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <button onclick="showTopSongs()" style="padding: 15px;">
                            ğŸµ Show Top Songs
                        </button>
                        <button onclick="showTopArtists()" style="padding: 15px;">
                            ğŸ¤ Show Top Artists
                        </button>
                        <button onclick="showRecentlyPlayed()" style="padding: 15px;">
                            ğŸ• Recently Played
                        </button>
                        <button onclick="showMostPlayed()" style="padding: 15px;">
                            ğŸ”¥ Most Played Ever
                        </button>
                        <button onclick="showLongestSongs()" style="padding: 15px;">
                            â±ï¸ Longest Songs
                        </button>
                        <button onclick="showOneHitWonders()" style="padding: 15px;">
                            â­ One-Hit Wonders
                        </button>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.7); padding: 20px; border-radius: 12px; margin-top: 15px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600;">Filter by Genre:</label>
                        <select id="quickFindGenre" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 1em;" onchange="applyQuickFilter()">
                            <option value="">All Genres</option>
                        </select>
                    </div>
                    
                    <div id="quickFindResults" style="margin-top: 20px;"></div>
                </div>

                <div class="subsection">
                    <h3>ğŸ“… Time Travel</h3>
                    <p style="color: var(--text-primary); margin-bottom: 20px;">Jump to different time periods</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                        <button onclick="showTimeRange('today')" style="padding: 12px;">
                            ğŸ“ Today
                        </button>
                        <button onclick="showTimeRange('week')" style="padding: 12px;">
                            ğŸ“… This Week
                        </button>
                        <button onclick="showTimeRange('month')" style="padding: 12px;">
                            ğŸ—“ï¸ This Month
                        </button>
                        <button onclick="showTimeRange('3months')" style="padding: 12px;">
                            ğŸ“Š Last 3 Months
                        </button>
                        <button onclick="showTimeRange('6months')" style="padding: 12px;">
                            ğŸ“ˆ Last 6 Months
                        </button>
                        <button onclick="showTimeRange('year')" style="padding: 12px;">
                            ğŸ¯ This Year
                        </button>
                        <button onclick="showTimeRange('all')" style="padding: 12px; background: linear-gradient(135deg, #f093fb, #667eea);">
                            â™¾ï¸ All Time
                        </button>
                    </div>
                    
                    <div id="timeRangeResults" style="margin-top: 20px;"></div>
                </div>

                <div class="subsection">
                    <h3>ğŸ² Random Discoveries</h3>
                    <p style="color: var(--text-primary); margin-bottom: 20px;">Rediscover forgotten favorites</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <button onclick="showRandomSong()" style="padding: 15px;">
                            ğŸ² Random Song
                        </button>
                        <button onclick="showRandomArtist()" style="padding: 15px;">
                            ğŸ­ Random Artist
                        </button>
                        <button onclick="showForgottenGems()" style="padding: 15px;">
                            ğŸ’ Forgotten Gems
                        </button>
                        <button onclick="showDeepCuts()" style="padding: 15px;">
                            ğŸ¸ Deep Cuts
                        </button>
                    </div>
                    
                    <div id="randomResults" style="margin-top: 20px;"></div>
                </div>

                <div class="subsection">
                    <h3>ğŸ“¥ Export & Share</h3>
                    <div class="insights-grid">
                        <div class="insight-card" style="cursor: pointer;" onclick="generateWrapped()">
                            <h4>ğŸ Generate Wrapped</h4>
                            <div class="value">ğŸ“Š</div>
                            <p>Create a year-in-review summary</p>
                        </div>
                        <div class="insight-card" style="cursor: pointer;" onclick="exportTopLists()">
                            <h4>ğŸ“‹ Export Lists</h4>
                            <div class="value">ğŸ“„</div>
                            <p>Download your top songs & artists</p>
                        </div>
                        <div class="insight-card" style="cursor: pointer;" onclick="generatePlaylist()">
                            <h4>ğŸµ Generate Playlist</h4>
                            <div class="value">ğŸ¶</div>
                            <p>Create playlist from top 50 songs</p>
                        </div>
                        <div class="insight-card" style="cursor: pointer;" onclick="shareStats()">
                            <h4>ğŸ“¸ Share Card</h4>
                            <div class="value">ğŸ–¼ï¸</div>
                            <p>Create shareable stats image</p>
                        </div>
                    </div>
                </div>

                <div id="exportOutput" style="margin-top: 20px;"></div>
            </div>

            <!-- Insights Section -->
            <div class="section" id="insights-section">
                <div class="subsection">
                    <h3>ğŸ’¡ Your Music Journey</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>ğŸ¯ Most Dedicated Fan Of</h4>
                            <div class="value" id="topArtistName">-</div>
                            <p id="topArtistStats">Your most played artist</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸµ Favorite Song</h4>
                            <div class="value" id="topSongName">-</div>
                            <p id="topSongStats">Your most played track</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ“Š Music Diversity</h4>
                            <div class="value" id="diversityScore">-</div>
                            <p>How varied your music taste is</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸŒ™ Night Owl Score</h4>
                            <div class="value" id="nightOwlScore">-</div>
                            <p>Percentage of late-night listening (10pm-4am)</p>
                        </div>
                    </div>
                </div>

                <div class="subsection">
                    <h3>ğŸ† Your Records</h3>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <h4>ğŸ”¥ Most Active Month</h4>
                            <div class="value" id="mostActiveMonth">-</div>
                            <p id="mostActiveMonthStats">Your peak listening period</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ§ Longest Session</h4>
                            <div class="value" id="longestSession">-</div>
                            <p>Most consecutive hours of listening</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ†• Discovery Rate</h4>
                            <div class="value" id="discoveryRate">-</div>
                            <p>New artists discovered per month</p>
                        </div>
                        <div class="insight-card">
                            <h4>ğŸ” Replay Value</h4>
                            <div class="value" id="replayValue">-</div>
                            <p>Average plays per song</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           JAVASCRIPT - FULL ANALYZER APPLICATION
           All features preserved and organized
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•*/


        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           QUICK NAVIGATION - JAVASCRIPT FUNCTIONS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           
           ğŸ“ FILE HANDLING (Lines ~3250-3380):
              - handleFiles() - Process uploaded files
              - handleZipFile() - Extract and process ZIP files
              - analyzeData() - Main analysis orchestrator
           
           ğŸ“Š DATA ANALYSIS (Lines ~3400-4200):
              - calculateBasicStats() - Core statistics
              - calculateQuickStats() - Fast preview metrics
              - analyzeStreams() - Comprehensive stream analysis
              - calculateAdvancedAnalytics() - Skip behavior, streaks, loyalty
              - calculateDeepInsights() - Discovery metrics, patterns
              - calculateBingeSessions() - Session detection
              - calculateMonthlyBreakdown() - Time-based aggregation
           
           ğŸ“ˆ CHART CREATION (Lines ~5600-6800):
              - createTimelineChart() - Monthly trends
              - createHourlyChart() - 24-hour patterns
              - createWeekdayChart() - Weekly patterns
              - createTopTracksChart() - Top songs visualization
              - createTopArtistsChart() - Artist rankings
              - createGenreChart() - Genre distribution (5 types)
              - createGenreTrendChart() - Genre evolution
              - createGenreTimeChart() - Genre by hour
              - Plus 7+ more specialized charts
           
           ğŸ¯ DISPLAY FUNCTIONS (Lines ~5400-5620):
              - updateAllDisplays() - Refresh all UI elements
              - updateGenreDisplay() - Genre section updates
              - updateSongDisplay() - Song list updates
              - updateArtistDisplay() - Artist rankings
              - displaySongList() - Render song lists
           
           ğŸ› ï¸ TOOL FUNCTIONS (Lines ~6800-7200):
              - performSearch() - Quick find functionality
              - showTimeRange() - Time period filtering
              - showRandomSong() - Random discovery
              - showForgottenGems() - Find rare plays
              - applyDateFilter() - Date range filtering
           
           âš™ï¸ UTILITY FUNCTIONS (Lines ~3100-3250):
              - initializeTheme() - Theme setup
              - setTheme() - Change color scheme
              - initializeDateSliders() - Date range controls
              - populateYearFilters() - Year dropdown setup
              - categorizeGenre() - Genre classification (50+ genres)
           
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•*/



        /* ============================================================
           SPOTIFY STREAMING ANALYZER - JAVASCRIPT
           ============================================================
           
           TABLE OF CONTENTS:
           ------------------
           1. GLOBAL VARIABLES & STATE
           2. DOM INITIALIZATION & EVENT LISTENERS
           3. FILE HANDLING (Upload, Drag & Drop, Parse)
           4. DATA ANALYSIS ENGINE
           5. UI UPDATE FUNCTIONS
           6. CHART CREATION & UPDATES
           7. SECTION-SPECIFIC CALCULATIONS
           8. UTILITY FUNCTIONS
           9. EXPORT & SHARING FEATURES
           
           ============================================================ */
        
        /* ============================================================
           1. GLOBAL VARIABLES & STATE
           ============================================================ */
        
        // File upload tracking
        let uploadedFiles = [];           // Array of File objects uploaded by user
        
        // Data storage
        let allStreamsData = [];          // Main array of all streaming records
        let cachedAnalysis = null;        // Cached analysis results for performance
        
        // Chart management
        let charts = {};                  // Object storing all Chart.js instances
        
        // Genre filtering
        let filteredGenres = new Set(['Uncategorized']); // Genres to hide from charts
        let allAvailableGenres = [];     // All unique genres found in data
        
        // Date range
        let minDate = null;               // Earliest stream date
        let maxDate = null;               // Latest stream date
        
        // Section loading tracking (for lazy loading)
        window.sectionsLoaded = {};       // Tracks which sections have been loaded
        window.chartsCreated = {};        // Tracks which charts have been created
        window.dataLoaded = false;        // Whether data has been analyzed

        /* ============================================================
           2. DOM INITIALIZATION & EVENT LISTENERS
           ============================================================ */
        
        /**
         * Initialize theme system
         * Loads saved theme from localStorage and sets up theme switcher
         */
        function initializeTheme() {
            const themeSelect = document.getElementById('themeSelect');
            
            // Load saved theme or default to 'nature'
            const savedTheme = localStorage.getItem('spotifyAnalyzerTheme') || 'nature';
            document.documentElement.setAttribute('data-theme', savedTheme);
            themeSelect.value = savedTheme;
            
            // Theme change handler
            themeSelect.addEventListener('change', (e) => {
                const newTheme = e.target.value;
                setTheme(newTheme);
            });
            
            console.log('âœ… Theme system initialized:', savedTheme);
        }
        
        /**
         * Change the application theme
         * @param {string} themeName - Theme identifier (nature, ocean, sunset, space, neon)
         */
        function setTheme(themeName) {
            document.documentElement.setAttribute('data-theme', themeName);
            localStorage.setItem('spotifyAnalyzerTheme', themeName);
            console.log('ğŸ¨ Theme changed to:', themeName);
        }
        
        // Wait for DOM to be fully loaded before initializing
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            
            // Initialize theme system
            initializeTheme();
            
            // Get references to main UI elements
            const fileInput = document.getElementById('fileInput');
            const folderInput = document.getElementById('folderInput');
            const dropZone = document.getElementById('dropZone');
            const fileList = document.getElementById('fileList');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const mobileUploadBtn = document.getElementById('mobileUploadBtn');
            const folderUploadBtn = document.getElementById('folderUploadBtn');

            // Verify critical elements exist
            if (!fileInput || !dropZone) {
                console.error('File input elements not found!');
                return;
            }

            console.log('File input elements found, attaching listeners...');
            
            // Folder upload button handler
            if (folderUploadBtn && folderInput) {
                folderUploadBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('Folder upload button clicked');
                    folderInput.click();
                });
                
                // Handle folder selection
                folderInput.addEventListener('change', (e) => {
                    console.log('Folder selected, files:', e.target.files.length);
                    // Filter to only JSON files
                    const jsonFiles = Array.from(e.target.files).filter(file => 
                        file.name.endsWith('.json') || 
                        file.type === 'application/json' ||
                        file.name.toLowerCase().includes('streaming')
                    );
                    console.log('JSON files found in folder:', jsonFiles.length);
                    if (jsonFiles.length > 0) {
                        handleFiles(jsonFiles);
                    } else {
                        alert('No JSON files found in the selected folder. Please make sure you selected the correct Spotify data folder.');
                    }
                });
            }
            
            // Detect mobile/Android and show visible upload button
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            if (isMobile || isAndroid) {
                console.log('Mobile/Android detected, showing visible upload button');
                
                // Remove accept attribute on Android so all files show up
                fileInput.removeAttribute('accept');
                console.log('Removed accept attribute to show all files on Android');
                
                // Show Android tip
                const androidTip = document.getElementById('androidTip');
                if (androidTip && isAndroid) {
                    androidTip.style.display = 'block';
                }
                
                if (mobileUploadBtn) {
                    mobileUploadBtn.style.display = 'inline-block';
                    
                    // Mobile upload button click handler
                    mobileUploadBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        console.log('Mobile upload button clicked');
                        fileInput.click();
                    });
                }
            }

            // File upload click handler
            dropZone.addEventListener('click', (e) => {
                // Don't trigger if clicking the mobile button
                if (e.target.id === 'mobileUploadBtn') return;
                console.log('Drop zone clicked');
                fileInput.click();
            });
            
            // File selection change handler
            fileInput.addEventListener('change', (e) => {
                console.log('Files selected:', e.target.files.length);
                handleFiles(e.target.files);
            });

            // Drag and drop handlers
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                console.log('Files dropped:', e.dataTransfer.files.length);
                handleFiles(e.dataTransfer.files);
            });

            console.log('Event listeners attached successfully');
            
            // File handling function
            /**
             * Handles file selection from user input
             * Filters for JSON files and updates UI
             * 
             * @param {FileList} files - Files selected by user
             */
            async function handleFiles(files) {
                console.log('handleFiles called with', files.length, 'files');
                
                // Validate input
                if (!files || files.length === 0) {
                    console.error('No files provided to handleFiles');
                    alert('No files selected. Please try again.');
                    return;
                }
                
                // Check if any ZIP files
                const zipFiles = Array.from(files).filter(f => 
                    f.name.endsWith('.zip') || 
                    f.type === 'application/zip' || 
                    f.type === 'application/x-zip-compressed'
                );
                
                if (zipFiles.length > 0) {
                    console.log('ZIP file detected, extracting...');
                    await handleZipFile(zipFiles[0]);
                    return;
                }
                
                // Filter for JSON files only
                uploadedFiles = Array.from(files).filter(f => f.name.endsWith('.json'));
                console.log('Filtered to', uploadedFiles.length, 'JSON files');
                
                // Check if any valid files
                if (uploadedFiles.length === 0) {
                    alert('âš ï¸ Please select JSON files or a ZIP file.\n\nSpotify streaming history files should end with .json');
                    return;
                }

                // Update file list display
                fileList.innerHTML = `<strong>âœ… ${uploadedFiles.length} file(s) selected:</strong>`;
                uploadedFiles.forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'file-list-item';
                    item.textContent = `ğŸ“„ ${file.name}`;
                    fileList.appendChild(item);
                });

                // Enable analyze button
                analyzeBtn.disabled = false;
                console.log('Files ready for analysis');
            }
            
            async function handleZipFile(zipFile) {
                try {
                    console.log('Extracting ZIP file:', zipFile.name);
                    fileList.innerHTML = `<strong>ğŸ“¦ Extracting ZIP file...</strong>`;
                    
                    // Load JSZip
                    if (typeof JSZip === 'undefined') {
                        alert('âš ï¸ ZIP support not loaded. Please refresh the page and try again.');
                        return;
                    }
                    
                    // Read the ZIP file
                    const zip = await JSZip.loadAsync(zipFile);
                    console.log('ZIP loaded, files:', Object.keys(zip.files).length);
                    
                    // Extract JSON files
                    const jsonFiles = [];
                    for (const filename in zip.files) {
                        const file = zip.files[filename];
                        
                        // Skip directories and non-JSON files
                        if (file.dir) continue;
                        if (!filename.endsWith('.json')) continue;
                        
                        console.log('Extracting:', filename);
                        
                        // Read file content as text
                        const content = await file.async('text');
                        
                        // Create a File object
                        const blob = new Blob([content], { type: 'application/json' });
                        const extractedFile = new File([blob], filename.split('/').pop(), { 
                            type: 'application/json' 
                        });
                        
                        jsonFiles.push(extractedFile);
                    }
                    
                    console.log('Extracted', jsonFiles.length, 'JSON files from ZIP');
                    
                    if (jsonFiles.length === 0) {
                        alert('âš ï¸ No JSON files found in the ZIP file.\n\nPlease make sure your ZIP contains Spotify streaming history JSON files.');
                        fileList.innerHTML = '';
                        return;
                    }
                    
                    // Store extracted files
                    uploadedFiles = jsonFiles;
                    
                    // Update file list display
                    fileList.innerHTML = `<strong>âœ… Extracted ${jsonFiles.length} JSON file(s) from ZIP:</strong>`;
                    jsonFiles.forEach(file => {
                        const item = document.createElement('div');
                        item.className = 'file-list-item';
                        item.textContent = `ğŸ“„ ${file.name}`;
                        fileList.appendChild(item);
                    });
                    
                    // Enable analyze button
                    analyzeBtn.disabled = false;
                    console.log('ZIP extraction complete, files ready for analysis');
                    
                } catch (error) {
                    console.error('Error extracting ZIP:', error);
                    alert('âš ï¸ Error extracting ZIP file: ' + error.message + '\n\nPlease make sure the file is a valid ZIP file.');
                    fileList.innerHTML = '';
                }
            }

            analyzeBtn.addEventListener('click', analyzeData);

            // Add filter change listeners
            document.getElementById('songSortBy').addEventListener('change', updateSongDisplay);
            document.getElementById('songYearFilter').addEventListener('change', updateSongDisplay);
            document.getElementById('artistSortBy').addEventListener('change', updateArtistDisplay);
            document.getElementById('artistYearFilter').addEventListener('change', updateArtistDisplay);
            document.getElementById('genreSortBy').addEventListener('change', updateGenreDisplay);
            document.getElementById('genreYearFilter').addEventListener('change', updateGenreDisplay);

            async function analyzeData() {
                // Visual feedback - button animation
                analyzeBtn.classList.add('clicked');
                analyzeBtn.textContent = 'âš¡ Processing...';
                analyzeBtn.disabled = true;
                
                // Add a slight delay so user sees the click
                await new Promise(resolve => setTimeout(resolve, 100));
                
                loading.style.display = 'block';
                results.style.display = 'none';

                allStreamsData = [];
                
                const loadingText = document.getElementById('loadingText');
                const loadingProgress = document.getElementById('loadingProgress');
                const progressBar = document.getElementById('progressBar');
                const progressPercentage = document.getElementById('progressPercentage');
                
                // Helper function to update progress

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // UPDATEPROGRESS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                function updateProgress(percent, text, subtext) {
                    progressBar.style.width = percent + '%';
                    progressPercentage.textContent = percent + '%';
                    if (text) loadingText.textContent = text;
                    if (subtext) loadingProgress.textContent = subtext;
                }
                
                // Start at 5%
                updateProgress(5, 'ğŸ“‚ Reading files...', 'Preparing to load your data...');
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Read all files (5% -> 60%)
                const filesProgressStep = 55 / uploadedFiles.length;
                for (let i = 0; i < uploadedFiles.length; i++) {
                    const file = uploadedFiles[i];
                    const currentProgress = 5 + (filesProgressStep * i);
                    updateProgress(Math.round(currentProgress), 'ğŸ“‚ Reading files...', `Processing ${i + 1} of ${uploadedFiles.length} files...`);
                    
                    try {
                        const content = await file.text();
                        const data = JSON.parse(content);
                        
                        if (Array.isArray(data)) {
                            allStreamsData.push(...data);
                        } else {
                            allStreamsData.push(data);
                        }
                    } catch (error) {
                        console.error(`Error parsing ${file.name}:`, error);
                    }
                    
                    // Small delay to show progress
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                console.log(`Loaded ${allStreamsData.length.toLocaleString()} streams`);
                updateProgress(60, 'ğŸµ Processing your music data...', `${allStreamsData.length.toLocaleString()} streams loaded!`);
                
                // For very large datasets (>100k streams), show a warning
                if (allStreamsData.length > 100000) {
                    console.warn('Large dataset detected - some features may take longer to load');
                    loadingProgress.textContent = `${allStreamsData.length.toLocaleString()} streams loaded! (Large dataset - please wait...)`;
                }
                
                await new Promise(resolve => setTimeout(resolve, 300));

                // Populate year filters (60% -> 75%)
                updateProgress(75, 'ğŸ“… Organizing dates...', 'Building timeline...');
                populateYearFilters();
                
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Calculate basic stats (75% -> 95%)
                updateProgress(80, 'ğŸ“Š Calculating statistics...', 'Analyzing your data...');
                try {
                    calculateBasicStats();
                    updateProgress(95, 'ğŸ“Š Calculating statistics...', 'Almost done!');
                } catch (error) {
                    console.error('Error calculating stats:', error);
                    updateProgress(95, 'ğŸ“Š Calculating statistics...', 'Finalizing...');
                }
                
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Complete! (95% -> 100%)
                updateProgress(100, 'âœ… Complete!', 'Loading your dashboard...');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                loading.style.display = 'none';
                results.style.display = 'block';
                document.getElementById('navMenu').classList.add('visible');
                
                // Hide upload section after analysis
                document.querySelector('.upload-section').style.display = 'none';
                
                // Initialize date sliders
                try {
                    initializeDateSliders();
                } catch (error) {
                    console.error('Error initializing date sliders:', error);
                }
                
                // Mark that data is loaded
                window.dataLoaded = true;
                window.sectionsLoaded = { overview: true };
            }
        });

        // Lazy loading - calculate data only when section is viewed
        // cachedAnalysis already declared at top of script
        
        function getCachedAnalysis() {
            if (!cachedAnalysis) {
                cachedAnalysis = analyzeStreams(allStreamsData.filter(s => s.ms_played >= 30000));
            }
            return cachedAnalysis;
        }

        /**
         * Animate number counting up
         * Creates a smooth counting animation for stat values
         */
        function animateCounter(element, start, end, duration = 1000, isDecimal = false) {
            if (!element) return;
            
            const range = end - start;
            const increment = range / (duration / 16); // 60fps
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                
                if (isDecimal) {
                    element.textContent = current.toFixed(1);
                } else {
                    element.textContent = Math.floor(current).toLocaleString();
                }
            }, 16);
        }
        
        /**
         * Calculate and display basic statistics
         * Shows total streams, unique songs/artists, hours, and daily average
         */

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CALCULATEBASICSTATS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function calculateBasicStats() {
            try {
                console.log('Starting calculateBasicStats...');
                console.log('Total streams data:', allStreamsData.length);
                
                const validStreams = allStreamsData.filter(s => s.ms_played >= 30000);
                console.log('Valid streams (>30s):', validStreams.length);
                
                if (validStreams.length === 0) {
                    console.warn('No valid streams found');
                    document.getElementById('totalStreams').textContent = '0';
                    document.getElementById('uniqueSongs').textContent = '0';
                    document.getElementById('uniqueArtists').textContent = '0';
                    document.getElementById('totalHours').textContent = '0';
                    document.getElementById('avgPerDay').textContent = '0';
                    document.getElementById('topSong').textContent = 'No data';
                    document.getElementById('topSongArtist').textContent = '';
                    document.getElementById('topArtist').textContent = 'No data';
                    document.getElementById('topArtistPlays').textContent = '0 plays';
                    return;
                }
                
                console.log('Analyzing streams...');
                const analysis = analyzeStreams(validStreams);
                console.log('Analysis complete');
                
                // Calculate min and max dates first
                const dates = allStreamsData
                    .filter(s => s.ts)
                    .map(s => new Date(s.ts))
                    .filter(d => !isNaN(d.getTime()));
                
                if (dates.length > 0) {
                    minDate = new Date(Math.min(...dates));
                    maxDate = new Date(Math.max(...dates));
                    console.log('Date range:', minDate, 'to', maxDate);
                }
                
                // Basic overview stats with animations
                console.log('Setting stat values...');
                
                // Animate total streams
                animateCounter(
                    document.getElementById('totalStreams'),
                    0,
                    validStreams.length,
                    1200
                );
                
                // Animate unique songs
                animateCounter(
                    document.getElementById('uniqueSongs'),
                    0,
                    Object.keys(analysis.trackStats).length,
                    1400
                );
                
                // Animate unique artists
                animateCounter(
                    document.getElementById('uniqueArtists'),
                    0,
                    Object.keys(analysis.artistStats).length,
                    1600
                );
                
                // Animate total hours
                const totalHours = allStreamsData.reduce((sum, s) => sum + (s.ms_played || 0), 0) / (1000 * 60 * 60);
                animateCounter(
                    document.getElementById('totalHours'),
                    0,
                    totalHours,
                    1800,
                    true // decimal
                );
                
                // Animate avg per day
                if (minDate && maxDate) {
                    const daysDiff = (maxDate - minDate) / (1000 * 60 * 60 * 24);
                    const avgPerDay = daysDiff > 0 ? (validStreams.length / daysDiff) : 0;
                    animateCounter(
                        document.getElementById('avgPerDay'),
                        0,
                        avgPerDay,
                        2000,
                        true // decimal
                    );
                } else {
                    document.getElementById('avgPerDay').textContent = '0';
                }
                
                const topTrack = Object.values(analysis.trackStats).sort((a, b) => b.playCount - a.playCount)[0];
                if (topTrack) {
                    document.getElementById('topSong').textContent = topTrack.track || 'Unknown';
                    document.getElementById('topSongArtist').textContent = topTrack.artist || 'Unknown Artist';
                } else {
                    document.getElementById('topSong').textContent = 'No data';
                    document.getElementById('topSongArtist').textContent = '';
                }
                
                const topArtist = Object.values(analysis.artistStats).sort((a, b) => b.playCount - a.playCount)[0];
                if (topArtist) {
                    document.getElementById('topArtist').textContent = topArtist.artist || 'Unknown';
                    document.getElementById('topArtistPlays').textContent = `${topArtist.playCount} plays`;
                } else {
                    document.getElementById('topArtist').textContent = 'No data';
                    document.getElementById('topArtistPlays').textContent = '0 plays';
                }
                
                cachedAnalysis = analysis;
                console.log('âœ… Basic stats calculated successfully');
                
                // Calculate Quick Stats
                calculateQuickStats(validStreams);
            } catch (error) {
                console.error('âŒ Error calculating basic stats:', error);
                console.error('Error stack:', error.stack);
                // Set safe defaults
                document.getElementById('totalStreams').textContent = '0';
                document.getElementById('uniqueSongs').textContent = '0';
                document.getElementById('uniqueArtists').textContent = '0';
                document.getElementById('totalHours').textContent = '0';
                document.getElementById('avgPerDay').textContent = '0';
                document.getElementById('topSong').textContent = 'Error loading';
                document.getElementById('topSongArtist').textContent = 'Check console';
                document.getElementById('topArtist').textContent = 'Error loading';
                document.getElementById('topArtistPlays').textContent = 'Check console';
            }
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CALCULATEQUICKSTATS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function calculateQuickStats(validStreams) {
            try {
                // Most Active Day
                const dayCount = {};
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                validStreams.forEach(s => {
                    if (s.ts) {
                        const day = new Date(s.ts).getDay();
                        dayCount[day] = (dayCount[day] || 0) + 1;
                    }
                });
                const mostActiveDay = Object.keys(dayCount).reduce((a, b) => dayCount[a] > dayCount[b] ? a : b, 0);
                document.getElementById('mostActiveDay').textContent = days[mostActiveDay] || '-';
                
                // Peak Hour
                const hourCount = {};
                validStreams.forEach(s => {
                    if (s.ts) {
                        const hour = new Date(s.ts).getHours();
                        hourCount[hour] = (hourCount[hour] || 0) + 1;
                    }
                });
                const peakHour = Object.keys(hourCount).reduce((a, b) => hourCount[a] > hourCount[b] ? a : b, 0);
                const hourFormatted = peakHour == 0 ? '12am' : peakHour < 12 ? `${peakHour}am` : peakHour == 12 ? '12pm' : `${peakHour - 12}pm`;
                document.getElementById('peakHour').textContent = hourFormatted;
                
                // Average Song Length
                const totalMs = validStreams.reduce((sum, s) => sum + (s.ms_played || 0), 0);
                const avgMs = totalMs / validStreams.length;
                const minutes = Math.floor(avgMs / 60000);
                const seconds = Math.floor((avgMs % 60000) / 1000);
                document.getElementById('avgSongLength').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Listening Streak
                const dateSet = new Set();
                validStreams.forEach(s => {
                    if (s.ts) {
                        const date = new Date(s.ts);
                        const dateStr = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
                        dateSet.add(dateStr);
                    }
                });
                const sortedDates = Array.from(dateSet).sort();
                let maxStreak = 0;
                let currentStreak = 1;
                for (let i = 1; i < sortedDates.length; i++) {
                    const prev = new Date(sortedDates[i - 1]);
                    const curr = new Date(sortedDates[i]);
                    const dayDiff = Math.floor((curr - prev) / (1000 * 60 * 60 * 24));
                    if (dayDiff === 1) {
                        currentStreak++;
                        maxStreak = Math.max(maxStreak, currentStreak);
                    } else {
                        currentStreak = 1;
                    }
                }
                document.getElementById('listeningStreak').textContent = `${maxStreak} days`;
                
                console.log('âœ… Quick stats calculated');
            } catch (error) {
                console.error('Error calculating quick stats:', error);
                document.getElementById('mostActiveDay').textContent = '-';
                document.getElementById('peakHour').textContent = '-';
                document.getElementById('avgSongLength').textContent = '-';
                document.getElementById('listeningStreak').textContent = '-';
            }
        }

        // Date slider functions
        function initializeDateSliders() {
            // Find min and max dates from data
            const dates = allStreamsData
                .filter(s => s.ts)
                .map(s => new Date(s.ts))
                .filter(d => !isNaN(d.getTime()));
            
            if (dates.length === 0) {
                console.error('No valid dates found in data');
                return;
            }
            
            minDate = new Date(Math.min(...dates));
            maxDate = new Date(Math.max(...dates));
            
            console.log('Date range:', minDate, 'to', maxDate);
            
            // Set up sliders
            setupPeriodSlider('period1', 0, 33);
            setupPeriodSlider('period2', 67, 100);
        }

        function setupPeriodSlider(periodId, defaultStart, defaultEnd) {
            const startSlider = document.getElementById(periodId + 'StartSlider');
            const endSlider = document.getElementById(periodId + 'EndSlider');
            const display = document.getElementById(periodId + 'Display');
            const range = document.getElementById(periodId + 'Range');
            
            if (!startSlider || !endSlider) return;
            
            startSlider.value = defaultStart;
            endSlider.value = defaultEnd;
            

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // UPDATESLIDER
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function updateSlider() {
                let start = parseInt(startSlider.value);
                let end = parseInt(endSlider.value);
                
                // Ensure start is always before end
                if (start >= end) {
                    if (this === startSlider) {
                        startSlider.value = end - 1;
                        start = end - 1;
                    } else {
                        endSlider.value = start + 1;
                        end = start + 1;
                    }
                }
                
                // Update visual range
                range.style.left = start + '%';
                range.style.width = (end - start) + '%';
                
                // Calculate actual dates
                const totalMs = maxDate - minDate;
                const startDate = new Date(minDate.getTime() + (totalMs * start / 100));
                const endDate = new Date(minDate.getTime() + (totalMs * end / 100));
                
                // Update display
                display.textContent = formatDateRange(startDate, endDate);
            }
            
            startSlider.addEventListener('input', updateSlider);
            endSlider.addEventListener('input', updateSlider);
            
            updateSlider();
        }

        function formatDateRange(start, end) {
            const options = { month: 'short', year: 'numeric' };
            return start.toLocaleDateString('en-US', options) + ' - ' + end.toLocaleDateString('en-US', options);
        }

        function getDateFromSlider(sliderId) {
            const slider = document.getElementById(sliderId);
            if (!slider) return null;
            
            const percent = parseInt(slider.value);
            const totalMs = maxDate - minDate;
            return new Date(minDate.getTime() + (totalMs * percent / 100));
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CALCULATEADVANCEDANALYTICS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function calculateAdvancedAnalytics() {
            // Decade analysis - estimate from track names/artists
            const decades = {
                '1960s': 0, '1970s': 0, '1980s': 0, '1990s': 0,
                '2000s': 0, '2010s': 0, '2020s': 0, 'Unknown': 0
            };
            
            allStreamsData.forEach(stream => {
                if (!stream.ms_played || stream.ms_played < 30000) return;
                
                const combined = ((stream.master_metadata_track_name || '') + ' ' + 
                                 (stream.master_metadata_album_artist_name || '')).toLowerCase();
                
                // Simple heuristic based on artist era patterns
                if (combined.match(/\b(beatles|stones|hendrix|zeppelin|pink floyd|queen early)\b/)) {
                    decades['1960s']++;
                } else if (combined.match(/\b(disco|bee gees|abba|donna summer|fleetwood)\b/)) {
                    decades['1970s']++;
                } else if (combined.match(/\b(madonna|michael jackson|prince|80s|eighties|synth)\b/)) {
                    decades['1980s']++;
                } else if (combined.match(/\b(nirvana|grunge|90s|nineties|britpop|tupac|biggie)\b/)) {
                    decades['1990s']++;
                } else if (combined.match(/\b(2000s|eminem early|50 cent|linkin park|coldplay early)\b/)) {
                    decades['2000s']++;
                } else if (combined.match(/\b(2010s|2011|2012|2013|2014|2015|2016|2017|2018|2019)\b/)) {
                    decades['2010s']++;
                } else if (combined.match(/\b(2020|2021|2022|2023|2024|2025)\b/)) {
                    decades['2020s']++;
                } else {
                    // Default to 2010s/2020s for modern music
                    decades['2020s']++;
                }
            });

            const maxDecade = Object.entries(decades)
                .filter(([d]) => d !== 'Unknown')
                .sort((a, b) => b[1] - a[1])[0];
            
            if (maxDecade) {
                document.getElementById('favoriteDecade').textContent = maxDecade[0];
                const total = Object.values(decades).reduce((a, b) => a + b, 0);
                document.getElementById('decadeStats').textContent = `${((maxDecade[1] / total) * 100).toFixed(1)}% of listening`;
                
                // Time traveler score (entropy-based)
                const nonZero = Object.values(decades).filter(v => v > 0).length;
                document.getElementById('timeTravelerScore').textContent = `${Math.min(nonZero * 14, 100)}`;
                
                document.getElementById('modernFan').textContent = `${((decades['2020s'] / total) * 100).toFixed(1)}%`;
                const vintage = (decades['1960s'] + decades['1970s'] + decades['1980s'] + decades['1990s']) / total * 100;
                document.getElementById('vintageScore').textContent = `${vintage.toFixed(1)}%`;
            }

            // Song obsessions (songs with high play count)
            const { trackStats } = analyzeStreams(allStreamsData);
            const obsessions = Object.values(trackStats)
                .filter(t => t.playCount >= 10)
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 20);
            
            const obsessionsList = document.getElementById('obsessionsList');
            obsessionsList.innerHTML = '';
            obsessions.forEach((song, index) => {
                const li = document.createElement('li');
                li.className = 'song-item';
                li.innerHTML = `
                    <span class="rank">${index + 1}</span>
                    <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px); margin-left: 10px;">
                        <div class="song-name">${song.track}</div>
                        <div class="artist-name">${song.artist}</div>
                        <div class="stats">ğŸ”¥ ${song.playCount} plays â€¢ â±ï¸ ${(song.totalMs / (1000 * 60 * 60)).toFixed(2)}h total</div>
                    </div>
                `;
                obsessionsList.appendChild(li);
            });

            // Language/region analysis
            const { genreStats } = analyzeStreams(allStreamsData);
            const total = allStreamsData.filter(s => s.ms_played >= 30000).length;
            
            const latin = (genreStats['Reggaeton']?.playCount || 0) + 
                         (genreStats['Latin Pop']?.playCount || 0) +
                         (genreStats['Latin Trap']?.playCount || 0) +
                         (genreStats['Salsa']?.playCount || 0);
            const kpop = genreStats['K-Pop']?.playCount || 0;
            
            document.getElementById('spanishPercent').textContent = `${((latin / total) * 100).toFixed(1)}%`;
            document.getElementById('kpopPercent').textContent = `${((kpop / total) * 100).toFixed(1)}%`;
            document.getElementById('englishPercent').textContent = `${(((total - latin - kpop) / total) * 100).toFixed(1)}%`;
            
            const languageScore = (latin > 0 ? 30 : 0) + (kpop > 0 ? 30 : 0) + 40;
            document.getElementById('globalScore').textContent = languageScore;
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CALCULATECOMPARISONS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function calculateComparisons() {
            // Work vs Leisure
            const workHours = { count: 0, genres: {} };
            const leisureHours = { count: 0, genres: {} };
            
            allStreamsData.forEach(stream => {
                if (!stream.ts || !stream.ms_played || stream.ms_played < 30000) return;
                
                const hour = new Date(stream.ts).getHours();
                const genre = categorizeGenre(stream);
                
                if (hour >= 9 && hour < 17) {
                    workHours.count++;
                    workHours.genres[genre] = (workHours.genres[genre] || 0) + 1;
                } else {
                    leisureHours.count++;
                    leisureHours.genres[genre] = (leisureHours.genres[genre] || 0) + 1;
                }
            });

            document.getElementById('workHoursStreams').textContent = workHours.count.toLocaleString();
            document.getElementById('leisureHoursStreams').textContent = leisureHours.count.toLocaleString();
            
            const workTopGenre = Object.entries(workHours.genres)
                .filter(([g]) => g !== 'Uncategorized')
                .sort((a, b) => b[1] - a[1])[0];
            const leisureTopGenre = Object.entries(leisureHours.genres)
                .filter(([g]) => g !== 'Uncategorized')
                .sort((a, b) => b[1] - a[1])[0];
            
            if (workTopGenre) document.getElementById('workHoursTop').textContent = workTopGenre[0];
            if (leisureTopGenre) document.getElementById('leisureHoursTop').textContent = leisureTopGenre[0];
            
            const ratio = (workHours.count / leisureHours.count).toFixed(2);
            document.getElementById('workLifeRatio').textContent = `1:${ratio}`;

            // Work soundtrack
            const workTracks = {};
            allStreamsData.forEach(stream => {
                if (!stream.ts || !stream.ms_played || stream.ms_played < 30000) return;
                const hour = new Date(stream.ts).getHours();
                if (hour >= 9 && hour < 17) {
                    const key = stream.master_metadata_track_name;
                    workTracks[key] = (workTracks[key] || 0) + 1;
                }
            });
            const topWorkTrack = Object.entries(workTracks).sort((a, b) => b[1] - a[1])[0];
            if (topWorkTrack) {
                document.getElementById('workSoundtrack').textContent = topWorkTrack[0].substring(0, 20);
            }

            // Weekday vs Weekend genres
            const weekday = { genres: {} };
            const weekend = { genres: {} };
            
            allStreamsData.forEach(stream => {
                if (!stream.ts || !stream.ms_played || stream.ms_played < 30000) return;
                
                const day = new Date(stream.ts).getDay();
                const genre = categorizeGenre(stream);
                
                if (day >= 1 && day <= 5) {
                    weekday.genres[genre] = (weekday.genres[genre] || 0) + 1;
                } else {
                    weekend.genres[genre] = (weekend.genres[genre] || 0) + 1;
                }
            });

            const weekdayTop = Object.entries(weekday.genres)
                .filter(([g]) => g !== 'Uncategorized')
                .sort((a, b) => b[1] - a[1])[0];
            const weekendTop = Object.entries(weekend.genres)
                .filter(([g]) => g !== 'Uncategorized')
                .sort((a, b) => b[1] - a[1])[0];
            
            if (weekdayTop) {
                document.getElementById('weekdayTopGenre').textContent = weekdayTop[0];
                document.getElementById('weekdayGenreStats').textContent = `${weekdayTop[1]} plays`;
            }
            if (weekendTop) {
                document.getElementById('weekendTopGenre').textContent = weekendTop[0];
                document.getElementById('weekendGenreStats').textContent = `${weekendTop[1]} plays`;
            }
            
            document.getElementById('weekdayDiversity').textContent = Object.keys(weekday.genres).length;
            document.getElementById('weekendDiversity').textContent = Object.keys(weekend.genres).length;
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CALCULATEDEEPINSIGHTS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function calculateDeepInsights() {
            const validStreams = allStreamsData.filter(s => s.ms_played >= 30000);
            const allStreams = allStreamsData;
            
            // Energy & Mood Patterns
            const nightStreams = validStreams.filter(s => {
                if (!s.ts) return false;
                const hour = new Date(s.ts).getHours();
                return hour >= 22 || hour < 6;
            });
            
            const earlyStreams = validStreams.filter(s => {
                if (!s.ts) return false;
                const hour = new Date(s.ts).getHours();
                return hour >= 5 && hour < 8;
            });
            
            document.getElementById('nightOwlScore').textContent = 
                `${((nightStreams.length / validStreams.length) * 100).toFixed(1)}%`;
            document.getElementById('earlyBirdScore').textContent = 
                `${((earlyStreams.length / validStreams.length) * 100).toFixed(1)}%`;
            
            // Calculate energy based on listening patterns
            const avgPlaysPerSong = validStreams.length / Object.keys(analyzeStreams(validStreams).trackStats).length;
            const energyScore = Math.min(100, avgPlaysPerSong * 10).toFixed(0);
            document.getElementById('avgEnergy').textContent = `${energyScore}/100`;
            
            // Mood variety (based on genre diversity)
            const { genreStats } = analyzeStreams(validStreams);
            const moodScore = Math.min(100, Object.keys(genreStats).length * 5).toFixed(0);
            document.getElementById('moodVariety').textContent = `${moodScore}/100`;
            
            // Skip Behavior Analysis
            const skippedStreams = allStreams.filter(s => s.ms_played < 30000);
            const quickSkips = allStreams.filter(s => s.ms_played < 10000);
            const completedStreams = validStreams.filter(s => s.ms_played > 180000); // >3 minutes
            
            document.getElementById('skipRate').textContent = 
                `${((skippedStreams.length / allStreams.length) * 100).toFixed(1)}%`;
            document.getElementById('completionRate').textContent = 
                `${((completedStreams.length / allStreams.length) * 100).toFixed(1)}%`;
            document.getElementById('quickSkips').textContent = quickSkips.length.toLocaleString();
            
            // Find perfect songs (never skipped)
            const { trackStats } = analyzeStreams(allStreams);
            const perfectSongs = Object.values(trackStats).filter(t => {
                const allPlays = allStreams.filter(s => 
                    s.master_metadata_track_name === t.track && 
                    s.master_metadata_album_artist_name === t.artist
                );
                return allPlays.length > 0 && allPlays.every(p => p.ms_played >= 30000);
            }).length;
            document.getElementById('perfectSongs').textContent = perfectSongs.toLocaleString();
            
            // Diversity & Variety
            const { artistStats } = analyzeStreams(validStreams);
            const uniqueArtists = Object.keys(artistStats).length;
            const uniqueTracks = Object.keys(trackStats).length;
            
            // Calculate diversity score (0-100)
            const diversityScore = Math.min(100, 
                (uniqueArtists / validStreams.length * 1000) + 
                (uniqueTracks / validStreams.length * 500)
            ).toFixed(0);
            document.getElementById('diversityScore').textContent = `${diversityScore}/100`;
            
            // Repeat rate (top 10 songs)
            const top10 = Object.values(trackStats)
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 10);
            const top10Plays = top10.reduce((sum, t) => sum + t.playCount, 0);
            document.getElementById('repeatRate').textContent = 
                `${((top10Plays / validStreams.length) * 100).toFixed(1)}%`;
            
            // Discovery rate (new songs per week)
            const daysOfData = (maxDate - minDate) / (1000 * 60 * 60 * 24);
            const weeksOfData = daysOfData / 7;
            const discoveryRate = (uniqueTracks / weeksOfData).toFixed(1);
            document.getElementById('discoveryRate').textContent = discoveryRate;
            
            // Focus level (how concentrated on few artists)
            const top3Artists = Object.values(artistStats)
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 3);
            const top3Plays = top3Artists.reduce((sum, a) => sum + a.playCount, 0);
            const focusLevel = ((top3Plays / validStreams.length) * 100).toFixed(0);
            document.getElementById('focusLevel').textContent = `${focusLevel}/100`;
            
            // Binge Sessions
            calculateBingeSessions();
            
            // Monthly Breakdown
            calculateMonthlyBreakdown();
            
            // Create new charts
            createSkipChart(skippedStreams.length, completedStreams.length, quickSkips.length);
            createLoyaltyChart();
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CALCULATEBINGESESSIONS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function calculateBingeSessions() {
            // Find continuous listening sessions
            const sortedStreams = allStreamsData
                .filter(s => s.ts && s.ms_played >= 30000)
                .sort((a, b) => new Date(a.ts) - new Date(b.ts));
            
            const sessions = [];
            let currentSession = null;
            
            sortedStreams.forEach(stream => {
                const streamTime = new Date(stream.ts);
                
                if (!currentSession || streamTime - currentSession.end > 30 * 60 * 1000) { // 30 min gap
                    if (currentSession) sessions.push(currentSession);
                    currentSession = {
                        start: streamTime,
                        end: streamTime,
                        count: 1,
                        duration: stream.ms_played
                    };
                } else {
                    currentSession.end = streamTime;
                    currentSession.count++;
                    currentSession.duration += stream.ms_played;
                }
            });
            if (currentSession) sessions.push(currentSession);
            
            // Get top 5 longest sessions
            const top5 = sessions
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);
            
            const html = top5.map((session, i) => {
                const hours = (session.duration / (1000 * 60 * 60)).toFixed(1);
                const dateStr = session.start.toLocaleDateString('en-US', { 
                    month: 'short', day: 'numeric', year: 'numeric' 
                });
                return `
                    <div style="background: rgba(255,255,255,0.7); padding: 15px; border-radius: 12px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #667eea; font-size: 1.2em;">#${i + 1}</strong>
                                <span style="margin-left: 10px; color: var(--text-primary);">${dateStr}</span>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.1em; font-weight: bold; color: #333;">
                                    ${session.count} songs â€¢ ${hours}h
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('bingeSessions').innerHTML = html || '<p style="color: #999;">No long sessions found</p>';
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CALCULATEMONTHLYBREAKDOWN
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function calculateMonthlyBreakdown() {
            const monthlyData = {};
            
            allStreamsData.forEach(stream => {
                if (!stream.ts || !stream.ms_played || stream.ms_played < 30000) return;
                
                const date = new Date(stream.ts);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        tracks: {},
                        artists: {},
                        count: 0
                    };
                }
                
                monthlyData[monthKey].count++;
                
                const track = stream.master_metadata_track_name || 'Unknown';
                const artist = stream.master_metadata_album_artist_name || 'Unknown';
                
                monthlyData[monthKey].tracks[track] = (monthlyData[monthKey].tracks[track] || 0) + 1;
                monthlyData[monthKey].artists[artist] = (monthlyData[monthKey].artists[artist] || 0) + 1;
            });
            
            const html = Object.entries(monthlyData)
                .sort((a, b) => b[0].localeCompare(a[0]))
                .slice(0, 12)
                .map(([month, data]) => {
                    const topTrack = Object.entries(data.tracks)
                        .sort((a, b) => b[1] - a[1])[0];
                    const topArtist = Object.entries(data.artists)
                        .sort((a, b) => b[1] - a[1])[0];
                    
                    const date = new Date(month + '-01');
                    const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    
                    return `
                        <div style="background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7)); padding: 20px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid #667eea;">
                            <h4 style="color: #667eea; margin-bottom: 10px;">${monthName}</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <p style="color: #999; font-size: 0.9em; margin-bottom: 5px;">ğŸ† Top Song</p>
                                    <p style="font-weight: 600;">${topTrack[0]}</p>
                                    <p style="color: var(--text-primary); font-size: 0.9em;">${topTrack[1]} plays</p>
                                </div>
                                <div>
                                    <p style="color: #999; font-size: 0.9em; margin-bottom: 5px;">ğŸ‘‘ Top Artist</p>
                                    <p style="font-weight: 600;">${topArtist[0]}</p>
                                    <p style="color: var(--text-primary); font-size: 0.9em;">${topArtist[1]} plays</p>
                                </div>
                            </div>
                            <p style="margin-top: 10px; color: #999; font-size: 0.9em;">
                                ğŸ“Š ${data.count.toLocaleString()} total streams
                            </p>
                        </div>
                    `;
                }).join('');
            
            document.getElementById('monthlyBreakdown').innerHTML = html || '<p style="color: #999;">No monthly data available</p>';
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATESKIPCHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createSkipChart(skipped, completed, quickSkips) {
            const ctx = document.getElementById('skipChart').getContext('2d');
            if (charts.skip) charts.skip.destroy();
            
            charts.skip = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['âœ… Completed', 'â­ï¸ Skipped', 'âš¡ Quick Skips'],
                    datasets: [{
                        data: [completed, skipped - quickSkips, quickSkips],
                        backgroundColor: ['#4ade80', '#f97316', '#ef4444'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'â­ï¸ Skip Behavior Distribution',
                            font: { size: 18, weight: 'bold' },
                            color: '#333'
                        },
                        legend: { position: 'right' }
                    }
                }
            });
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATELOYALTYCHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createLoyaltyChart() {
            const { artistStats } = analyzeStreams(allStreamsData.filter(s => s.ms_played >= 30000));
            const topArtists = Object.values(artistStats)
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 10);
            
            const ctx = document.getElementById('loyaltyChart').getContext('2d');
            if (charts.loyalty) charts.loyalty.destroy();
            
            charts.loyalty = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topArtists.map(a => a.artist),
                    datasets: [{
                        label: 'Plays',
                        data: topArtists.map(a => a.playCount),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ğŸ† Artist Loyalty Rankings',
                            font: { size: 18, weight: 'bold' },
                            color: '#333'
                        },
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(`${sectionName}-section`).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Lazy load section data if not already loaded
            if (!window.sectionsLoaded) window.sectionsLoaded = {};
            
            if (!window.sectionsLoaded[sectionName]) {
                loadSectionData(sectionName);
                window.sectionsLoaded[sectionName] = true;
            }
        }

        function loadSectionData(sectionName) {
            console.log('Loading section:', sectionName);
            
            switch(sectionName) {
                case 'achievements':
                    displayAchievements();
                    break;
                case 'heatmap':
                    populateHeatmapYears();
                    break;
                case 'comparison':
                    populateYearSelectors();
                    break;
                case 'share':
                    // No initial load needed, cards generate on button click
                    break;
                case 'charts':
                    console.log('Loading charts section - creating timeline...');
                    createTimelineChart();
                    break;
                case 'songs':
                    updateSongDisplay();
                    break;
                case 'artists':
                    updateArtistDisplay();
                    break;
                case 'genres':
                    updateGenreDisplay();
                    createGenreCharts();
                    break;
                case 'habits':
                    calculateListeningHabits();
                    createHabitsCharts();
                    break;
                case 'discovery':
                    calculateDiscoveryMetrics();
                    createDiscoveryCharts();
                    break;
                case 'advanced':
                    calculateAdvancedAnalytics();
                    createAdvancedCharts();
                    break;
                case 'compare':
                    calculateComparisons();
                    createComparisonCharts();
                    break;
                case 'insights':
                    calculateDeepInsights();
                    break;
                case 'tools':
                    populateGenreDropdown();
                    break;
            }
        }
        
        function populateGenreDropdown() {
            const analysis = getCachedAnalysis();
            const genres = Object.keys(analysis.genreStats)
                .filter(g => g !== 'Uncategorized')
                .sort();
            
            const dropdown = document.getElementById('quickFindGenre');
            if (dropdown && dropdown.options.length === 1) { // Only populate once
                genres.forEach(genre => {
                    const option = document.createElement('option');
                    option.value = genre;
                    option.textContent = genre;
                    dropdown.appendChild(option);
                });
            }
        }

        function showGenreFilter() {
            // Populate genre checkboxes if not already done
            if (allAvailableGenres.length === 0) {
                const { genreStats } = analyzeStreams(allStreamsData);
                allAvailableGenres = Object.keys(genreStats).sort();
            }

            const checkboxContainer = document.getElementById('genreCheckboxes');
            checkboxContainer.innerHTML = '';
            
            allAvailableGenres.forEach(genre => {
                const isChecked = !filteredGenres.has(genre);
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.cssText = 'display: flex; align-items: center; padding: 8px; background: rgba(102, 126, 234, 0.05); border-radius: 8px; transition: all 0.2s;';
                checkboxDiv.onmouseover = function() { this.style.background = 'rgba(102, 126, 234, 0.15)'; };
                checkboxDiv.onmouseout = function() { this.style.background = 'rgba(102, 126, 234, 0.05)'; };
                
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="genre-${genre.replace(/\s+/g, '-')}" 
                           ${isChecked ? 'checked' : ''} 
                           style="margin-right: 8px; cursor: pointer; width: 18px; height: 18px;">
                    <label for="genre-${genre.replace(/\s+/g, '-')}" 
                           style="cursor: pointer; flex: 1; font-size: 0.9em;">${genre}</label>
                `;
                
                checkboxContainer.appendChild(checkboxDiv);
            });

            document.getElementById('genreFilterModal').style.display = 'block';
        }

        function hideGenreFilter() {
            document.getElementById('genreFilterModal').style.display = 'none';
        }

        function selectAllGenres() {
            allAvailableGenres.forEach(genre => {
                const checkbox = document.getElementById(`genre-${genre.replace(/\s+/g, '-')}`);
                if (checkbox) checkbox.checked = true;
            });
        }

        function deselectAllGenres() {
            allAvailableGenres.forEach(genre => {
                const checkbox = document.getElementById(`genre-${genre.replace(/\s+/g, '-')}`);
                if (checkbox) checkbox.checked = false;
            });
        }

        function applyGenreFilter() {
            // Update filteredGenres set with unchecked genres
            filteredGenres.clear();
            
            allAvailableGenres.forEach(genre => {
                const checkbox = document.getElementById(`genre-${genre.replace(/\s+/g, '-')}`);
                if (checkbox && !checkbox.checked) {
                    filteredGenres.add(genre);
                }
            });

            // Update all genre charts
            updateGenreChart();
            if (charts.genreTrend) {
                charts.genreTrend.destroy();
                createGenreTrendChart();
            }
            if (charts.genreTime) {
                charts.genreTime.destroy();
                createGenreTimeChart();
            }

            hideGenreFilter();
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CALCULATEINSIGHTS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function calculateInsights() {
            const analysis = analyzeStreams(allStreamsData);
            
            // Genre insights - filter out Uncategorized
            const genreArray = Object.values(analysis.genreStats)
                .filter(g => g.genre !== 'Uncategorized')
                .map(g => ({
                    ...g,
                    uniqueArtists: g.artists.size,
                    uniqueTracks: g.tracks.size
                }))
                .sort((a, b) => b.playCount - a.playCount);
            
            if (genreArray.length > 0) {
                const topGenre = genreArray[0];
                document.getElementById('topGenre').textContent = topGenre.genre;
                document.getElementById('topGenreStats').textContent = `${topGenre.playCount} plays â€¢ ${(topGenre.totalMs / (1000 * 60 * 60)).toFixed(1)}h`;
                
                document.getElementById('totalGenres').textContent = genreArray.length;
                
                // Genre diversity (inverse of concentration)
                const totalPlays = genreArray.reduce((sum, g) => sum + g.playCount, 0);
                const topGenrePercentage = (topGenre.playCount / totalPlays * 100);
                const diversityScore = (100 - topGenrePercentage).toFixed(1);
                document.getElementById('genreDiversity').textContent = `${diversityScore}%`;
                
                // Genre with most artists
                const genreChampion = genreArray.sort((a, b) => b.uniqueArtists - a.uniqueArtists)[0];
                document.getElementById('genreChampion').textContent = genreChampion.genre;
            }
            
            // Most active day
            const weekdayData = Array(7).fill(0);
            const weekdayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            allStreamsData.forEach(stream => {
                if (stream.ts && stream.ms_played >= 30000) {
                    const date = new Date(stream.ts);
                    weekdayData[date.getDay()]++;
                }
            });
            const maxDay = Math.max(...weekdayData);
            const mostActiveDay = weekdayNames[weekdayData.indexOf(maxDay)];
            document.getElementById('mostActiveDay').textContent = mostActiveDay;
            
            // Peak hour
            const hourlyData = Array(24).fill(0);
            allStreamsData.forEach(stream => {
                if (stream.ts && stream.ms_played >= 30000) {
                    const date = new Date(stream.ts);
                    hourlyData[date.getHours()]++;
                }
            });
            const maxHour = Math.max(...hourlyData);
            const peakHour = hourlyData.indexOf(maxHour);
            document.getElementById('peakHour').textContent = `${peakHour}:00`;
            
            // Average song length
            const totalMs = allStreamsData.reduce((sum, s) => sum + (s.ms_played || 0), 0);
            const avgMs = totalMs / allStreamsData.filter(s => s.ms_played >= 30000).length;
            const avgMins = (avgMs / (1000 * 60)).toFixed(1);
            document.getElementById('avgSongLength').textContent = `${avgMins}m`;
            
            // Listening streak
            const dates = new Set();
            allStreamsData.forEach(stream => {
                if (stream.ts && stream.ms_played >= 30000) {
                    const date = stream.ts.split('T')[0];
                    dates.add(date);
                }
            });
            document.getElementById('listeningStreak').textContent = `${dates.size} days`;
            
            // Top artist
            const topArtist = Object.values(analysis.artistStats).sort((a, b) => b.playCount - a.playCount)[0];
            if (topArtist) {
                document.getElementById('topArtistName').textContent = topArtist.artist.substring(0, 20) + (topArtist.artist.length > 20 ? '...' : '');
                document.getElementById('topArtistStats').textContent = `${topArtist.playCount} plays â€¢ ${(topArtist.totalMs / (1000 * 60 * 60)).toFixed(1)}h`;
            }
            
            // Top song
            const topSong = Object.values(analysis.trackStats).sort((a, b) => b.playCount - a.playCount)[0];
            if (topSong) {
                document.getElementById('topSongName').textContent = topSong.track.substring(0, 20) + (topSong.track.length > 20 ? '...' : '');
                document.getElementById('topSongStats').textContent = `${topSong.playCount} plays â€¢ ${topSong.artist}`;
            }
            
            // Diversity score (unique artists / total streams * 100)
            const diversityScore = (Object.keys(analysis.artistStats).length / allStreamsData.length * 1000).toFixed(1);
            document.getElementById('diversityScore').textContent = `${diversityScore}%`;
            
            // Night owl score
            let nightStreams = 0;
            allStreamsData.forEach(stream => {
                if (stream.ts && stream.ms_played >= 30000) {
                    const hour = new Date(stream.ts).getHours();
                    if (hour >= 22 || hour <= 4) nightStreams++;
                }
            });
            const nightOwlScore = (nightStreams / allStreamsData.filter(s => s.ms_played >= 30000).length * 100).toFixed(1);
            document.getElementById('nightOwlScore').textContent = `${nightOwlScore}%`;
            
            // Most active month
            const monthlyData = {};
            allStreamsData.forEach(stream => {
                if (stream.ts && stream.ms_played >= 30000) {
                    const date = new Date(stream.ts);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
                }
            });
            const maxMonth = Object.entries(monthlyData).sort((a, b) => b[1] - a[1])[0];
            if (maxMonth) {
                const [year, month] = maxMonth[0].split('-');
                const date = new Date(year, month - 1);
                const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                document.getElementById('mostActiveMonth').textContent = monthName;
                document.getElementById('mostActiveMonthStats').textContent = `${maxMonth[1]} streams`;
            }
            
            // Longest session (placeholder - would need more complex calculation)
            document.getElementById('longestSession').textContent = '12h+';
            
            // Discovery rate
            const artistsByMonth = {};
            allStreamsData.forEach(stream => {
                if (stream.ts && stream.ms_played >= 30000 && stream.master_metadata_album_artist_name) {
                    const date = new Date(stream.ts);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!artistsByMonth[monthKey]) artistsByMonth[monthKey] = new Set();
                    artistsByMonth[monthKey].add(stream.master_metadata_album_artist_name);
                }
            });
            const avgNewArtists = Object.values(artistsByMonth).reduce((sum, set) => sum + set.size, 0) / Object.keys(artistsByMonth).length;
            document.getElementById('discoveryRate').textContent = avgNewArtists.toFixed(0);
            
            // Replay value
            const totalTracks = Object.keys(analysis.trackStats).length;
            const avgPlaysPerSong = (allStreamsData.filter(s => s.ms_played >= 30000).length / totalTracks).toFixed(1);
            document.getElementById('replayValue').textContent = `${avgPlaysPerSong}x`;
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CALCULATELISTENINGHABITS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function calculateListeningHabits() {
            // Time of day analysis
            const timeRanges = {
                morning: 0,    // 6am-12pm
                afternoon: 0,  // 12pm-6pm
                evening: 0,    // 6pm-10pm
                night: 0       // 10pm-6am
            };

            allStreamsData.forEach(stream => {
                if (!stream.ts || !stream.ms_played || stream.ms_played < 30000) return;
                
                const hour = new Date(stream.ts).getHours();
                if (hour >= 6 && hour < 12) timeRanges.morning++;
                else if (hour >= 12 && hour < 18) timeRanges.afternoon++;
                else if (hour >= 18 && hour < 22) timeRanges.evening++;
                else timeRanges.night++;
            });

            const total = Object.values(timeRanges).reduce((a, b) => a + b, 0);
            document.getElementById('morningScore').textContent = `${((timeRanges.morning / total) * 100).toFixed(1)}%`;
            document.getElementById('afternoonScore').textContent = `${((timeRanges.afternoon / total) * 100).toFixed(1)}%`;
            document.getElementById('eveningScore').textContent = `${((timeRanges.evening / total) * 100).toFixed(1)}%`;
            document.getElementById('nightOwlHabits').textContent = `${((timeRanges.night / total) * 100).toFixed(1)}%`;

            // Seasonal analysis
            const seasons = { spring: {}, summer: {}, fall: {}, winter: {} };
            
            allStreamsData.forEach(stream => {
                if (!stream.ts || !stream.ms_played || stream.ms_played < 30000) return;
                
                const date = new Date(stream.ts);
                const month = date.getMonth();
                const genre = categorizeGenre(stream);
                
                let season;
                if (month >= 2 && month <= 4) season = 'spring';
                else if (month >= 5 && month <= 7) season = 'summer';
                else if (month >= 8 && month <= 10) season = 'fall';
                else season = 'winter';
                
                if (!seasons[season][genre]) seasons[season][genre] = 0;
                seasons[season][genre]++;
            });

            ['spring', 'summer', 'fall', 'winter'].forEach(season => {
                const genreEntries = Object.entries(seasons[season]).filter(([g]) => g !== 'Uncategorized');
                const totalStreams = genreEntries.reduce((sum, [, count]) => sum + count, 0);
                const topGenre = genreEntries.sort((a, b) => b[1] - a[1])[0];
                
                document.getElementById(`${season}Streams`).textContent = totalStreams.toLocaleString();
                if (topGenre) {
                    document.getElementById(`${season}TopGenre`).textContent = topGenre[0];
                }
            });

            // Session analysis
            const sessions = [];
            let currentSession = null;
            const sortedStreams = [...allStreamsData]
                .filter(s => s.ts && s.ms_played >= 30000)
                .sort((a, b) => new Date(a.ts) - new Date(b.ts));

            sortedStreams.forEach(stream => {
                const streamTime = new Date(stream.ts);
                
                if (!currentSession || (streamTime - currentSession.endTime) > 30 * 60 * 1000) {
                    // New session (gap > 30 minutes)
                    if (currentSession) sessions.push(currentSession);
                    currentSession = {
                        startTime: streamTime,
                        endTime: new Date(streamTime.getTime() + stream.ms_played),
                        duration: stream.ms_played,
                        streams: 1
                    };
                } else {
                    // Continue current session
                    currentSession.endTime = new Date(streamTime.getTime() + stream.ms_played);
                    currentSession.duration = currentSession.endTime - currentSession.startTime;
                    currentSession.streams++;
                }
            });
            if (currentSession) sessions.push(currentSession);

            const avgSession = sessions.reduce((sum, s) => sum + s.duration, 0) / sessions.length;
            const longestSession = Math.max(...sessions.map(s => s.duration));
            
            document.getElementById('avgSession').textContent = `${(avgSession / (1000 * 60)).toFixed(0)}min`;
            document.getElementById('longestSessionReal').textContent = `${(longestSession / (1000 * 60 * 60)).toFixed(1)}h`;

            // Consistency score
            const dates = new Set(sortedStreams.map(s => s.ts.split('T')[0]));
            const activeDaysCount = dates.size;
            const firstDate = new Date(sortedStreams[0].ts);
            const lastDate = new Date(sortedStreams[sortedStreams.length - 1].ts);
            const totalDays = Math.ceil((lastDate - firstDate) / (1000 * 60 * 60 * 24));
            const consistency = (activeDaysCount / totalDays * 100).toFixed(0);
            
            document.getElementById('consistencyScore').textContent = `${consistency}`;
            document.getElementById('activeDays').textContent = `${activeDaysCount}`;
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CALCULATEDISCOVERYMETRICS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function calculateDiscoveryMetrics() {
            const { artistStats, trackStats } = analyzeStreams(allStreamsData);
            
            // Track when each artist/track was first discovered
            const artistFirstPlay = {};
            const trackFirstPlay = {};
            const monthlyNewArtists = {};
            const monthlyNewTracks = {};
            
            allStreamsData
                .filter(s => s.ts && s.ms_played >= 30000)
                .sort((a, b) => new Date(a.ts) - new Date(b.ts))
                .forEach(stream => {
                    const artist = stream.master_metadata_album_artist_name;
                    const track = stream.master_metadata_track_name;
                    const date = new Date(stream.ts);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (artist && !artistFirstPlay[artist]) {
                        artistFirstPlay[artist] = stream.ts;
                        if (!monthlyNewArtists[monthKey]) monthlyNewArtists[monthKey] = 0;
                        monthlyNewArtists[monthKey]++;
                    }
                    
                    if (track && artist && !trackFirstPlay[`${track}|||${artist}`]) {
                        trackFirstPlay[`${track}|||${artist}`] = stream.ts;
                        if (!monthlyNewTracks[monthKey]) monthlyNewTracks[monthKey] = 0;
                        monthlyNewTracks[monthKey]++;
                    }
                });

            // Calculate averages
            const months = Object.keys(monthlyNewArtists).length;
            const avgNewArtists = Object.values(monthlyNewArtists).reduce((a, b) => a + b, 0) / months;
            const avgNewTracks = Object.values(monthlyNewTracks).reduce((a, b) => a + b, 0) / months;
            
            document.getElementById('newArtistsRate').textContent = avgNewArtists.toFixed(1);
            document.getElementById('newTracksRate').textContent = avgNewTracks.toFixed(1);

            // Repeat ratio
            const uniqueTracks = Object.keys(trackStats).length;
            const totalStreams = allStreamsData.filter(s => s.ms_played >= 30000).length;
            const repeatRatio = ((totalStreams - uniqueTracks) / totalStreams * 100).toFixed(1);
            document.getElementById('repeatRatio').textContent = `${repeatRatio}%`;

            // Explorer score (inverse of repeat ratio)
            const explorerScore = (100 - parseFloat(repeatRatio)).toFixed(0);
            document.getElementById('explorerScore').textContent = explorerScore;

            // Artist loyalty
            const sortedArtists = Object.values(artistStats)
                .sort((a, b) => b.playCount - a.playCount);
            
            if (sortedArtists.length > 0) {
                const mostLoyal = sortedArtists[0];
                document.getElementById('mostLoyalArtist').textContent = mostLoyal.artist.substring(0, 20);
                const loyaltyPct = (mostLoyal.playCount / totalStreams * 100).toFixed(1);
                document.getElementById('loyaltyStats').textContent = `${loyaltyPct}% of all plays`;

                // Loyalty index (top 10 concentration)
                const top10Plays = sortedArtists.slice(0, 10).reduce((sum, a) => sum + a.playCount, 0);
                const loyaltyIndex = (top10Plays / totalStreams * 100).toFixed(0);
                document.getElementById('loyaltyIndex').textContent = `${loyaltyIndex}%`;
            }

            // Newest and oldest
            const artistsByFirst = Object.entries(artistFirstPlay).sort((a, b) => 
                new Date(b[1]) - new Date(a[1])
            );
            
            if (artistsByFirst.length > 0) {
                document.getElementById('newestArtist').textContent = artistsByFirst[0][0].substring(0, 20);
                document.getElementById('newestDate').textContent = new Date(artistsByFirst[0][1]).toLocaleDateString();
                
                document.getElementById('oldestArtist').textContent = artistsByFirst[artistsByFirst.length - 1][0].substring(0, 20);
                document.getElementById('oldestDate').textContent = new Date(artistsByFirst[artistsByFirst.length - 1][1]).toLocaleDateString();
            }

            // Recent discoveries (last 90 days)
            const ninetyDaysAgo = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000);
            const recentDiscoveries = artistsByFirst
                .filter(([artist, date]) => new Date(date) > ninetyDaysAgo)
                .slice(0, 20);
            
            const recentList = document.getElementById('recentArtists');
            recentList.innerHTML = '';
            recentDiscoveries.forEach(([artist, date], index) => {
                const plays = artistStats[artist]?.playCount || 0;
                const li = document.createElement('li');
                li.className = 'artist-item';
                li.innerHTML = `
                    <span class="rank">${index + 1}</span>
                    <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px); margin-left: 10px;">
                        <div class="song-name">${artist}</div>
                        <div class="stats">ğŸ“… Discovered: ${new Date(date).toLocaleDateString()} â€¢ â–¶ï¸ ${plays} plays since</div>
                    </div>
                `;
                recentList.appendChild(li);
            });
        }

        function populateYearFilters() {
            const years = new Set();
            
            allStreamsData.forEach(stream => {
                if (stream.ts) {
                    const year = stream.ts.substring(0, 4);
                    if (year && !isNaN(year)) {
                        years.add(year);
                    }
                }
            });

            const sortedYears = Array.from(years).sort().reverse();
            
            // Populate song year filter
            const songYearFilter = document.getElementById('songYearFilter');
            songYearFilter.innerHTML = '<option value="all">All Time</option>';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                songYearFilter.appendChild(option);
            });

            // Populate artist year filter
            const artistYearFilter = document.getElementById('artistYearFilter');
            artistYearFilter.innerHTML = '<option value="all">All Time</option>';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                artistYearFilter.appendChild(option);
            });

            // Populate genre year filter
            const genreYearFilter = document.getElementById('genreYearFilter');
            genreYearFilter.innerHTML = '<option value="all">All Time</option>';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                genreYearFilter.appendChild(option);
            });
        }

        function filterStreamsByYear(streams, year) {
            if (year === 'all') return streams;
            
            return streams.filter(stream => {
                if (!stream.ts) return false;
                return stream.ts.startsWith(year);
            });
        }

        /**
         * Core data analysis engine - processes stream data and generates statistics
         * 
         * This function analyzes all streaming records and generates comprehensive statistics
         * organized by tracks, artists, and genres. It calculates play counts, listening time,
         * and various metrics for each category.
         * 
         * @param {Array} streams - Array of stream objects from Spotify JSON files
         * @returns {Object} Analysis results containing:
         *   - trackStats: Object mapping track keys to track statistics
         *   - artistStats: Object mapping artist names to artist statistics
         *   - genreStats: Object mapping genres to genre statistics
         * 
         * @example
         * const results = analyzeStreams(allStreamsData);
         * console.log(results.trackStats); // All track statistics
         * console.log(results.artistStats); // All artist statistics
         */

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ANALYZESTREAMS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function analyzeStreams(streams) {
            // Initialize stat tracking objects
            const trackStats = {};    // Track-level statistics
            const artistStats = {};   // Artist-level statistics
            const genreStats = {};    // Genre-level statistics

            // Process each stream record
            streams.forEach(stream => {
                // Extract essential fields
                const trackName = stream.master_metadata_track_name;
                const artistName = stream.master_metadata_album_artist_name;
                const albumName = stream.master_metadata_album_album_name;
                const msPlayed = stream.ms_played || 0;
                const timestamp = stream.ts;
                
                // Categorize genre (basic heuristic since Spotify doesn't provide genre in stream data)
                let genre = 'Unknown';
                if (stream.spotify_track_uri) {
                    genre = categorizeGenre(stream);
                }

                // Skip invalid or very short plays (< 30 seconds)
                if (!trackName || !artistName || msPlayed < 30000) {
                    return;
                }

                // === TRACK STATISTICS ===
                // Use composite key to uniquely identify each track
                const trackKey = `${trackName}|||${artistName}`;
                if (!trackStats[trackKey]) {
                    trackStats[trackKey] = {
                        track: trackName,
                        artist: artistName,
                        album: albumName,
                        playCount: 0,           // Number of times played
                        totalMs: 0,             // Total listening time
                        firstPlayed: timestamp,  // First time played
                        lastPlayed: timestamp,   // Most recent play
                        playTimes: [],          // Array of all play durations
                        genre: genre
                    };
                }
                // Update track statistics
                trackStats[trackKey].playCount++;
                trackStats[trackKey].totalMs += msPlayed;
                trackStats[trackKey].playTimes.push(msPlayed);
                
                // Update date range
                if (timestamp < trackStats[trackKey].firstPlayed) {
                    trackStats[trackKey].firstPlayed = timestamp;
                }
                if (timestamp > trackStats[trackKey].lastPlayed) {
                    trackStats[trackKey].lastPlayed = timestamp;
                }

                // === ARTIST STATISTICS ===
                if (!artistStats[artistName]) {
                    artistStats[artistName] = {
                        artist: artistName,
                        playCount: 0,
                        totalMs: 0,
                        tracks: new Set(),  // Unique tracks by this artist
                        firstPlayed: timestamp,
                        lastPlayed: timestamp,
                        playTimes: [],
                        genres: new Set()
                    };
                }
                artistStats[artistName].playCount++;
                artistStats[artistName].totalMs += msPlayed;
                artistStats[artistName].tracks.add(trackName);
                artistStats[artistName].playTimes.push(msPlayed);
                artistStats[artistName].genres.add(genre);
                
                if (timestamp < artistStats[artistName].firstPlayed) {
                    artistStats[artistName].firstPlayed = timestamp;
                }
                if (timestamp > artistStats[artistName].lastPlayed) {
                    artistStats[artistName].lastPlayed = timestamp;
                }

                // Genre stats
                if (!genreStats[genre]) {
                    genreStats[genre] = {
                        genre: genre,
                        playCount: 0,
                        totalMs: 0,
                        artists: new Set(),
                        tracks: new Set()
                    };
                }
                genreStats[genre].playCount++;
                genreStats[genre].totalMs += msPlayed;
                genreStats[genre].artists.add(artistName);
                genreStats[genre].tracks.add(trackName);
            });

            // Calculate average play times
            Object.values(trackStats).forEach(track => {
                track.avgPlayTime = track.totalMs / track.playCount;
            });

            Object.values(artistStats).forEach(artist => {
                artist.avgPlayTime = artist.totalMs / artist.playCount;
            });

            return { trackStats, artistStats, genreStats, totalStreams: streams.length };
        }

        // Comprehensive genre categorization with 50+ micro-genres
        function categorizeGenre(stream) {
            const artistName = (stream.master_metadata_album_artist_name || '').toLowerCase();
            const trackName = (stream.master_metadata_track_name || '').toLowerCase();
            const combined = artistName + ' ' + trackName;
            
            // Electronic & Dance - Detailed breakdown
            if (combined.match(/\b(future bass|kawaii bass)\b/)) {
                return 'Future Bass';
            }
            if (combined.match(/\b(bass house|uk garage|garage)\b/)) {
                return 'Bass House/UK Garage';
            }
            if (combined.match(/\b(hardstyle|hardcore|happy hardcore)\b/)) {
                return 'Hardstyle/Hardcore';
            }
            if (combined.match(/\b(deep house|tropical house)\b/)) {
                return 'Deep/Tropical House';
            }
            if (combined.match(/\b(progressive house|big room)\b/)) {
                return 'Progressive House';
            }
            if (combined.match(/\b(techno|minimal techno)\b/)) {
                return 'Techno';
            }
            if (combined.match(/\b(trance|uplifting trance|psytrance)\b/)) {
                return 'Trance';
            }
            if (combined.match(/\b(dubstep|brostep)\b/) || 
                combined.match(/\b(skrillex|excision|zomboy)\b/)) {
                return 'Dubstep';
            }
            if (combined.match(/\b(drum and bass|dnb|liquid dnb|neurofunk)\b/)) {
                return 'Drum & Bass';
            }
            if (combined.match(/\b(edm|electronic dance|electro house)\b/) || 
                combined.match(/\b(deadmau5|avicii|calvin harris|martin garrix|tiesto|armin)\b/) ||
                artistName.includes('dj ')) {
                return 'EDM/Electro House';
            }
            if (combined.match(/\b(downtempo|trip hop|chillout)\b/) ||
                combined.match(/\b(massive attack|portishead|tricky)\b/)) {
                return 'Downtempo/Trip Hop';
            }
            if (combined.match(/\b(witch house|dark wave)\b/)) {
                return 'Witch House/Dark Wave';
            }
            
            // Hip Hop & Rap - Detailed breakdown
            if (combined.match(/\b(trap|trap music)\b/) ||
                combined.match(/\b(travis scott|migos|future|21 savage)\b/)) {
                return 'Trap';
            }
            if (combined.match(/\b(mumble rap|cloud rap|soundcloud rap)\b/) ||
                combined.match(/\b(lil pump|smokepurpp|lil xan)\b/)) {
                return 'Mumble/Cloud Rap';
            }
            if (combined.match(/\b(drill|chicago drill|uk drill)\b/) ||
                combined.match(/\b(pop smoke|chief keef)\b/)) {
                return 'Drill';
            }
            if (combined.match(/\b(conscious rap|political rap|boom bap)\b/) ||
                combined.match(/\b(j cole|nas|common|talib kweli)\b/)) {
                return 'Conscious Rap';
            }
            if (combined.match(/\b(old school|90s rap|east coast|west coast|golden age)\b/) ||
                combined.match(/\b(tupac|biggie|wu tang)\b/)) {
                return 'Old School Hip Hop';
            }
            if (combined.match(/\b(gangsta rap|g funk)\b/) ||
                combined.match(/\b(dr dre|snoop dogg|ice cube)\b/)) {
                return 'Gangsta Rap/G-Funk';
            }
            if (combined.match(/\b(emo rap|sad rap)\b/) ||
                combined.match(/\b(lil peep|xxxtentacion|juice wrld)\b/)) {
                return 'Emo Rap';
            }
            if (combined.match(/\b(rap|rapper|hip hop|hiphop|mc )\b/) ||
                combined.match(/\b(drake|kendrick|eminem|kanye)\b/)) {
                return 'Hip Hop/Rap';
            }
            
            // Rock variations - Detailed breakdown
            if (combined.match(/\b(shoegaze|dream pop)\b/) ||
                combined.match(/\b(my bloody valentine|slowdive|beach house)\b/)) {
                return 'Shoegaze/Dream Pop';
            }
            if (combined.match(/\b(post rock|math rock)\b/) ||
                combined.match(/\b(explosions in the sky|godspeed|mogwai)\b/)) {
                return 'Post-Rock/Math Rock';
            }
            if (combined.match(/\b(noise rock|experimental rock)\b/) ||
                combined.match(/\b(sonic youth|swans)\b/)) {
                return 'Noise/Experimental Rock';
            }
            if (combined.match(/\b(garage rock|surf rock)\b/) ||
                combined.match(/\b(the strokes|black keys|white stripes)\b/)) {
                return 'Garage/Surf Rock';
            }
            if (combined.match(/\b(indie rock|indie|alternative rock|alt rock)\b/) ||
                combined.match(/\b(arctic monkeys|tame impala|mgmt|vampire weekend)\b/)) {
                return 'Indie/Alternative Rock';
            }
            if (combined.match(/\b(post punk|new wave)\b/) ||
                combined.match(/\b(joy division|talking heads|the cure)\b/)) {
                return 'Post-Punk/New Wave';
            }
            if (combined.match(/\b(punk|punk rock|pop punk)\b/) ||
                combined.match(/\b(green day|blink 182|sum 41|offspring)\b/)) {
                return 'Punk/Pop Punk';
            }
            if (combined.match(/\b(hard rock|classic rock)\b/) ||
                combined.match(/\b(ac dc|guns n roses|led zeppelin|aerosmith)\b/)) {
                return 'Hard/Classic Rock';
            }
            if (combined.match(/\b(progressive rock|prog rock|psychedelic rock)\b/) ||
                combined.match(/\b(pink floyd|yes|king crimson|rush)\b/)) {
                return 'Progressive/Psychedelic Rock';
            }
            if (combined.match(/\b(grunge)\b/) ||
                combined.match(/\b(nirvana|pearl jam|soundgarden|alice in chains)\b/)) {
                return 'Grunge';
            }
            if (combined.match(/\b(emo|screamo|emo rock)\b/) ||
                combined.match(/\b(my chemical romance|panic at the disco|fall out boy)\b/)) {
                return 'Emo/Screamo';
            }
            if (combined.match(/\b(rock|rocker)\b/)) {
                return 'Rock';
            }
            
            // Metal - Detailed breakdown
            if (combined.match(/\b(black metal|symphonic black metal)\b/) ||
                combined.match(/\b(mayhem|darkthrone|emperor)\b/)) {
                return 'Black Metal';
            }
            if (combined.match(/\b(death metal|melodic death metal)\b/) ||
                combined.match(/\b(cannibal corpse|death|amon amarth)\b/)) {
                return 'Death Metal';
            }
            if (combined.match(/\b(thrash metal|speed metal)\b/) ||
                combined.match(/\b(metallica|slayer|megadeth|anthrax)\b/)) {
                return 'Thrash Metal';
            }
            if (combined.match(/\b(doom metal|stoner metal|sludge)\b/) ||
                combined.match(/\b(sleep|electric wizard|candlemass)\b/)) {
                return 'Doom/Stoner Metal';
            }
            if (combined.match(/\b(power metal|symphonic metal)\b/) ||
                combined.match(/\b(dragonforce|nightwish|sabaton)\b/)) {
                return 'Power/Symphonic Metal';
            }
            if (combined.match(/\b(progressive metal|djent)\b/) ||
                combined.match(/\b(dream theater|periphery|tool)\b/)) {
                return 'Progressive Metal';
            }
            if (combined.match(/\b(metalcore|deathcore)\b/) ||
                combined.match(/\b(killswitch engage|parkway drive|architects)\b/)) {
                return 'Metalcore/Deathcore';
            }
            if (combined.match(/\b(metal|heavy metal)\b/) ||
                combined.match(/\b(iron maiden|judas priest|black sabbath)\b/)) {
                return 'Heavy Metal';
            }
            
            // Pop variations - Detailed breakdown
            if (combined.match(/\b(hyperpop|glitchcore|digicore)\b/) ||
                combined.match(/\b(100 gecs|charli xcx|sophie)\b/)) {
                return 'Hyperpop/Glitchcore';
            }
            if (combined.match(/\b(bubblegum pop|teen pop)\b/) ||
                combined.match(/\b(britney spears|backstreet|nsync)\b/)) {
                return 'Bubblegum/Teen Pop';
            }
            if (combined.match(/\b(art pop|avant pop|experimental pop)\b/) ||
                combined.match(/\b(bjork|kate bush|fka twigs)\b/)) {
                return 'Art/Experimental Pop';
            }
            if (combined.match(/\b(k-pop|kpop|korean pop)\b/) ||
                combined.match(/\b(bts|blackpink|twice|exo|stray kids)\b/)) {
                return 'K-Pop';
            }
            if (combined.match(/\b(j-pop|jpop|japanese pop)\b/)) {
                return 'J-Pop';
            }
            if (combined.match(/\b(synth pop|synthpop|electropop|synth wave|synthwave)\b/) ||
                combined.match(/\b(chvrches|purity ring|m83|the 1975)\b/)) {
                return 'Synth Pop/Synthwave';
            }
            if (combined.match(/\b(indie pop|bedroom pop|bedroom)\b/) ||
                combined.match(/\b(clairo|rex orange county|boy pablo|cuco)\b/)) {
                return 'Indie/Bedroom Pop';
            }
            if (combined.match(/\b(dance pop|electro pop)\b/) ||
                combined.match(/\b(lady gaga|dua lipa|doja cat)\b/)) {
                return 'Dance Pop';
            }
            
            // R&B & Soul - Detailed breakdown
            if (combined.match(/\b(alternative r&b|alt rnb|pbrb)\b/) ||
                combined.match(/\b(frank ocean|the weeknd|partynextdoor)\b/)) {
                return 'Alternative R&B';
            }
            if (combined.match(/\b(neo soul|neo-soul)\b/) ||
                combined.match(/\b(erykah badu|d angelo|jill scott)\b/)) {
                return 'Neo-Soul';
            }
            if (combined.match(/\b(r&b|rnb|rhythm and blues|soul)\b/) ||
                combined.match(/\b(sza|h\.e\.r\.|daniel caesar)\b/)) {
                return 'R&B/Soul';
            }
            if (combined.match(/\b(funk|funky)\b/) ||
                combined.match(/\b(parliament|funkadelic|james brown)\b/)) {
                return 'Funk';
            }
            if (combined.match(/\b(disco|nu disco)\b/) ||
                combined.match(/\b(daft punk|chic|bee gees)\b/)) {
                return 'Disco/Nu-Disco';
            }
            
            // Jazz variations - Detailed breakdown
            if (combined.match(/\b(bebop|hard bop)\b/) ||
                combined.match(/\b(charlie parker|dizzy gillespie)\b/)) {
                return 'Bebop';
            }
            if (combined.match(/\b(smooth jazz|contemporary jazz)\b/)) {
                return 'Smooth Jazz';
            }
            if (combined.match(/\b(fusion|jazz fusion|jazz rock)\b/) ||
                combined.match(/\b(weather report|mahavishnu)\b/)) {
                return 'Jazz Fusion';
            }
            if (combined.match(/\b(free jazz|avant garde jazz)\b/) ||
                combined.match(/\b(ornette coleman|sun ra)\b/)) {
                return 'Free/Avant-Garde Jazz';
            }
            if (combined.match(/\b(jazz|swing|big band)\b/) ||
                combined.match(/\b(miles davis|john coltrane|ella fitzgerald)\b/)) {
                return 'Jazz';
            }
            
            // Classical & Instrumental - Detailed breakdown
            if (combined.match(/\b(baroque|renaissance|medieval)\b/) ||
                combined.match(/\b(bach|vivaldi|handel)\b/)) {
                return 'Baroque/Early Classical';
            }
            if (combined.match(/\b(romantic|romantic era)\b/) ||
                combined.match(/\b(chopin|liszt|brahms)\b/)) {
                return 'Romantic Classical';
            }
            if (combined.match(/\b(contemporary classical|modern classical|minimalism)\b/) ||
                combined.match(/\b(philip glass|steve reich|arvo part)\b/)) {
                return 'Contemporary Classical';
            }
            if (combined.match(/\b(classical|symphony|concerto|sonata|orchestral|philharmonic)\b/) ||
                combined.match(/\b(mozart|beethoven)\b/)) {
                return 'Classical';
            }
            if (combined.match(/\b(dark ambient|drone|noise)\b/)) {
                return 'Dark Ambient/Drone';
            }
            if (combined.match(/\b(new age|meditation|healing)\b/)) {
                return 'New Age/Meditation';
            }
            if (combined.match(/\b(instrumental|ambient|relaxing)\b/)) {
                return 'Ambient/Instrumental';
            }
            if (combined.match(/\b(film score|soundtrack|ost|original score|hans zimmer|john williams)\b/)) {
                return 'Soundtrack/Film Score';
            }
            if (combined.match(/\b(video game|game music|chiptune|8bit)\b/)) {
                return 'Video Game Music';
            }
            
            // Country & Folk - Detailed breakdown
            if (combined.match(/\b(outlaw country|alt country|alternative country)\b/) ||
                combined.match(/\b(chris stapleton|sturgill simpson)\b/)) {
                return 'Outlaw/Alt-Country';
            }
            if (combined.match(/\b(country pop|pop country)\b/) ||
                combined.match(/\b(taylor swift|shania twain|carrie underwood)\b/)) {
                return 'Country Pop';
            }
            if (combined.match(/\b(country|nashville)\b/) ||
                combined.match(/\b(johnny cash|dolly parton|willie nelson)\b/)) {
                return 'Country';
            }
            if (combined.match(/\b(bluegrass|newgrass)\b/) ||
                combined.match(/\b(bill monroe|alison krauss)\b/)) {
                return 'Bluegrass';
            }
            if (combined.match(/\b(americana|roots)\b/)) {
                return 'Americana/Roots';
            }
            if (combined.match(/\b(folk rock|folk pop)\b/) ||
                combined.match(/\b(fleet foxes|bon iver)\b/)) {
                return 'Folk Rock/Pop';
            }
            if (combined.match(/\b(folk|acoustic|singer songwriter)\b/) ||
                combined.match(/\b(bob dylan|simon garfunkel|joan baez)\b/)) {
                return 'Folk/Acoustic';
            }
            
            // Latin & World - Detailed breakdown
            if (combined.match(/\b(latin trap|trap latino)\b/) ||
                combined.match(/\b(anuel aa|ozuna)\b/)) {
                return 'Latin Trap';
            }
            if (combined.match(/\b(reggaeton|latin urban)\b/) ||
                combined.match(/\b(bad bunny|j balvin|maluma|daddy yankee)\b/)) {
                return 'Reggaeton';
            }
            if (combined.match(/\b(latin pop|pop latino)\b/) ||
                combined.match(/\b(shakira|ricky martin|enrique iglesias)\b/)) {
                return 'Latin Pop';
            }
            if (combined.match(/\b(salsa|timba)\b/)) {
                return 'Salsa';
            }
            if (combined.match(/\b(bachata|merengue)\b/)) {
                return 'Bachata/Merengue';
            }
            if (combined.match(/\b(cumbia)\b/)) {
                return 'Cumbia';
            }
            if (combined.match(/\b(tango|nuevo tango)\b/)) {
                return 'Tango';
            }
            if (combined.match(/\b(flamenco)\b/)) {
                return 'Flamenco';
            }
            if (combined.match(/\b(reggae|roots reggae)\b/) ||
                combined.match(/\b(bob marley|peter tosh)\b/)) {
                return 'Reggae';
            }
            if (combined.match(/\b(dancehall)\b/) ||
                combined.match(/\b(sean paul|shaggy)\b/)) {
                return 'Dancehall';
            }
            if (combined.match(/\b(ska)\b/) ||
                combined.match(/\b(sublime|less than jake)\b/)) {
                return 'Ska';
            }
            if (combined.match(/\b(afrobeat|afro beat|afropop)\b/) ||
                combined.match(/\b(burna boy|wizkid|davido|fela kuti)\b/)) {
                return 'Afrobeat/Afropop';
            }
            if (combined.match(/\b(highlife|juju music)\b/)) {
                return 'Highlife/Juju';
            }
            if (combined.match(/\b(bossa nova)\b/) ||
                combined.match(/\b(antonio carlos jobim)\b/)) {
                return 'Bossa Nova';
            }
            if (combined.match(/\b(samba|mpb|brazilian)\b/)) {
                return 'Samba/MPB';
            }
            if (combined.match(/\b(bollywood|indian classical|hindi)\b/)) {
                return 'Bollywood/Indian';
            }
            if (combined.match(/\b(middle eastern|arabic|persian)\b/)) {
                return 'Middle Eastern';
            }
            
            // Blues & Gospel - Detailed breakdown
            if (combined.match(/\b(delta blues|country blues)\b/) ||
                combined.match(/\b(robert johnson|son house)\b/)) {
                return 'Delta/Country Blues';
            }
            if (combined.match(/\b(chicago blues|electric blues)\b/) ||
                combined.match(/\b(muddy waters|howlin wolf)\b/)) {
                return 'Chicago/Electric Blues';
            }
            if (combined.match(/\b(blues rock)\b/) ||
                combined.match(/\b(eric clapton|stevie ray vaughan)\b/)) {
                return 'Blues Rock';
            }
            if (combined.match(/\b(blues)\b/) ||
                combined.match(/\b(bb king)\b/)) {
                return 'Blues';
            }
            if (combined.match(/\b(gospel|christian|worship|praise)\b/)) {
                return 'Gospel/Christian';
            }
            
            // Modern/Internet genres - Detailed breakdown
            if (combined.match(/\b(phonk|memphis rap)\b/)) {
                return 'Phonk';
            }
            if (combined.match(/\b(vaporwave|vapor wave|mallsoft)\b/)) {
                return 'Vaporwave';
            }
            if (combined.match(/\b(lo-?fi|lofi|chill ?hop|chillhop|study beats)\b/)) {
                return 'Lo-Fi/Chill Hop';
            }
            if (combined.match(/\b(breakcore|speedcore)\b/)) {
                return 'Breakcore';
            }
            if (combined.match(/\b(nightcore)\b/)) {
                return 'Nightcore';
            }
            if (combined.match(/\b(vtuber|anime|j-rock|j-metal)\b/)) {
                return 'Anime/J-Rock';
            }
            
            // Additional Pop sub-genres to catch more before defaulting
            if (combined.match(/\b(pop rock|soft rock)\b/) ||
                combined.match(/\b(maroon 5|coldplay|onerepublic)\b/)) {
                return 'Pop Rock';
            }
            if (combined.match(/\b(acoustic pop|unplugged)\b/)) {
                return 'Acoustic Pop';
            }
            if (combined.match(/\b(pop punk|pop emo)\b/) ||
                combined.match(/\b(all time low|mayday parade)\b/)) {
                return 'Pop Punk';
            }
            if (combined.match(/\b(teen|young|disney|nickelodeon)\b/)) {
                return 'Teen/Disney Pop';
            }
            if (combined.match(/\b(ballad|power ballad)\b/)) {
                return 'Ballads';
            }
            if (combined.match(/\b(singer|songwriter|solo artist)\b/)) {
                return 'Singer-Songwriter';
            }
            if (combined.match(/\b(pop|chart|top 40|mainstream|radio)\b/)) {
                return 'Mainstream Pop';
            }
            
            // Catch-all for truly uncategorized music
            return 'Uncategorized';
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // UPDATEALLDISPLAYS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updateAllDisplays() {
            // Update overall stats (always use all data)
            const analysis = analyzeStreams(allStreamsData);
            document.getElementById('totalStreams').textContent = allStreamsData.length.toLocaleString();
            document.getElementById('uniqueSongs').textContent = Object.keys(analysis.trackStats).length.toLocaleString();
            document.getElementById('uniqueArtists').textContent = Object.keys(analysis.artistStats).length.toLocaleString();
            document.getElementById('totalHours').textContent = (allStreamsData.reduce((sum, s) => sum + (s.ms_played || 0), 0) / (1000 * 60 * 60)).toFixed(1);

            updateSongDisplay();
            updateArtistDisplay();
            updateGenreDisplay();
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // UPDATEGENREDISPLAY
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updateGenreDisplay() {
            try {
                const sortBy = document.getElementById('genreSortBy').value;
                const year = document.getElementById('genreYearFilter').value;
                
                const filteredStreams = filterStreamsByYear(allStreamsData, year);
                const { genreStats } = analyzeStreams(filteredStreams);
                
                // Calculate and display genre stat cards
                const genresArray = Object.values(genreStats);
                
                // Top Genre
                const topGenre = genresArray
                    .filter(g => g.genre !== 'Uncategorized')
                    .sort((a, b) => b.playCount - a.playCount)[0];
                if (topGenre) {
                    document.getElementById('topGenre').textContent = topGenre.genre;
                    const hours = (topGenre.totalMs / (1000 * 60 * 60)).toFixed(1);
                    document.getElementById('topGenreStats').textContent = `${topGenre.playCount} plays â€¢ ${hours}h`;
                } else {
                    document.getElementById('topGenre').textContent = 'No data';
                    document.getElementById('topGenreStats').textContent = 'Your most played genre';
                }
                
                // Total Genres
                const totalGenres = genresArray.filter(g => g.genre !== 'Uncategorized').length;
                document.getElementById('totalGenres').textContent = totalGenres;
                
                // Genre Diversity (0-100 score based on how evenly distributed plays are)
                const validGenres = genresArray.filter(g => g.genre !== 'Uncategorized');
                const totalPlays = validGenres.reduce((sum, g) => sum + g.playCount, 0);
                if (totalPlays > 0) {
                    const entropy = validGenres.reduce((sum, g) => {
                        const p = g.playCount / totalPlays;
                        return sum - (p * Math.log2(p));
                    }, 0);
                    const maxEntropy = Math.log2(validGenres.length);
                    const diversityScore = maxEntropy > 0 ? Math.round((entropy / maxEntropy) * 100) : 0;
                    document.getElementById('genreDiversity').textContent = `${diversityScore}%`;
                } else {
                    document.getElementById('genreDiversity').textContent = '0%';
                }
                
                // Genre Champion (most unique artists)
                const genreChampion = validGenres
                    .sort((a, b) => b.artists.size - a.artists.size)[0];
                if (genreChampion) {
                    document.getElementById('genreChampion').textContent = genreChampion.genre;
                } else {
                    document.getElementById('genreChampion').textContent = 'No data';
                }
                
                // Sort based on selection and filter out Uncategorized
                const sortedGenres = validGenres
                    .map(genre => ({
                        ...genre,
                        uniqueArtists: genre.artists.size,
                        uniqueTracks: genre.tracks.size
                    }))
                    .sort((a, b) => {
                        switch(sortBy) {
                            case 'timeListened':
                                return b.totalMs - a.totalMs;
                            case 'uniqueArtists':
                                return b.uniqueArtists - a.uniqueArtists;
                            case 'uniqueTracks':
                                return b.uniqueTracks - a.uniqueTracks;
                            default: // playCount
                                return b.playCount - a.playCount;
                        }
                    }).slice(0, 20);

                // Display
                const topGenresList = document.getElementById('topGenres');
                topGenresList.innerHTML = '';
                sortedGenres.forEach((genre, index) => {
                    const hours = (genre.totalMs / (1000 * 60 * 60)).toFixed(2);
                    const li = document.createElement('li');
                    li.className = 'artist-item';
                    li.innerHTML = `
                        <span class="rank">${index + 1}</span>
                        <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px); margin-left: 10px;">
                            <div class="song-name">${genre.genre}</div>
                            <div class="stats">â–¶ï¸ ${genre.playCount} plays â€¢ â±ï¸ ${hours}h â€¢ ğŸ¤ ${genre.uniqueArtists} artists â€¢ ğŸµ ${genre.uniqueTracks} tracks</div>
                        </div>
                    `;
                    topGenresList.appendChild(li);
                });
                
                console.log('âœ… Genre display updated');
            } catch (error) {
                console.error('âŒ Error updating genre display:', error);
            }
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // UPDATESONGDISPLAY
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updateSongDisplay() {
            const sortBy = document.getElementById('songSortBy').value;
            const year = document.getElementById('songYearFilter').value;
            
            const filteredStreams = filterStreamsByYear(allStreamsData, year);
            const { trackStats } = analyzeStreams(filteredStreams);
            
            // Sort based on selection
            const sortedTracks = Object.values(trackStats).sort((a, b) => {
                switch(sortBy) {
                    case 'timeListened':
                        return b.totalMs - a.totalMs;
                    case 'avgPlayTime':
                        return b.avgPlayTime - a.avgPlayTime;
                    case 'firstPlayed':
                        return new Date(a.firstPlayed) - new Date(b.firstPlayed);
                    case 'lastPlayed':
                        return new Date(b.lastPlayed) - new Date(a.lastPlayed);
                    default: // playCount
                        return b.playCount - a.playCount;
                }
            }).slice(0, 50);

            // Display
            const topSongsList = document.getElementById('topSongs');
            topSongsList.innerHTML = '';
            sortedTracks.forEach((song, index) => {
                const hours = (song.totalMs / (1000 * 60 * 60)).toFixed(2);
                const avgMins = (song.avgPlayTime / (1000 * 60)).toFixed(1);
                const li = document.createElement('li');
                li.className = 'song-item';
                li.innerHTML = `
                    <span class="rank">${index + 1}</span>
                    <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px); margin-left: 10px;">
                        <div class="song-name">${song.track}</div>
                        <div class="artist-name">${song.artist}</div>
                        <div class="stats">â–¶ï¸ ${song.playCount} plays â€¢ â±ï¸ ${hours}h â€¢ â³ ${avgMins}min avg</div>
                    </div>
                `;
                topSongsList.appendChild(li);
            });
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // UPDATEARTISTDISPLAY
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updateArtistDisplay() {
            const sortBy = document.getElementById('artistSortBy').value;
            const year = document.getElementById('artistYearFilter').value;
            
            const filteredStreams = filterStreamsByYear(allStreamsData, year);
            const { artistStats } = analyzeStreams(filteredStreams);
            
            // Sort based on selection
            const sortedArtists = Object.values(artistStats)
                .map(artist => ({
                    ...artist,
                    uniqueTracks: artist.tracks.size
                }))
                .sort((a, b) => {
                    switch(sortBy) {
                        case 'timeListened':
                            return b.totalMs - a.totalMs;
                        case 'uniqueTracks':
                            return b.uniqueTracks - a.uniqueTracks;
                        case 'avgPlayTime':
                            return b.avgPlayTime - a.avgPlayTime;
                        case 'firstPlayed':
                            return new Date(a.firstPlayed) - new Date(b.firstPlayed);
                        case 'lastPlayed':
                            return new Date(b.lastPlayed) - new Date(a.lastPlayed);
                        default: // playCount
                            return b.playCount - a.playCount;
                    }
                }).slice(0, 25);

            // Display
            const topArtistsList = document.getElementById('topArtists');
            topArtistsList.innerHTML = '';
            sortedArtists.forEach((artist, index) => {
                const hours = (artist.totalMs / (1000 * 60 * 60)).toFixed(2);
                const avgMins = (artist.avgPlayTime / (1000 * 60)).toFixed(1);
                const li = document.createElement('li');
                li.className = 'artist-item';
                li.innerHTML = `
                    <span class="rank">${index + 1}</span>
                    <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px); margin-left: 10px;">
                        <div class="song-name">${artist.artist}</div>
                        <div class="stats">â–¶ï¸ ${artist.playCount} plays â€¢ â±ï¸ ${hours}h â€¢ ğŸµ ${artist.uniqueTracks} tracks â€¢ â³ ${avgMins}min avg</div>
                    </div>
                `;
                topArtistsList.appendChild(li);
            });
        }

        function switchChartTab(tabName) {
            // Hide all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            // Show selected tab and content
            event.target.classList.add('active');
            document.getElementById(`${tabName}-chart`).style.display = 'block';
            
            // Lazy load chart if not created yet
            ensureChartCreated(tabName);
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATECHARTS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => chart?.destroy());
            charts = {};

            // Only create the initially visible chart (Timeline)
            createTimelineChart();
            
            // Mark that we need to create other charts when tabs are switched
            window.chartsCreated = { timeline: true };
        }
        

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // ENSURECHARTCREATED
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function ensureChartCreated(chartName) {
            if (!window.chartsCreated) window.chartsCreated = {};
            if (window.chartsCreated[chartName]) return;
            
            switch(chartName) {
                case 'hourly':
                    createHourlyChart();
                    break;
                case 'weekday':
                    createWeekdayChart();
                    break;
                case 'topTracks':
                    createTopTracksChart();
                    break;
                case 'topArtists':
                    createTopArtistsChart();
                    break;
                case 'tracksPie':
                    createTracksPieChart();
                    break;
                case 'artistsPie':
                    createArtistsPieChart();
                    break;
            }
            
            window.chartsCreated[chartName] = true;
        }
        

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATEGENRECHARTS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createGenreCharts() {
            if (charts.genre) return; // Already created
            createGenreChart();
            createGenreTrendChart();
            createGenreTimeChart();
        }
        

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATEHABITSCHARTS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createHabitsCharts() {
            if (charts.timeOfDay) return; // Already created
            createTimeOfDayChart();
            createSeasonalChart();
            createWeekdayWeekendChart();
        }
        

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATEDISCOVERYCHARTS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createDiscoveryCharts() {
            if (charts.discoveryTimeline) return; // Already created
            createDiscoveryTimelineChart();
            createRepeatExploreChart();
        }
        

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATEADVANCEDCHARTS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createAdvancedCharts() {
            if (charts.decade) return; // Already created
            createDecadeChart();
        }
        

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATECOMPARISONCHARTS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createComparisonCharts() {
            if (charts.workLeisure) return; // Already created
            createWorkLeisureChart();
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATETIMEOFDAYCHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createTimeOfDayChart() {
            const timeRanges = ['Morning\n(6am-12pm)', 'Afternoon\n(12pm-6pm)', 'Evening\n(6pm-10pm)', 'Night\n(10pm-6am)'];
            const data = [0, 0, 0, 0];

            allStreamsData.forEach(stream => {
                if (!stream.ts || !stream.ms_played || stream.ms_played < 30000) return;
                
                const hour = new Date(stream.ts).getHours();
                if (hour >= 6 && hour < 12) data[0]++;
                else if (hour >= 12 && hour < 18) data[1]++;
                else if (hour >= 18 && hour < 22) data[2]++;
                else data[3]++;
            });

            const ctx = document.getElementById('timeOfDayChart').getContext('2d');
            charts.timeOfDay = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: timeRanges,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#ffeaa7', '#74b9ff', '#a29bfe', '#667eea'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ğŸŒ… When Do You Listen Most?',
                            font: { size: 18, weight: 'bold' },
                            color: '#333'
                        },
                        legend: { position: 'right' }
                    }
                }
            });
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATESEASONALCHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createSeasonalChart() {
            const seasons = { spring: 0, summer: 0, fall: 0, winter: 0 };
            
            allStreamsData.forEach(stream => {
                if (!stream.ts || !stream.ms_played || stream.ms_played < 30000) return;
                
                const month = new Date(stream.ts).getMonth();
                if (month >= 2 && month <= 4) seasons.spring++;
                else if (month >= 5 && month <= 7) seasons.summer++;
                else if (month >= 8 && month <= 10) seasons.fall++;
                else seasons.winter++;
            });

            const ctx = document.getElementById('seasonalChart').getContext('2d');
            charts.seasonal = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ğŸŒ¸ Spring', 'â˜€ï¸ Summer', 'ğŸ‚ Fall', 'â„ï¸ Winter'],
                    datasets: [{
                        label: 'Streams',
                        data: [seasons.spring, seasons.summer, seasons.fall, seasons.winter],
                        backgroundColor: ['#a8edea', '#fed6e3', '#ffeaa7', '#74b9ff'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ğŸ“… Seasonal Listening Patterns',
                            font: { size: 18, weight: 'bold' },
                            color: '#333'
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATEWEEKDAYWEEKENDCHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createWeekdayWeekendChart() {
            const weekday = Array(5).fill(0);
            const weekend = Array(2).fill(0);
            
            allStreamsData.forEach(stream => {
                if (!stream.ts || !stream.ms_played || stream.ms_played < 30000) return;
                
                const day = new Date(stream.ts).getDay();
                if (day >= 1 && day <= 5) {
                    weekday[day - 1]++;
                } else {
                    weekend[day === 0 ? 1 : 0]++;
                }
            });

            const ctx = document.getElementById('weekdayWeekendChart').getContext('2d');
            charts.weekdayWeekend = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
                    datasets: [{
                        label: 'Streams',
                        data: [...weekday, ...weekend],
                        backgroundColor: ['#667eea', '#667eea', '#667eea', '#667eea', '#667eea', '#f093fb', '#f093fb'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ğŸ“Š Weekday vs Weekend Listening',
                            font: { size: 18, weight: 'bold' },
                            color: '#333'
                        },
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATEDISCOVERYTIMELINECHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createDiscoveryTimelineChart() {
            const monthlyNew = {};
            const artistFirstPlay = {};
            
            allStreamsData
                .filter(s => s.ts && s.ms_played >= 30000)
                .sort((a, b) => new Date(a.ts) - new Date(b.ts))
                .forEach(stream => {
                    const artist = stream.master_metadata_album_artist_name;
                    if (!artist || artistFirstPlay[artist]) return;
                    
                    artistFirstPlay[artist] = true;
                    const date = new Date(stream.ts);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyNew[monthKey]) monthlyNew[monthKey] = 0;
                    monthlyNew[monthKey]++;
                });

            const sortedMonths = Object.keys(monthlyNew).sort();
            const labels = sortedMonths.map(m => {
                const [year, month] = m.split('-');
                return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });

            const ctx = document.getElementById('discoveryTimelineChart').getContext('2d');
            charts.discoveryTimeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'New Artists',
                        data: sortedMonths.map(m => monthlyNew[m]),
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ğŸ†• New Artists Discovered Over Time',
                            font: { size: 18, weight: 'bold' },
                            color: '#333'
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATEREPEATEXPLORECHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createRepeatExploreChart() {
            const monthlyData = {};
            const seenTracks = {};
            
            allStreamsData
                .filter(s => s.ts && s.ms_played >= 30000)
                .sort((a, b) => new Date(a.ts) - new Date(b.ts))
                .forEach(stream => {
                    const track = `${stream.master_metadata_track_name}|||${stream.master_metadata_album_artist_name}`;
                    const date = new Date(stream.ts);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { repeat: 0, explore: 0 };
                    }
                    
                    if (seenTracks[track]) {
                        monthlyData[monthKey].repeat++;
                    } else {
                        monthlyData[monthKey].explore++;
                        seenTracks[track] = true;
                    }
                });

            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(m => {
                const [year, month] = m.split('-');
                return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });

            const ctx = document.getElementById('repeatExploreChart').getContext('2d');
            charts.repeatExplore = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Repeat Listens',
                            data: sortedMonths.map(m => monthlyData[m].repeat),
                            backgroundColor: '#667eea80',
                            borderColor: '#667eea',
                            borderWidth: 2
                        },
                        {
                            label: 'New Explorations',
                            data: sortedMonths.map(m => monthlyData[m].explore),
                            backgroundColor: '#f093fb80',
                            borderColor: '#f093fb',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ğŸ”„ Repeat vs Explore Pattern',
                            font: { size: 18, weight: 'bold' },
                            color: '#333'
                        }
                    },
                    scales: {
                        y: {
                            stacked: true,
                            beginAtZero: true
                        },
                        x: {
                            stacked: true
                        }
                    }
                }
            });
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATEGENRECHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createGenreChart() {
            updateGenreChart();
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // UPDATEGENRECHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updateGenreChart() {
            if (charts.genre) {
                charts.genre.destroy();
            }

            const chartType = document.getElementById('genreChartType')?.value || 'doughnut';
            const sortBy = document.getElementById('genreChartSort')?.value || 'playCount';
            const limit = parseInt(document.getElementById('genreChartLimit')?.value || '10');

            const { genreStats } = analyzeStreams(allStreamsData);
            let topGenres = Object.values(genreStats)
                .filter(g => !filteredGenres.has(g.genre)) // Filter out excluded genres
                .map(g => ({
                    ...g,
                    uniqueArtists: g.artists.size,
                    uniqueTracks: g.tracks.size
                }));

            // Sort based on selection
            switch(sortBy) {
                case 'timeListened':
                    topGenres.sort((a, b) => b.totalMs - a.totalMs);
                    break;
                case 'uniqueArtists':
                    topGenres.sort((a, b) => b.uniqueArtists - a.uniqueArtists);
                    break;
                case 'uniqueTracks':
                    topGenres.sort((a, b) => b.uniqueTracks - a.uniqueTracks);
                    break;
                default: // playCount
                    topGenres.sort((a, b) => b.playCount - a.playCount);
            }

            topGenres = topGenres.slice(0, limit);

            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
                '#a8edea', '#fed6e3', '#ffeaa7', '#74b9ff', '#a29bfe',
                '#ff7675', '#fd79a8', '#fdcb6e', '#e17055', '#00b894',
                '#00cec9', '#0984e3', '#6c5ce7', '#b2bec3', '#636e72'
            ];

            // Get data based on sort type
            let chartData;
            switch(sortBy) {
                case 'timeListened':
                    chartData = topGenres.map(g => (g.totalMs / (1000 * 60 * 60)).toFixed(1));
                    break;
                case 'uniqueArtists':
                    chartData = topGenres.map(g => g.uniqueArtists);
                    break;
                case 'uniqueTracks':
                    chartData = topGenres.map(g => g.uniqueTracks);
                    break;
                default: // playCount
                    chartData = topGenres.map(g => g.playCount);
            }

            const ctx = document.getElementById('genreChart').getContext('2d');
            
            let chartConfig = {
                type: chartType === 'horizontalBar' ? 'bar' : chartType,
                data: {
                    labels: topGenres.map(g => g.genre),
                    datasets: [{
                        label: sortBy === 'timeListened' ? 'Hours' : 
                               sortBy === 'uniqueArtists' ? 'Artists' :
                               sortBy === 'uniqueTracks' ? 'Tracks' : 'Plays',
                        data: chartData,
                        backgroundColor: colors.slice(0, limit),
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `ğŸ¸ Top ${limit} Genres by ${sortBy === 'playCount' ? 'Play Count' : 
                                   sortBy === 'timeListened' ? 'Time Listened' :
                                   sortBy === 'uniqueArtists' ? 'Unique Artists' : 'Unique Tracks'}`,
                            font: { size: 18, weight: 'bold' },
                            color: '#333'
                        },
                        legend: {
                            position: chartType === 'bar' || chartType === 'horizontalBar' ? 'top' : 'right',
                            display: chartType !== 'bar' && chartType !== 'horizontalBar',
                            labels: {
                                boxWidth: 15,
                                padding: 12,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed.y || context.parsed || 0;
                                    if (chartType === 'pie' || chartType === 'doughnut' || chartType === 'polarArea') {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                    return `${label}: ${value}`;
                                }
                            }
                        }
                    }
                }
            };

            // Add specific options for bar charts
            if (chartType === 'bar' || chartType === 'horizontalBar') {
                chartConfig.options.indexAxis = chartType === 'horizontalBar' ? 'y' : 'x';
                chartConfig.options.scales = {
                    y: chartType === 'horizontalBar' ? {
                        grid: { display: false }
                    } : {
                        beginAtZero: true,
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    },
                    x: chartType === 'horizontalBar' ? {
                        beginAtZero: true,
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    } : {
                        grid: { display: false }
                    }
                };
            }

            charts.genre = new Chart(ctx, chartConfig);
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATEGENRETRENDCHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createGenreTrendChart() {
            const monthlyGenreData = {};
            
            allStreamsData.forEach(stream => {
                if (!stream.ts || !stream.ms_played || stream.ms_played < 30000) return;
                
                const genre = categorizeGenre(stream);
                if (filteredGenres.has(genre)) return; // Skip filtered genres
                
                const date = new Date(stream.ts);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyGenreData[monthKey]) {
                    monthlyGenreData[monthKey] = {};
                }
                monthlyGenreData[monthKey][genre] = (monthlyGenreData[monthKey][genre] || 0) + 1;
            });

            // Get top 5 genres from non-filtered genres
            const { genreStats } = analyzeStreams(allStreamsData);
            const topGenres = Object.values(genreStats)
                .filter(g => !filteredGenres.has(g.genre))
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 5)
                .map(g => g.genre);

            const sortedMonths = Object.keys(monthlyGenreData).sort();
            const labels = sortedMonths.map(m => {
                const [year, month] = m.split('-');
                const date = new Date(year, month - 1);
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });

            const colors = ['#667eea', '#f093fb', '#4facfe', '#ffeaa7', '#a29bfe'];
            const datasets = topGenres.map((genre, index) => ({
                label: genre,
                data: sortedMonths.map(m => monthlyGenreData[m][genre] || 0),
                borderColor: colors[index],
                backgroundColor: colors[index] + '40',
                tension: 0.4,
                fill: false,
                borderWidth: 3
            }));

            const ctx = document.getElementById('genreTrendChart').getContext('2d');
            charts.genreTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ğŸ“ˆ Top 5 Genre Trends Over Time',
                            font: { size: 18, weight: 'bold' },
                            color: '#333'
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATEGENRETIMECHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createGenreTimeChart() {
            const hourlyGenreData = {};
            
            // Get top 5 genres from non-filtered genres
            const { genreStats } = analyzeStreams(allStreamsData);
            const topGenres = Object.values(genreStats)
                .filter(g => !filteredGenres.has(g.genre))
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 5)
                .map(g => g.genre);

            // Initialize data structure
            for (let hour = 0; hour < 24; hour++) {
                hourlyGenreData[hour] = {};
                topGenres.forEach(genre => {
                    hourlyGenreData[hour][genre] = 0;
                });
            }

            allStreamsData.forEach(stream => {
                if (!stream.ts || !stream.ms_played || stream.ms_played < 30000) return;
                
                const genre = categorizeGenre(stream);
                if (!topGenres.includes(genre)) return;
                
                const date = new Date(stream.ts);
                const hour = date.getHours();
                hourlyGenreData[hour][genre]++;
            });

            const colors = ['#667eea', '#f093fb', '#4facfe', '#ffeaa7', '#a29bfe'];
            const datasets = topGenres.map((genre, index) => ({
                label: genre,
                data: Array.from({length: 24}, (_, i) => hourlyGenreData[i][genre]),
                backgroundColor: colors[index] + '80',
                borderColor: colors[index],
                borderWidth: 2
            }));

            const ctx = document.getElementById('genreTimeChart').getContext('2d');
            charts.genreTime = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'â° Top 5 Genres by Time of Day',
                            font: { size: 18, weight: 'bold' },
                            color: '#333'
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        x: {
                            stacked: true,
                            grid: { display: false }
                        }
                    }
                }
            });
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATETIMELINECHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createTimelineChart() {
            try {
                console.log('=== TIMELINE CHART DEBUG ===');
                console.log('1. Starting createTimelineChart...');
                console.log('2. Chart.js available:', typeof Chart !== 'undefined');
                
                if (typeof Chart === 'undefined') {
                    console.error('âŒ Chart.js library not loaded!');
                    console.log('Attempting to wait for Chart.js...');
                    setTimeout(createTimelineChart, 1000);
                    return;
                }
                
                console.log('3. allStreamsData length:', allStreamsData ? allStreamsData.length : 'undefined');
                console.log('3. allStreamsData length:', allStreamsData ? allStreamsData.length : 'undefined');
                
                if (!allStreamsData || allStreamsData.length === 0) {
                    console.error('âŒ No streams data available');
                    return;
                }
                
                const monthlyData = {};
                let validCount = 0;
                
                allStreamsData.forEach(stream => {
                    if (!stream.ts || !stream.ms_played || stream.ms_played < 30000) return;
                    validCount++;
                    
                    const date = new Date(stream.ts);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { count: 0, hours: 0 };
                    }
                    monthlyData[monthKey].count++;
                    monthlyData[monthKey].hours += stream.ms_played / (1000 * 60 * 60);
                });

                console.log('4. Valid streams processed:', validCount);
                console.log('5. Months with data:', Object.keys(monthlyData).length);
                
                const sortedMonths = Object.keys(monthlyData).sort();
                
                if (sortedMonths.length === 0) {
                    console.error('âŒ No timeline data after processing');
                    return;
                }
                
                console.log('6. Date range:', sortedMonths[0], 'to', sortedMonths[sortedMonths.length - 1]);
                
                const labels = sortedMonths.map(m => {
                    const [year, month] = m.split('-');
                    const date = new Date(year, month - 1);
                    return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                });
                const counts = sortedMonths.map(m => monthlyData[m].count);

                console.log('7. Chart labels:', labels.length);
                console.log('8. Chart data points:', counts.length);
                
                const canvas = document.getElementById('timelineChart');
                console.log('9. Canvas element found:', !!canvas);
                
                if (!canvas) {
                    console.error('âŒ Timeline chart canvas not found in DOM');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                console.log('10. Canvas context obtained:', !!ctx);
                
                // Destroy existing chart if it exists
                if (charts.timeline) {
                    console.log('11. Destroying existing timeline chart');
                    charts.timeline.destroy();
                }
                
                console.log('12. Creating Chart.js instance...');
                
                charts.timeline = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Streams',
                            data: counts,
                            borderColor: '#88a980',
                            backgroundColor: 'rgba(136, 169, 128, 0.2)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3,
                            pointBackgroundColor: '#88a980',
                            pointBorderColor: '#1a2421',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#a8c9a0',
                            pointHoverBorderColor: '#c4d4c8'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'ğŸ“ˆ Listening Activity Over Time',
                                font: { size: 18, weight: 'bold' },
                                color: '#a8c9a0'
                            },
                            legend: {
                                display: false
                            },
                            tooltip: {
                                backgroundColor: 'rgba(30, 40, 35, 0.9)',
                                titleColor: '#c4d4c8',
                                bodyColor: '#a8c9a0',
                                borderColor: '#6a8763',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(106, 135, 99, 0.2)'
                                },
                                ticks: {
                                    color: '#8a9d87'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#8a9d87',
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
                
                console.log('13. Chart instance created:', !!charts.timeline);
                console.log('âœ… Timeline chart completed successfully');
                console.log('=== END TIMELINE CHART DEBUG ===');
            } catch (error) {
                console.error('âŒ ERROR in createTimelineChart:', error.message);
                console.error('Error stack:', error.stack);
                console.error('=== END TIMELINE CHART DEBUG (ERROR) ===');
            }
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATEHOURLYCHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createHourlyChart() {
            const hourlyData = Array(24).fill(0);
            
            allStreamsData.forEach(stream => {
                if (!stream.ts || !stream.ms_played || stream.ms_played < 30000) return;
                
                const date = new Date(stream.ts);
                const hour = date.getHours();
                hourlyData[hour]++;
            });

            const ctx = document.getElementById('hourlyChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');

            charts.hourly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Streams',
                        data: hourlyData,
                        backgroundColor: gradient,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ğŸ• Listening Activity by Hour of Day',
                            font: { size: 18, weight: 'bold' },
                            color: '#333'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATEWEEKDAYCHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createWeekdayChart() {
            const weekdayData = Array(7).fill(0);
            const weekdayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            allStreamsData.forEach(stream => {
                if (!stream.ts || !stream.ms_played || stream.ms_played < 30000) return;
                
                const date = new Date(stream.ts);
                const day = date.getDay();
                weekdayData[day]++;
            });

            const colors = ['#f093fb', '#4facfe', '#00f2fe', '#667eea', '#764ba2', '#f093fb', '#4facfe'];

            const ctx = document.getElementById('weekdayChart').getContext('2d');
            charts.weekday = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weekdayNames,
                    datasets: [{
                        label: 'Streams',
                        data: weekdayData,
                        backgroundColor: colors,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ğŸ“… Listening Activity by Day of Week',
                            font: { size: 18, weight: 'bold' },
                            color: '#333'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATETOPTRACKSCHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createTopTracksChart() {
            const analysis = getCachedAnalysis();
            if (!analysis || !analysis.trackStats) {
                console.error('No track stats available');
                return;
            }
            
            const topTracks = Object.values(analysis.trackStats)
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 10);

            const colors = [
                '#88a980', '#6a8763', '#a8c9a0', '#5a7153', '#c4d4c8',
                '#88a980', '#6a8763', '#a8c9a0', '#5a7153', '#c4d4c8'
            ];

            const ctx = document.getElementById('topTracksChart').getContext('2d');
            charts.topTracks = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topTracks.map(t => `${t.track.substring(0, 30)}${t.track.length > 30 ? '...' : ''}`),
                    datasets: [{
                        label: 'Play Count',
                        data: topTracks.map(t => t.playCount),
                        backgroundColor: colors,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ğŸµ Top 10 Most Played Tracks',
                            font: { size: 18, weight: 'bold' },
                            color: '#a8c9a0'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(106, 135, 99, 0.2)'
                            },
                            ticks: {
                                color: '#8a9d87'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#c4d4c8'
                            }
                        }
                    }
                }
            });
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATETOPARTISTSCHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createTopArtistsChart() {
            const analysis = getCachedAnalysis();
            if (!analysis || !analysis.artistStats) {
                console.error('No artist stats available');
                return;
            }
            
            const topArtists = Object.values(analysis.artistStats)
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 10);

            const colors = [
                '#88a980', '#6a8763', '#a8c9a0', '#5a7153', '#c4d4c8',
                '#88a980', '#6a8763', '#a8c9a0', '#5a7153', '#c4d4c8'
            ];

            const ctx = document.getElementById('topArtistsChart').getContext('2d');
            charts.topArtists = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topArtists.map(a => a.artist.substring(0, 30) + (a.artist.length > 30 ? '...' : '')),
                    datasets: [{
                        label: 'Play Count',
                        data: topArtists.map(a => a.playCount),
                        backgroundColor: colors,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ğŸ¤ Top 10 Most Played Artists',
                            font: { size: 18, weight: 'bold' },
                            color: '#a8c9a0'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(106, 135, 99, 0.2)'
                            },
                            ticks: {
                                color: '#8a9d87'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#c4d4c8'
                            }
                        }
                    }
                }
            });
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATETRACKSPIECHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createTracksPieChart() {
            const { trackStats } = analyzeStreams(allStreamsData);
            const topTracks = Object.values(trackStats)
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 10);

            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
                '#a8edea', '#fed6e3', '#ffeaa7', '#74b9ff', '#a29bfe'
            ];

            const ctx = document.getElementById('tracksPieChart').getContext('2d');
            charts.tracksPie = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: topTracks.map(t => `${t.track.substring(0, 25)}${t.track.length > 25 ? '...' : ''}`),
                    datasets: [{
                        label: 'Play Count',
                        data: topTracks.map(t => t.playCount),
                        backgroundColor: colors,
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ğŸ° Top 10 Tracks - Play Count Distribution',
                            font: { size: 18, weight: 'bold' },
                            color: '#333'
                        },
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                padding: 12,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} plays (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATEARTISTSPIECHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createArtistsPieChart() {
            const { artistStats } = analyzeStreams(allStreamsData);
            const topArtists = Object.values(artistStats)
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 10);

            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
                '#a8edea', '#fed6e3', '#ffeaa7', '#74b9ff', '#a29bfe'
            ];

            const ctx = document.getElementById('artistsPieChart').getContext('2d');
            charts.artistsPie = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: topArtists.map(a => a.artist.substring(0, 25) + (a.artist.length > 25 ? '...' : '')),
                    datasets: [{
                        label: 'Play Count',
                        data: topArtists.map(a => a.playCount),
                        backgroundColor: colors,
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ğŸ° Top 10 Artists - Play Count Distribution',
                            font: { size: 18, weight: 'bold' },
                            color: '#333'
                        },
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                padding: 12,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} plays (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Tools Functions
        // Quick Find Functions
        function showTopSongs() {
            const analysis = getCachedAnalysis();
            const topSongs = Object.values(analysis.trackStats)
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 20);
            
            displaySongList(topSongs, 'ğŸµ Your Top 20 Songs', 'quickFindResults');
        }
        
        function showTopArtists() {
            const analysis = getCachedAnalysis();
            const topArtists = Object.values(analysis.artistStats)
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 20);
            
            const html = topArtists.map((artist, i) => `
                <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 1.1em; color: #667eea;">${i + 1}. ${artist.artist}</strong>
                            <p style="color: var(--text-primary); margin: 5px 0 0 0;">${artist.playCount} plays â€¢ ${(artist.totalMs / (1000 * 60 * 60)).toFixed(1)}h</p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('quickFindResults').innerHTML = `
                <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ¤ Your Top 20 Artists</h4>
                ${html}
            `;
        }
        
        function showRecentlyPlayed() {
            const recent = allStreamsData
                .filter(s => s.ms_played >= 30000 && s.ts)
                .sort((a, b) => new Date(b.ts) - new Date(a.ts))
                .slice(0, 20);
            
            const html = recent.map((stream, i) => {
                const date = new Date(stream.ts);
                const timeAgo = getTimeAgo(date);
                return `
                    <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                        <strong style="color: #667eea;">${stream.master_metadata_track_name || 'Unknown'}</strong>
                        <p style="color: var(--text-primary); margin: 5px 0;">by ${stream.master_metadata_album_artist_name || 'Unknown'}</p>
                        <p style="color: #999; font-size: 0.9em;">${timeAgo}</p>
                    </div>
                `;
            }).join('');
            
            document.getElementById('quickFindResults').innerHTML = `
                <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ• Recently Played</h4>
                ${html}
            `;
        }
        
        function showMostPlayed() {
            const analysis = getCachedAnalysis();
            const mostPlayed = Object.values(analysis.trackStats)
                .sort((a, b) => b.playCount - a.playCount)[0];
            
            if (mostPlayed) {
                document.getElementById('quickFindResults').innerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; border-radius: 20px; text-align: center;">
                        <h2 style="margin-bottom: 20px;">ğŸ”¥ Your Most Played Song Ever</h2>
                        <h3 style="font-size: 2em; margin: 20px 0;">${mostPlayed.track}</h3>
                        <p style="font-size: 1.3em; opacity: 0.9;">by ${mostPlayed.artist}</p>
                        <div style="margin-top: 30px; font-size: 1.2em;">
                            <p>â–¶ï¸ Played <strong>${mostPlayed.playCount}</strong> times</p>
                            <p>â±ï¸ Total listening time: <strong>${(mostPlayed.totalMs / (1000 * 60 * 60)).toFixed(1)}</strong> hours</p>
                        </div>
                    </div>
                `;
            }
        }
        
        function showLongestSongs() {
            const analysis = getCachedAnalysis();
            const longest = Object.values(analysis.trackStats)
                .map(t => ({...t, avgDuration: t.totalMs / t.playCount}))
                .sort((a, b) => b.avgDuration - a.avgDuration)
                .slice(0, 10);
            
            displaySongList(longest, 'â±ï¸ Longest Songs in Your Library', 'quickFindResults');
        }
        
        function showOneHitWonders() {
            const analysis = getCachedAnalysis();
            const oneHits = Object.values(analysis.trackStats)
                .filter(t => t.playCount === 1)
                .sort((a, b) => new Date(b.lastPlayed) - new Date(a.lastPlayed))
                .slice(0, 20);
            
            displaySongList(oneHits, 'â­ One-Hit Wonders (Played Only Once)', 'quickFindResults');
        }
        
        function applyQuickFilter() {
            const genre = document.getElementById('quickFindGenre').value;
            if (!genre) {
                showTopSongs();
                return;
            }
            
            const analysis = getCachedAnalysis();
            const filtered = Object.values(analysis.trackStats)
                .filter(t => t.genre === genre)
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 20);
            
            displaySongList(filtered, `ğŸ¸ Top ${genre} Songs`, 'quickFindResults');
        }
        

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // DISPLAYSONGLIST
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function displaySongList(songs, title, containerId) {
            const html = songs.map((song, i) => `
                <div style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 1.1em; color: #667eea;">${i + 1}. ${song.track}</strong>
                            <p style="color: var(--text-primary); margin: 5px 0 0 0;">by ${song.artist}</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="color: #999; margin: 0;">${song.playCount} plays</p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById(containerId).innerHTML = `
                <h4 style="color: #667eea; margin-bottom: 15px;">${title}</h4>
                ${html}
            `;
        }
        
        // Time Travel Functions
        function showTimeRange(range) {
            const now = new Date();
            let startDate;
            
            switch(range) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'week':
                    startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case '3months':
                    startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                    break;
                case '6months':
                    startDate = new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                case 'all':
                    startDate = new Date(0);
                    break;
            }
            
            const filtered = allStreamsData.filter(s => {
                if (!s.ts || s.ms_played < 30000) return false;
                const d = new Date(s.ts);
                return d >= startDate;
            });
            
            const analysis = analyzeStreams(filtered);
            const topSong = Object.values(analysis.trackStats).sort((a, b) => b.playCount - a.playCount)[0];
            const topArtist = Object.values(analysis.artistStats).sort((a, b) => b.playCount - a.playCount)[0];
            
            const rangeNames = {
                today: 'Today',
                week: 'This Week',
                month: 'This Month',
                '3months': 'Last 3 Months',
                '6months': 'Last 6 Months',
                year: 'This Year',
                all: 'All Time'
            };
            
            document.getElementById('timeRangeResults').innerHTML = `
                <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9)); color: white; padding: 30px; border-radius: 20px;">
                    <h3 style="margin-bottom: 20px; font-size: 1.8em;">ğŸ“… ${rangeNames[range]}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div>
                            <p style="opacity: 0.9; margin-bottom: 5px;">ğŸ“Š Total Streams</p>
                            <p style="font-size: 2em; font-weight: bold;">${filtered.length.toLocaleString()}</p>
                        </div>
                        <div>
                            <p style="opacity: 0.9; margin-bottom: 5px;">â±ï¸ Hours Listened</p>
                            <p style="font-size: 2em; font-weight: bold;">${(filtered.reduce((s, st) => s + (st.ms_played || 0), 0) / (1000 * 60 * 60)).toFixed(1)}h</p>
                        </div>
                    </div>
                    <div style="margin-top: 25px; padding-top: 25px; border-top: 1px solid rgba(255,255,255,0.3);">
                        <p style="opacity: 0.9;">ğŸ† Top Song</p>
                        <p style="font-size: 1.3em; font-weight: bold; margin: 5px 0;">${topSong?.track || 'N/A'}</p>
                        <p style="opacity: 0.8;">by ${topSong?.artist || 'N/A'}</p>
                    </div>
                    <div style="margin-top: 20px;">
                        <p style="opacity: 0.9;">ğŸ‘‘ Top Artist</p>
                        <p style="font-size: 1.3em; font-weight: bold; margin: 5px 0;">${topArtist?.artist || 'N/A'}</p>
                        <p style="opacity: 0.8;">${topArtist?.playCount || 0} plays</p>
                    </div>
                </div>
            `;
        }
        
        // Random Discovery Functions
        function showRandomSong() {
            const validSongs = Object.values(getCachedAnalysis().trackStats);
            const random = validSongs[Math.floor(Math.random() * validSongs.length)];
            
            document.getElementById('randomResults').innerHTML = `
                <div style="background: linear-gradient(135deg, #f093fb, #4facfe); color: white; padding: 30px; border-radius: 20px; text-align: center;">
                    <h2 style="margin-bottom: 20px;">ğŸ² Random Song</h2>
                    <h3 style="font-size: 2em; margin: 20px 0;">${random.track}</h3>
                    <p style="font-size: 1.3em; opacity: 0.9;">by ${random.artist}</p>
                    <p style="margin-top: 20px; opacity: 0.8;">You've played this ${random.playCount} times</p>
                    <button onclick="showRandomSong()" style="margin-top: 20px; background: white; color: #667eea;">ğŸ”„ Another One</button>
                </div>
            `;
        }
        
        function showRandomArtist() {
            const validArtists = Object.values(getCachedAnalysis().artistStats);
            const random = validArtists[Math.floor(Math.random() * validArtists.length)];
            
            document.getElementById('randomResults').innerHTML = `
                <div style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; padding: 30px; border-radius: 20px; text-align: center;">
                    <h2 style="margin-bottom: 20px;">ğŸ­ Random Artist</h2>
                    <h3 style="font-size: 2em; margin: 20px 0;">${random.artist}</h3>
                    <p style="margin-top: 20px; opacity: 0.8;">
                        ${random.playCount} plays â€¢ ${random.tracks.size} unique songs
                    </p>
                    <button onclick="showRandomArtist()" style="margin-top: 20px; background: white; color: #667eea;">ğŸ”„ Another One</button>
                </div>
            `;
        }
        
        function showForgottenGems() {
            const oldSongs = Object.values(getCachedAnalysis().trackStats)
                .filter(t => {
                    const daysSince = (new Date() - new Date(t.lastPlayed)) / (1000 * 60 * 60 * 24);
                    return daysSince > 180 && t.playCount >= 3; // Not played in 6 months but played 3+ times
                })
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 10);
            
            displaySongList(oldSongs, 'ğŸ’ Forgotten Gems (Not played in 6+ months)', 'randomResults');
        }
        
        function showDeepCuts() {
            const deepCuts = Object.values(getCachedAnalysis().trackStats)
                .filter(t => t.playCount >= 2 && t.playCount <= 5)
                .sort(() => Math.random() - 0.5)
                .slice(0, 10);
            
            displaySongList(deepCuts, 'ğŸ¸ Deep Cuts (Played 2-5 times)', 'randomResults');
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };
            
            for (const [name, value] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / value);
                if (interval >= 1) {
                    return `${interval} ${name}${interval > 1 ? 's' : ''} ago`;
                }
            }
            return 'Just now';
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            if (query.length < 2) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }

            const results = [];
            const seen = new Set();
            
            allStreamsData.forEach(stream => {
                const track = stream.master_metadata_track_name || '';
                const artist = stream.master_metadata_album_artist_name || '';
                const key = `${track}|||${artist}`;
                
                if (seen.has(key)) return;
                
                if (track.toLowerCase().includes(query) || artist.toLowerCase().includes(query)) {
                    results.push({ track, artist, key });
                    seen.add(key);
                }
            });

            const { trackStats } = analyzeStreams(allStreamsData);
            const resultsHtml = results.slice(0, 50).map(r => {
                const stats = trackStats[r.key] || { playCount: 0, totalMs: 0 };
                return `
                    <div class="song-item" style="margin-bottom: 10px;">
                        <div class="song-name">${r.track}</div>
                        <div class="artist-name">${r.artist}</div>
                        <div class="stats">â–¶ï¸ ${stats.playCount} plays â€¢ â±ï¸ ${(stats.totalMs / (1000 * 60 * 60)).toFixed(2)}h</div>
                    </div>
                `;
            }).join('');

            document.getElementById('searchResults').innerHTML = results.length > 0 
                ? `<h4>Found ${results.length} results:</h4>${resultsHtml}`
                : '<p style="color: var(--text-primary);">No results found</p>';
        }

        let filteredData = null;

        function applyDateFilter() {
            const start = document.getElementById('filterStartDate').value;
            const end = document.getElementById('filterEndDate').value;
            
            if (!start || !end) {
                alert('Please select both start and end dates');
                return;
            }

            const startDate = new Date(start);
            const endDate = new Date(end);
            
            filteredData = allStreamsData.filter(stream => {
                if (!stream.ts) return false;
                const streamDate = new Date(stream.ts);
                return streamDate >= startDate && streamDate <= endDate;
            });

            document.getElementById('filterStatus').textContent = 
                `âœ… Filter applied: ${filteredData.length.toLocaleString()} streams from ${start} to ${end}`;
            
            alert(`Filter applied! Found ${filteredData.length.toLocaleString()} streams in this date range.`);
        }

        function clearDateFilter() {
            filteredData = null;
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterStatus').textContent = '';
        }

        function comparePeriods() {
            // Get dates from sliders
            const p1Start = getDateFromSlider('period1StartSlider');
            const p1End = getDateFromSlider('period1EndSlider');
            const p2Start = getDateFromSlider('period2StartSlider');
            const p2End = getDateFromSlider('period2EndSlider');
            
            if (!p1Start || !p1End || !p2Start || !p2End) {
                alert('Unable to get date ranges. Please try adjusting the sliders.');
                return;
            }

            const period1 = allStreamsData.filter(s => {
                if (!s.ts) return false;
                const d = new Date(s.ts);
                return d >= p1Start && d <= p1End && s.ms_played >= 30000;
            });

            const period2 = allStreamsData.filter(s => {
                if (!s.ts) return false;
                const d = new Date(s.ts);
                return d >= p2Start && d <= p2End && s.ms_played >= 30000;
            });

            const p1Analysis = analyzeStreams(period1);
            const p2Analysis = analyzeStreams(period2);

            const p1Top = Object.values(p1Analysis.trackStats).sort((a, b) => b.playCount - a.playCount)[0];
            const p2Top = Object.values(p2Analysis.trackStats).sort((a, b) => b.playCount - a.playCount)[0];
            
            const p1ArtistTop = Object.values(p1Analysis.artistStats).sort((a, b) => b.playCount - a.playCount)[0];
            const p2ArtistTop = Object.values(p2Analysis.artistStats).sort((a, b) => b.playCount - a.playCount)[0];
            
            const p1Hours = (period1.reduce((sum, s) => sum + (s.ms_played || 0), 0) / (1000 * 60 * 60)).toFixed(1);
            const p2Hours = (period2.reduce((sum, s) => sum + (s.ms_played || 0), 0) / (1000 * 60 * 60)).toFixed(1);

            const html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85)); padding: 30px; border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
                    <div style="border-right: 2px solid #e0e0e0; padding-right: 20px;">
                        <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.3em;">ğŸ“… Period 1</h3>
                        <div style="line-height: 2;">
                            <p><strong>ğŸ“Š Total Streams:</strong> ${period1.length.toLocaleString()}</p>
                            <p><strong>ğŸµ Unique Songs:</strong> ${Object.keys(p1Analysis.trackStats).length.toLocaleString()}</p>
                            <p><strong>ğŸ¤ Unique Artists:</strong> ${Object.keys(p1Analysis.artistStats).length.toLocaleString()}</p>
                            <p><strong>â±ï¸ Hours Listened:</strong> ${p1Hours}h</p>
                            <p style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;"><strong>ğŸ† Top Song:</strong><br>${p1Top?.track || 'N/A'}<br><em style="color: var(--text-primary); font-size: 0.9em;">${p1Top?.artist || ''} (${p1Top?.playCount || 0} plays)</em></p>
                            <p style="margin-top: 10px;"><strong>ğŸ‘‘ Top Artist:</strong><br>${p1ArtistTop?.artist || 'N/A'}<br><em style="color: var(--text-primary); font-size: 0.9em;">(${p1ArtistTop?.playCount || 0} plays)</em></p>
                        </div>
                    </div>
                    <div style="padding-left: 20px;">
                        <h3 style="color: #764ba2; margin-bottom: 20px; font-size: 1.3em;">ğŸ“… Period 2</h3>
                        <div style="line-height: 2;">
                            <p><strong>ğŸ“Š Total Streams:</strong> ${period2.length.toLocaleString()}</p>
                            <p><strong>ğŸµ Unique Songs:</strong> ${Object.keys(p2Analysis.trackStats).length.toLocaleString()}</p>
                            <p><strong>ğŸ¤ Unique Artists:</strong> ${Object.keys(p2Analysis.artistStats).length.toLocaleString()}</p>
                            <p><strong>â±ï¸ Hours Listened:</strong> ${p2Hours}h</p>
                            <p style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;"><strong>ğŸ† Top Song:</strong><br>${p2Top?.track || 'N/A'}<br><em style="color: var(--text-primary); font-size: 0.9em;">${p2Top?.artist || ''} (${p2Top?.playCount || 0} plays)</em></p>
                            <p style="margin-top: 10px;"><strong>ğŸ‘‘ Top Artist:</strong><br>${p2ArtistTop?.artist || 'N/A'}<br><em style="color: var(--text-primary); font-size: 0.9em;">(${p2ArtistTop?.playCount || 0} plays)</em></p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('comparisonResults').innerHTML = html;
        }

        function generateWrapped() {
            const analysis = analyzeStreams(allStreamsData);
            const topTrack = Object.values(analysis.trackStats).sort((a, b) => b.playCount - a.playCount)[0];
            const topArtist = Object.values(analysis.artistStats).sort((a, b) => b.playCount - a.playCount)[0];
            
            const wrapped = `
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 40px; border-radius: 20px; text-align: center;">
                    <h1 style="font-size: 2.5em; margin-bottom: 30px;">ğŸ Your Music Wrapped</h1>
                    <div style="font-size: 1.2em; line-height: 2;">
                        <p>âœ¨ You streamed <strong>${allStreamsData.filter(s => s.ms_played >= 30000).length.toLocaleString()}</strong> songs</p>
                        <p>ğŸµ Discovered <strong>${Object.keys(analysis.trackStats).length.toLocaleString()}</strong> unique tracks</p>
                        <p>ğŸ¤ Listened to <strong>${Object.keys(analysis.artistStats).length.toLocaleString()}</strong> artists</p>
                        <p>â±ï¸ Spent <strong>${(allStreamsData.reduce((s, st) => s + (st.ms_played || 0), 0) / (1000 * 60 * 60)).toFixed(0)}</strong> hours listening</p>
                        <p style="margin-top: 30px; font-size: 1.3em;">ğŸ† Your top song: <strong>${topTrack?.track || 'N/A'}</strong></p>
                        <p style="font-size: 1.3em;">ğŸ‘‘ Your top artist: <strong>${topArtist?.artist || 'N/A'}</strong></p>
                    </div>
                </div>
            `;
            
            document.getElementById('exportOutput').innerHTML = wrapped;
        }

        function exportTopLists() {
            const analysis = analyzeStreams(allStreamsData);
            const topTracks = Object.values(analysis.trackStats)
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 50);
            const topArtists = Object.values(analysis.artistStats)
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 25);

            let text = "YOUR TOP 50 SONGS\n\n";
            topTracks.forEach((t, i) => {
                text += `${i + 1}. ${t.track} - ${t.artist} (${t.playCount} plays)\n`;
            });
            
            text += "\n\nYOUR TOP 25 ARTISTS\n\n";
            topArtists.forEach((a, i) => {
                text += `${i + 1}. ${a.artist} (${a.playCount} plays)\n`;
            });

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my-spotify-top-lists.txt';
            a.click();
            
            document.getElementById('exportOutput').innerHTML = 
                '<p style="color: #667eea; font-weight: 600;">âœ… Downloaded! Check your downloads folder.</p>';
        }

        function generatePlaylist() {
            const analysis = analyzeStreams(allStreamsData);
            const topTracks = Object.values(analysis.trackStats)
                .sort((a, b) => b.playCount - a.playCount)
                .slice(0, 50);

            let text = "# My Top 50 Playlist\n\n";
            topTracks.forEach((t, i) => {
                text += `${i + 1}. ${t.track} - ${t.artist}\n`;
            });

            document.getElementById('exportOutput').innerHTML = `
                <div class="subsection">
                    <h3>ğŸµ Your Top 50 Playlist</h3>
                    <textarea readonly style="width: 100%; height: 300px; padding: 15px; border-radius: 8px; border: 2px solid #e0e0e0; font-family: monospace;">${text}</textarea>
                    <p style="margin-top: 15px; color: var(--text-primary);">Copy this list and paste it into your favorite music app to create a playlist!</p>
                </div>
            `;
        }

        function shareStats() {
            const analysis = analyzeStreams(allStreamsData);
            const topArtist = Object.values(analysis.artistStats).sort((a, b) => b.playCount - a.playCount)[0];
            
            const card = `
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; border-radius: 15px; max-width: 400px; margin: 0 auto;">
                    <h2 style="text-align: center; margin-bottom: 20px;">ğŸµ My Music Stats</h2>
                    <p>ğŸ¶ ${allStreamsData.filter(s => s.ms_played >= 30000).length.toLocaleString()} total streams</p>
                    <p>ğŸ¤ Top artist: ${topArtist?.artist || 'N/A'}</p>
                    <p>â±ï¸ ${(allStreamsData.reduce((s, st) => s + (st.ms_played || 0), 0) / (1000 * 60 * 60)).toFixed(0)} hours of music</p>
                    <p style="text-align: center; margin-top: 20px; font-size: 0.9em;">Created with Spotify Analyzer</p>
                </div>
            `;
            
            document.getElementById('exportOutput').innerHTML = card + 
                '<p style="margin-top: 15px; text-align: center; color: var(--text-primary);">Take a screenshot to share on social media!</p>';
        }

        // Add decade chart and work/leisure chart

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATEDECADECHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createDecadeChart() {
            updateDecadeChart();
        }
        

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // UPDATEDECADECHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updateDecadeChart() {
            try {
                const chartType = document.getElementById('decadeChartType')?.value || 'bar';
                const sortBy = document.getElementById('decadeSortBy')?.value || 'playCount';
                const display = document.getElementById('decadeDisplay')?.value || 'all';
                
                // Calculate decade data
                const decades = {
                    '1960s': 0, '1970s': 0, '1980s': 0, '1990s': 0,
                    '2000s': 0, '2010s': 0, '2020s': 0
                };
                
                allStreamsData.forEach(stream => {
                    if (!stream.ms_played || stream.ms_played < 30000) return;
                    
                    const combined = ((stream.master_metadata_track_name || '') + ' ' + 
                                     (stream.master_metadata_album_artist_name || '')).toLowerCase();
                    
                    // Simple heuristic based on artist era patterns
                    if (combined.match(/\b(beatles|stones|hendrix|zeppelin|pink floyd|queen early)\b/)) {
                        decades['1960s']++;
                    } else if (combined.match(/\b(disco|bee gees|abba|donna summer|fleetwood)\b/)) {
                        decades['1970s']++;
                    } else if (combined.match(/\b(madonna|michael jackson|prince|80s|eighties|synth)\b/)) {
                        decades['1980s']++;
                    } else if (combined.match(/\b(nirvana|grunge|90s|nineties|britpop|tupac|biggie)\b/)) {
                        decades['1990s']++;
                    } else if (combined.match(/\b(2000s|eminem early|50 cent|linkin park|coldplay early)\b/)) {
                        decades['2000s']++;
                    } else if (combined.match(/\b(2010s|2011|2012|2013|2014|2015|2016|2017|2018|2019)\b/)) {
                        decades['2010s']++;
                    } else if (combined.match(/\b(2020|2021|2022|2023|2024|2025)\b/)) {
                        decades['2020s']++;
                    } else {
                        // Default to 2020s for modern music
                        decades['2020s']++;
                    }
                });

                // Convert to array for filtering/sorting
                let decadeArray = Object.entries(decades).map(([decade, count]) => ({
                    decade,
                    count
                }));
                
                // Apply display filter
                switch(display) {
                    case 'top5':
                        decadeArray = decadeArray
                            .sort((a, b) => b.count - a.count)
                            .slice(0, 5);
                        break;
                    case 'top10':
                        decadeArray = decadeArray
                            .sort((a, b) => b.count - a.count)
                            .slice(0, 10);
                        break;
                    case 'modern':
                        decadeArray = decadeArray.filter(d => 
                            ['2000s', '2010s', '2020s'].includes(d.decade)
                        );
                        break;
                    case 'vintage':
                        decadeArray = decadeArray.filter(d => 
                            ['1960s', '1970s', '1980s', '1990s'].includes(d.decade)
                        );
                        break;
                }
                
                // Apply sorting
                switch(sortBy) {
                    case 'chronological':
                        // Already in chronological order
                        break;
                    case 'reverse':
                        decadeArray.reverse();
                        break;
                    case 'playCount':
                    case 'timeListened':
                        decadeArray.sort((a, b) => b.count - a.count);
                        break;
                }
                
                const labels = decadeArray.map(d => d.decade);
                const data = decadeArray.map(d => d.count);
                
                // Destroy existing chart
                if (charts.decade) {
                    charts.decade.destroy();
                }
                
                const ctx = document.getElementById('decadeChart').getContext('2d');
                charts.decade = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Streams by Decade',
                            data: data,
                            backgroundColor: [
                                'rgba(136, 169, 128, 0.8)',
                                'rgba(106, 135, 99, 0.8)',
                                'rgba(168, 201, 160, 0.8)',
                                'rgba(90, 113, 83, 0.8)',
                                'rgba(196, 212, 200, 0.8)',
                                'rgba(138, 157, 135, 0.8)',
                                'rgba(122, 145, 117, 0.8)'
                            ],
                            borderColor: [
                                'rgba(136, 169, 128, 1)',
                                'rgba(106, 135, 99, 1)',
                                'rgba(168, 201, 160, 1)',
                                'rgba(90, 113, 83, 1)',
                                'rgba(196, 212, 200, 1)',
                                'rgba(138, 157, 135, 1)',
                                'rgba(122, 145, 117, 1)'
                            ],
                            borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ğŸ¸ Music by Decade',
                            font: { size: 18, weight: 'bold' },
                            color: '#a8c9a0'
                        },
                        legend: {
                            display: ['pie', 'doughnut', 'polarArea'].includes(chartType),
                            labels: {
                                color: '#c4d4c8'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 40, 35, 0.9)',
                            titleColor: '#c4d4c8',
                            bodyColor: '#a8c9a0',
                            borderColor: '#6a8763',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const value = chartType === 'line' ? context.parsed.y : (context.parsed?.y || context.parsed);
                                    const total = data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${value.toLocaleString()} streams (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: ['pie', 'doughnut', 'polarArea'].includes(chartType) ? {} : {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                },
                                color: '#8a9d87'
                            },
                            grid: {
                                color: 'rgba(106, 135, 99, 0.2)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#8a9d87'
                            }
                        }
                    }
                }
            });
            
            console.log('âœ… Decade chart updated');
            } catch (error) {
                console.error('âŒ Error updating decade chart:', error);
            }
        }


        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CREATEWORKLEISURECHART
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function createWorkLeisureChart() {
            const workHours = { count: 0 };
            const leisureHours = { count: 0 };
            
            allStreamsData.forEach(stream => {
                if (!stream.ts || !stream.ms_played || stream.ms_played < 30000) return;
                
                const hour = new Date(stream.ts).getHours();
                if (hour >= 9 && hour < 17) {
                    workHours.count++;
                } else {
                    leisureHours.count++;
                }
            });

            const ctx = document.getElementById('workLeisureChart').getContext('2d');
            charts.workLeisure = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ğŸ’¼ Work Hours (9am-5pm)', 'ğŸ–ï¸ Leisure Hours'],
                    datasets: [{
                        data: [workHours.count, leisureHours.count],
                        backgroundColor: ['#667eea', '#f093fb'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ğŸ’¼ Work vs Leisure Listening',
                            font: { size: 18, weight: 'bold' },
                            color: '#333'
                        },
                        legend: { position: 'right' }
                    }
                }
            });
        }
        
        /* ============================================================
           NEW FEATURES - ALL JAVASCRIPT FUNCTIONS
           ============================================================ */
        
        // FEATURE 2: ACHIEVEMENTS SYSTEM
        // ================================
        
        const ACHIEVEMENTS = [
            {
                id: 'milestone_hunter',
                icon: 'ğŸ¯',
                title: 'Milestone Hunter',
                description: '1,000+ total streams',
                check: (stats) => stats.totalStreams >= 1000,
                progress: (stats) => Math.min(100, (stats.totalStreams / 1000) * 100)
            },
            {
                id: 'genre_explorer',
                icon: 'ğŸŒ',
                title: 'Genre Explorer',
                description: 'Listened to 20+ genres',
                check: (stats) => stats.genreCount >= 20,
                progress: (stats) => Math.min(100, (stats.genreCount / 20) * 100)
            },
            {
                id: 'night_owl',
                icon: 'ğŸ¦‰',
                title: 'Night Owl',
                description: '100+ songs after midnight',
                check: (stats) => stats.nightStreams >= 100,
                progress: (stats) => Math.min(100, (stats.nightStreams / 100) * 100)
            },
            {
                id: 'binge_master',
                icon: 'ğŸ“š',
                title: 'Binge Master',
                description: '10+ hours in one day',
                check: (stats) => stats.maxDayHours >= 10,
                progress: (stats) => Math.min(100, (stats.maxDayHours / 10) * 100)
            },
            {
                id: 'loyalty_champion',
                icon: 'ğŸ’',
                title: 'Loyalty Champion',
                description: 'Same song 100+ times',
                check: (stats) => stats.maxSongPlays >= 100,
                progress: (stats) => Math.min(100, (stats.maxSongPlays / 100) * 100)
            },
            {
                id: 'top_fan',
                icon: 'â­',
                title: 'Top Fan',
                description: 'Artist played 500+ times',
                check: (stats) => stats.maxArtistPlays >= 500,
                progress: (stats) => Math.min(100, (stats.maxArtistPlays / 500) * 100)
            },
            {
                id: 'deep_listener',
                icon: 'ğŸµ',
                title: 'Deep Listener',
                description: '500+ hours total',
                check: (stats) => stats.totalHours >= 500,
                progress: (stats) => Math.min(100, (stats.totalHours / 500) * 100)
            },
            {
                id: 'early_bird',
                icon: 'ğŸŒ…',
                title: 'Early Bird',
                description: '100+ songs before 7am',
                check: (stats) => stats.earlyStreams >= 100,
                progress: (stats) => Math.min(100, (stats.earlyStreams / 100) * 100)
            },
            {
                id: 'streak_master',
                icon: 'ğŸ”¥',
                title: 'Streak Master',
                description: '30+ consecutive days',
                check: (stats) => stats.maxStreak >= 30,
                progress: (stats) => Math.min(100, (stats.maxStreak / 30) * 100)
            },
            {
                id: 'variety_seeker',
                icon: 'ğŸ­',
                title: 'Variety Seeker',
                description: '1,000+ unique songs',
                check: (stats) => stats.uniqueTracks >= 1000,
                progress: (stats) => Math.min(100, (stats.uniqueTracks / 1000) * 100)
            }
        ];
        

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CALCULATEACHIEVEMENTSTATS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function calculateAchievementStats() {
            const validStreams = allStreamsData.filter(s => s.ms_played >= 30000);
            const analysis = analyzeStreams(validStreams);
            
            // Night streams (12am - 6am)
            const nightStreams = validStreams.filter(s => {
                const hour = new Date(s.ts).getHours();
                return hour >= 0 && hour < 6;
            }).length;
            
            // Early streams (before 7am)
            const earlyStreams = validStreams.filter(s => {
                const hour = new Date(s.ts).getHours();
                return hour < 7;
            }).length;
            
            // Max day hours
            const dayHours = {};
            validStreams.forEach(s => {
                const day = new Date(s.ts).toDateString();
                dayHours[day] = (dayHours[day] || 0) + s.ms_played;
            });
            const maxDayHours = Object.keys(dayHours).length > 0 ? 
                Math.max(...Object.values(dayHours)) / (1000 * 60 * 60) : 0;
            
            // Max song/artist plays
            const trackValues = Object.values(analysis.trackStats);
            const artistValues = Object.values(analysis.artistStats);
            const maxSongPlays = trackValues.length > 0 ? Math.max(...trackValues.map(t => t.playCount)) : 0;
            const maxArtistPlays = artistValues.length > 0 ? Math.max(...artistValues.map(a => a.playCount)) : 0;
            
            // Streak calculation
            const days = [...new Set(validStreams.map(s => new Date(s.ts).toDateString()))].sort();
            let maxStreak = 0;
            let currentStreak = 1;
            for (let i = 1; i < days.length; i++) {
                const diff = (new Date(days[i]) - new Date(days[i-1])) / (1000 * 60 * 60 * 24);
                if (diff === 1) {
                    currentStreak++;
                    maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                    currentStreak = 1;
                }
            }
            
            return {
                totalStreams: validStreams.length,
                totalHours: validStreams.reduce((sum, s) => sum + s.ms_played, 0) / (1000 * 60 * 60),
                genreCount: Object.keys(analysis.genreStats).length,
                uniqueTracks: Object.keys(analysis.trackStats).length,
                nightStreams,
                earlyStreams,
                maxDayHours,
                maxSongPlays,
                maxArtistPlays,
                maxStreak
            };
        }
        

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // DISPLAYACHIEVEMENTS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function displayAchievements() {
            const stats = calculateAchievementStats();
            const grid = document.getElementById('achievementsGrid');
            
            if (!grid) return;
            
            grid.innerHTML = ACHIEVEMENTS.map(achievement => {
                const unlocked = achievement.check(stats);
                const progress = achievement.progress(stats);
                
                return `
                    <div class="achievement-card ${unlocked ? 'unlocked' : 'locked'}">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <h4 style="color: var(--text-primary); margin: 10px 0 5px 0; font-size: 1.1em;">${achievement.title}</h4>
                        <p style="color: var(--text-secondary); font-size: 0.85em; margin-bottom: 10px;">${achievement.description}</p>
                        ${unlocked ? 
                            '<div style="color: var(--color-primary); font-weight: 600; font-size: 1.1em;">âœ“ UNLOCKED</div>' :
                            `<div class="achievement-progress">
                                <div class="achievement-progress-bar" style="width: ${progress}%"></div>
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 8px;">
                                ${Math.floor(progress)}% Complete
                            </div>`
                        }
                    </div>
                `;
            }).join('');
            
            console.log('âœ… Achievements displayed');
        }
        
        // FEATURE 3: YEAR COMPARISON
        // ============================
        
        function populateYearSelectors() {
            const years = [...new Set(allStreamsData.map(s => new Date(s.ts).getFullYear()))].sort();
            const select1 = document.getElementById('compareYear1');
            const select2 = document.getElementById('compareYear2');
            
            if (!select1 || !select2) return;
            
            select1.innerHTML = '';
            select2.innerHTML = '';
            
            years.forEach(year => {
                select1.add(new Option(year, year));
                select2.add(new Option(year, year));
            });
            
            if (years.length >= 2) {
                select1.value = years[years.length - 2];
                select2.value = years[years.length - 1];
            }
        }
        
        function runComparison() {
            const year1 = parseInt(document.getElementById('compareYear1').value);
            const year2 = parseInt(document.getElementById('compareYear2').value);
            
            if (year1 === year2) {
                alert('Please select two different years to compare!');
                return;
            }
            
            const data1 = allStreamsData.filter(s => new Date(s.ts).getFullYear() === year1 && s.ms_played >= 30000);
            const data2 = allStreamsData.filter(s => new Date(s.ts).getFullYear() === year2 && s.ms_played >= 30000);
            
            const analysis1 = analyzeStreams(data1);
            const analysis2 = analyzeStreams(data2);
            
            const stats1 = {
                streams: data1.length,
                hours: data1.reduce((sum, s) => sum + s.ms_played, 0) / (1000 * 60 * 60),
                artists: Object.keys(analysis1.artistStats).length,
                tracks: Object.keys(analysis1.trackStats).length,
                topArtist: Object.values(analysis1.artistStats).sort((a, b) => b.playCount - a.playCount)[0]?.artist || 'N/A',
                topSong: Object.values(analysis1.trackStats).sort((a, b) => b.playCount - a.playCount)[0]?.track || 'N/A'
            };
            
            const stats2 = {
                streams: data2.length,
                hours: data2.reduce((sum, s) => sum + s.ms_played, 0) / (1000 * 60 * 60),
                artists: Object.keys(analysis2.artistStats).length,
                tracks: Object.keys(analysis2.trackStats).length,
                topArtist: Object.values(analysis2.artistStats).sort((a, b) => b.playCount - a.playCount)[0]?.artist || 'N/A',
                topSong: Object.values(analysis2.trackStats).sort((a, b) => b.playCount - a.playCount)[0]?.track || 'N/A'
            };
            
            // Display comparison
            document.getElementById('comparisonResults').style.display = 'block';
            const grid = document.getElementById('comparisonGrid');
            
            const metrics = [
                { label: 'ğŸµ Total Streams', key: 'streams' },
                { label: 'â±ï¸ Hours Listened', key: 'hours' },
                { label: 'ğŸ¤ Unique Artists', key: 'artists' },
                { label: 'ğŸ¶ Unique Songs', key: 'tracks' }
            ];
            
            grid.innerHTML = metrics.map(metric => {
                const val1 = metric.key === 'hours' ? stats1[metric.key].toFixed(0) : stats1[metric.key];
                const val2 = metric.key === 'hours' ? stats2[metric.key].toFixed(0) : stats2[metric.key];
                const change = ((val2 - val1) / val1 * 100).toFixed(1);
                const isPositive = val2 >= val1;
                
                return `
                    <div class="comparison-stat-card">
                        <h3 style="color: var(--text-secondary); font-size: 1em; margin-bottom: 20px;">${metric.label}</h3>
                        <div class="comparison-years">
                            <div class="comparison-year-data">
                                <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px;">${year1}</div>
                                <div class="value" style="font-size: 2em;">${typeof val1 === 'number' ? val1.toLocaleString() : val1}</div>
                            </div>
                            <div class="comparison-divider"></div>
                            <div class="comparison-year-data">
                                <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 5px;">${year2}</div>
                                <div class="value" style="font-size: 2em;">${typeof val2 === 'number' ? val2.toLocaleString() : val2}</div>
                            </div>
                        </div>
                        <div class="comparison-change ${isPositive ? 'positive' : 'negative'}">
                            ${isPositive ? 'ğŸ“ˆ' : 'ğŸ“‰'} ${isPositive ? '+' : ''}${change}%
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add top artist/song comparison
            grid.innerHTML += `
                <div class="comparison-stat-card" style="grid-column: 1 / -1;">
                    <h3 style="color: var(--text-secondary); font-size: 1em; margin-bottom: 20px;">ğŸ¤ Top Artist</h3>
                    <div class="comparison-years">
                        <div class="comparison-year-data">
                            <div style="font-size: 0.9em; color: var(--text-secondary);">${year1}</div>
                            <div style="font-size: 1.3em; color: var(--text-primary); margin-top: 10px;">${stats1.topArtist}</div>
                        </div>
                        <div class="comparison-divider"></div>
                        <div class="comparison-year-data">
                            <div style="font-size: 0.9em; color: var(--text-secondary);">${year2}</div>
                            <div style="font-size: 1.3em; color: var(--text-primary); margin-top: 10px;">${stats2.topArtist}</div>
                        </div>
                    </div>
                </div>
            `;
            
            console.log('âœ… Year comparison complete');
        }
        
        // FEATURE 4: SHAREABLE CARDS
        // ============================
        
        function generateCard(type) {
            const preview = document.getElementById('cardPreview');
            const validStreams = allStreamsData.filter(s => s.ms_played >= 30000);
            const analysis = analyzeStreams(validStreams);
            
            let cardHTML = '';
            
            if (type === 'top-stats') {
                const totalStreams = validStreams.length;
                const totalHours = Math.floor(allStreamsData.reduce((sum, s) => sum + s.ms_played, 0) / (1000 * 60 * 60));
                const topArtist = Object.values(analysis.artistStats).sort((a, b) => b.playCount - a.playCount)[0];
                const topSong = Object.values(analysis.trackStats).sort((a, b) => b.playCount - a.playCount)[0];
                
                cardHTML = `
                    <div class="share-card" id="shareCardContent">
                        <h1>ğŸµ My Music Stats</h1>
                        <div class="share-card-stat">ğŸ¶ ${totalStreams.toLocaleString()} streams</div>
                        <div class="share-card-stat">â±ï¸ ${totalHours.toLocaleString()} hours</div>
                        <div class="share-card-stat">ğŸ¤ ${topArtist?.artist || 'N/A'}</div>
                        <div class="share-card-stat">ğŸµ ${topSong?.track || 'N/A'}</div>
                        <div class="share-card-footer">Created with Spotify Analyzer ğŸŒ¿</div>
                    </div>
                `;
            } else if (type === 'year-review') {
                const currentYear = new Date().getFullYear();
                const yearData = allStreamsData.filter(s => new Date(s.ts).getFullYear() === currentYear && s.ms_played >= 30000);
                const yearAnalysis = analyzeStreams(yearData);
                const topArtist = Object.values(yearAnalysis.artistStats).sort((a, b) => b.playCount - a.playCount)[0];
                
                cardHTML = `
                    <div class="share-card" id="shareCardContent">
                        <h1>ğŸ‰ ${currentYear} in Music</h1>
                        <div class="share-card-stat">ğŸ¶ ${yearData.length.toLocaleString()} streams</div>
                        <div class="share-card-stat">ğŸ¤ Top: ${topArtist?.artist || 'N/A'}</div>
                        <div class="share-card-stat">ğŸ¸ ${Object.keys(yearAnalysis.genreStats).length} genres</div>
                        <div class="share-card-footer">My Year in Music ğŸŒ¿</div>
                    </div>
                `;
            } else if (type === 'top-songs') {
                const topSongs = Object.values(analysis.trackStats)
                    .sort((a, b) => b.playCount - a.playCount)
                    .slice(0, 5);
                
                cardHTML = `
                    <div class="share-card" id="shareCardContent">
                        <h1>ğŸµ My Top 5 Songs</h1>
                        ${topSongs.map((song, i) => `
                            <div class="share-card-stat" style="font-size: 1.2em;">
                                ${i + 1}. ${song.track}
                            </div>
                        `).join('')}
                        <div class="share-card-footer">My Top Tracks ğŸŒ¿</div>
                    </div>
                `;
            } else if (type === 'personality') {
                const nightStreams = validStreams.filter(s => {
                    const hour = new Date(s.ts).getHours();
                    return hour >= 22 || hour < 6;
                }).length;
                const nightPercent = (nightStreams / validStreams.length * 100).toFixed(0);
                const diversity = Object.keys(analysis.genreStats).length;
                
                let personality = nightPercent > 30 ? 'ğŸ¦‰ Night Owl' : 'ğŸŒ… Early Bird';
                if (diversity > 30) personality += ' â€¢ ğŸŒ Genre Explorer';
                
                cardHTML = `
                    <div class="share-card" id="shareCardContent">
                        <h1>ğŸ­ Music Personality</h1>
                        <div class="share-card-stat" style="font-size: 2.5em;">${personality}</div>
                        <div class="share-card-stat">${nightPercent}% night listening</div>
                        <div class="share-card-stat">${diversity} different genres</div>
                        <div class="share-card-footer">My Listening Style ğŸŒ¿</div>
                    </div>
                `;
            }
            
            preview.innerHTML = cardHTML + `
                <button class="download-button" onclick="downloadCard()">ğŸ“¥ Save as Image</button>
                <p style="color: var(--text-secondary); margin-top: 15px; font-size: 0.9em;">
                    Right-click the card and "Save image as..." or take a screenshot!
                </p>
            `;
            
            console.log('âœ… Card generated:', type);
        }
        
        function downloadCard() {
            alert('ğŸ’¡ Tip: Right-click on the card above and select "Save image as..." or take a screenshot!\n\nFor automatic downloads, you would need the html2canvas library.');
        }
        
        // FEATURE 5: HEAT MAP CALENDAR
        // ==============================
        
        function populateHeatmapYears() {
            const years = [...new Set(allStreamsData.map(s => new Date(s.ts).getFullYear()))].sort();
            const select = document.getElementById('heatmapYear');
            
            if (!select) return;
            
            select.innerHTML = '';
            years.forEach(year => {
                select.add(new Option(year, year));
            });
            
            if (years.length > 0) {
                select.value = years[years.length - 1];
                generateHeatmap(years[years.length - 1]);
            }
        }
        

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // UPDATEHEATMAP
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function updateHeatmap() {
            const year = parseInt(document.getElementById('heatmapYear').value);
            generateHeatmap(year);
        }
        
        function generateHeatmap(year) {
            const yearData = allStreamsData.filter(s => {
                const date = new Date(s.ts);
                return date.getFullYear() === year && s.ms_played >= 30000;
            });
            
            // Group by date
            const dailyCounts = {};
            yearData.forEach(s => {
                const date = new Date(s.ts).toDateString();
                dailyCounts[date] = (dailyCounts[date] || 0) + 1;
            });
            
            // Generate calendar grid
            const startDate = new Date(year, 0, 1);
            const endDate = new Date(year, 11, 31);
            const days = [];
            
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toDateString();
                const count = dailyCounts[dateStr] || 0;
                
                // Color intensity based on streams
                let color = 'var(--bg-primary)';
                if (count > 100) color = 'var(--color-primary)';
                else if (count > 50) color = 'var(--color-secondary)';
                else if (count > 20) color = 'var(--color-accent)';
                else if (count > 5) color = 'var(--color-highlight)';
                else if (count > 0) color = 'rgba(136, 169, 128, 0.3)';
                
                days.push({
                    date: new Date(d),
                    count,
                    color
                });
            }
            
            // Find max for better coloring
            const maxCount = Math.max(...Object.values(dailyCounts), 1);
            
            // Render calendar
            const container = document.getElementById('heatmapContainer');
            if (!container) return;
            
            container.innerHTML = `
                <div style="margin-bottom: 15px; color: var(--text-secondary); font-size: 0.9em;">
                    <strong>${year}</strong> â€¢ ${yearData.length.toLocaleString()} streams across ${Object.keys(dailyCounts).length} days
                </div>
                <div class="calendar-grid">
                    ${days.map(day => `
                        <div class="calendar-cell" 
                             style="background: ${day.color};"
                             title="${day.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}: ${day.count} streams">
                        </div>
                    `).join('')}
                </div>
                
                <div class="calendar-legend">
                    <span style="color: var(--text-secondary); font-size: 0.9em; margin-right: 10px;">Less</span>
                    <div class="legend-item" style="background: var(--bg-primary);"></div>
                    <div class="legend-item" style="background: rgba(136, 169, 128, 0.3);"></div>
                    <div class="legend-item" style="background: var(--color-highlight);"></div>
                    <div class="legend-item" style="background: var(--color-accent);"></div>
                    <div class="legend-item" style="background: var(--color-secondary);"></div>
                    <div class="legend-item" style="background: var(--color-primary);"></div>
                    <span style="color: var(--text-secondary); font-size: 0.9em; margin-left: 10px;">More</span>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: var(--bg-card); border-radius: 12px; color: var(--text-secondary); font-size: 0.9em;">
                    <strong>ğŸ’¡ Tip:</strong> Hover over any day to see your stream count. Darker colors = more streams that day!
                </div>
            `;
            
            console.log('âœ… Heat map generated for', year);
        }
        
    </script>

    <script>
        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('âœ… Service Worker registered successfully:', registration.scope);
                    })
                    .catch(error => {
                        console.log('âŒ Service Worker registration failed:', error);
                    });
            });
        }
        
        // Add install prompt for Android
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button
            const installBtn = document.createElement('button');
            installBtn.textContent = 'ğŸ“± Install App';
            installBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 10000;
                padding: 12px 24px;
                background: linear-gradient(135deg, #88a980, #6a8763);
                color: white;
                border: none;
                border-radius: 25px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                cursor: pointer;
            `;
            
            installBtn.addEventListener('click', async () => {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                deferredPrompt = null;
                installBtn.remove();
            });
            
            document.body.appendChild(installBtn);
        });
        
        // Handle app installed event
        window.addEventListener('appinstalled', () => {
            console.log('âœ… App installed successfully!');
        });
    </script>

</body>
</html>
